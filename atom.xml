<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>I sudo X</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://isudox.com/"/>
  <updated>2017-04-13T03:12:49.089Z</updated>
  <id>https://isudox.com/</id>
  
  <author>
    <name>sudoz</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Thrift 学习笔记：RPC Server 和 Client</title>
    <link href="https://isudox.com/2017/04/10/thrift-notes-server-client/"/>
    <id>https://isudox.com/2017/04/10/thrift-notes-server-client/</id>
    <published>2017-04-10T03:46:23.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>在了解 Thrift IDL 后，就能开始编写自己的 RPC 服务端和客户端了。对 Thrift 的安装过程和命令操作略过不表，主要还是关注如何利用 Thrift 实现 Java 的 RPC 服务端和客户端。</p>
<a id="more"></a>
<h2 id="服务接口描述"><a href="#服务接口描述" class="headerlink" title="服务接口描述"></a>服务接口描述</h2><p>首先需要定义服务接口描述，即 <code>.thrift</code> 文件，再由 Thrift 将接口描述文件编译成相应的客户端和服务端的 stub 代码。</p>
<p>官网 Tutorial 给出的示例略复杂，不妨自己写一个简单的 Hello World 文件：</p>
<figure class="highlight thrift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// tutorial.thrift</div><div class="line">namespace java com.isudox.thrift.tutorial</div><div class="line"></div><div class="line">typedef i32 int</div><div class="line"></div><div class="line">service CustomService &#123;</div><div class="line">    int add(1:int a, 2:int b)</div><div class="line">    string sayHello(1:string name)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>描述文件写的很简单，只定义了一个接口，包含两个函数。将 <code>tutorial.thrift</code> 编译成 Java 代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thrift -r --gen java tutorial.thrift</div></pre></td></tr></table></figure>
<p>生成如下 Java 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">gen-java</div><div class="line">└── com</div><div class="line">    └── isudox</div><div class="line">        └── thrift</div><div class="line">            └── tutorial</div><div class="line">                └── CustomService.java</div></pre></td></tr></table></figure>
<p>下面是 <code>CustomService.java</code> 的部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isudox.thrift.tutorial;</div><div class="line"></div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"cast"</span>, <span class="string">"rawtypes"</span>, <span class="string">"serial"</span>, <span class="string">"unchecked"</span>, <span class="string">"unused"</span>&#125;)</div><div class="line"><span class="meta">@javax</span>.annotation.Generated(value = <span class="string">"Autogenerated by Thrift Compiler (0.10.0)"</span>, date = <span class="string">"2017-04-10"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomService</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iface</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">sayHello</span><span class="params">(java.lang.String name)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span>;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 后面省略...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，Thrift 自动生成了接口 <code>CustomService.Iface</code>，包含 add() 和 sayHello() 函数。</p>
<p>另外，如果是 Maven 构建的项目，在模块的 <code>pom.xml</code> 文件中添加 Thrift 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.thrift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>libthrift<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>有了上面的编译后的 stub 代码，就能对 RPC 服务端和客户端具体实现进行编码了。</p>
<h2 id="Server-amp-Client"><a href="#Server-amp-Client" class="headerlink" title="Server &amp; Client"></a>Server &amp; Client</h2><p>在编写 RPC Server 和 Client 代码前，得先把 Thrift 定义的接口实现。编写 <code>CustomServiceHandler.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CustomServiceImpl.java</span></div><div class="line"><span class="keyword">package</span> com.isudox.thrift.tutorial</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.thrift.*</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServiceHandler</span> <span class="keyword">implements</span> <span class="title">CustomService</span>.<span class="title">Iface</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">throws</span> TException </span>&#123;  </div><div class="line">        <span class="keyword">return</span> a + b;  </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> TException </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后就能编写 Server 和 Client 的具体实现了，通过 <code>CustomServiceHandler</code> 来实现远程调用；</p>
<p><code>CustomServer.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CustomServer.java</span></div><div class="line"><span class="keyword">package</span> com.isudox.thrift.tutorial</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.thrift.*</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomServer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CustomServiceHandler handler;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CustomService.Processor processor;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            handler = <span class="keyword">new</span> CustomServiceHandler();</div><div class="line">            processor = <span class="keyword">new</span> CustomService.Processor(handler);</div><div class="line">            </div><div class="line">            Runnable simple = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    simple(processor);</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="keyword">new</span> Thread(simple).start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">simple</span><span class="params">(CustomService.Processor&lt;CustomServiceHandler&gt; processor)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            TServerTransport st = <span class="keyword">new</span> TServerSocket(<span class="number">9090</span>);</div><div class="line">            TServer server = <span class="keyword">new</span> TSimpleServer(<span class="keyword">new</span> Args(st).processor(processor));</div><div class="line">            System.out.println(<span class="string">"Starting the simple server..."</span>);</div><div class="line">            server.serve();</div><div class="line">        &#125;</div><div class="line">         <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">             e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CustomClient.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CustomClient.java</span></div><div class="line"><span class="keyword">package</span> com.isudox.thrift.tutorial</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.thrift.*</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomClient</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            TTransport transport = <span class="keyword">new</span> TSocket(<span class="string">"localhost"</span>, <span class="number">9090</span>);</div><div class="line">            transport.open();</div><div class="line"></div><div class="line">            TProtocol protocol = <span class="keyword">new</span>  TBinaryProtocol(transport);</div><div class="line">            CustomService.Client client = <span class="keyword">new</span> CustomService.Client(protocol);</div><div class="line"></div><div class="line">            System.out.print(client.add(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">            System.out.print(client.sayHello(<span class="string">"sudoz"</span>));</div><div class="line"></div><div class="line">            transport.close();</div><div class="line">        &#125; <span class="keyword">catch</span> (TTransportException te) &#123;</div><div class="line">            te.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (TException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行 Server 端 main 函数，会以 simple 的模式启动，然后运行 Client，可以看到输出了 Thrift 定义的接口的函数运行结果。</p>
<hr>
<p>参考资料：</p>
<ul>
<li><a href="https://thrift.apache.org/tutorial/" target="_blank" rel="external">Thrift Tutorial</a></li>
<li><a href="http://thrift.apache.org/docs/" target="_blank" rel="external">Thrift Documentation</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-apachethrift/" target="_blank" rel="external">Apache Thrift - 可伸缩的跨语言服务开发框架</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在了解 Thrift IDL 后，就能开始编写自己的 RPC 服务端和客户端了。对 Thrift 的安装过程和命令操作略过不表，主要还是关注如何利用 Thrift 实现 Java 的 RPC 服务端和客户端。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="RPC" scheme="https://isudox.com/tags/RPC/"/>
    
      <category term="Thrift" scheme="https://isudox.com/tags/Thrift/"/>
    
  </entry>
  
  <entry>
    <title>Thrift 学习笔记：IDL</title>
    <link href="https://isudox.com/2017/04/06/thrift-learn-notes-idl/"/>
    <id>https://isudox.com/2017/04/06/thrift-learn-notes-idl/</id>
    <published>2017-04-06T03:08:26.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>上月底来到了 M 记，氛围和风格都和 J 记有很大不同，很舒服。开发工作还在按照 Mentor 定制的计划学习适应中，部分技术栈之前没接触过，比如 RPC，M 记用的是自己改写的 Thrift，这两天也在看相关的文档，汇总成学习笔记。</p>
<a id="more"></a>
<p>Thrift 是由 Facebook 开源、Apache 维护的跨语言 RPC 框架。类似 Google 的 protobuf，Thrift 是典型的 C/S 架构，RPC 客户端和服务端间需要定义 IDL(Interface Description Language) 来实现跨语言通信。本文是对 Thrift IDL 学习的总结。</p>
<h2 id="基础类型"><a href="#基础类型" class="headerlink" title="基础类型"></a>基础类型</h2><p>参考官方<a href="http://thrift.apache.org/docs/types" target="_blank" rel="external">文档</a>，Thrift IDL 的基础类型覆盖了绝大多数编程语言的关键类型，共有以下 7 种：</p>
<ul>
<li>bool：布尔值，true 或 false</li>
<li>byte：8-bit 有符号整数</li>
<li>i16：16-bit 有符号整数</li>
<li>i32：32-bit 有符号整数</li>
<li>i64：64-bit 有符号整数</li>
<li>double：64-bit 浮点数</li>
<li>string：UTF-8 编码的字符串</li>
</ul>
<p>文档中说明了，IDL 并没有包含无符号整型，这是由于很多编程语言并没有原生的无符号整型数。</p>
<h2 id="特殊类型"><a href="#特殊类型" class="headerlink" title="特殊类型"></a>特殊类型</h2><p>Thrift IDL 支持 binary 类型，它是未编码字节序列，是 string 类型的特殊形式。binary 类型提高了和 Java 的互操作性，Thrift 计划在某个时候将其提升为基础类型。</p>
<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><p>Thrift 结构体定义了公共对象，基本等同于面向对象语言中的类，但没有继承特性。一个结构体有一组强类型的字段，每个字段都有唯一名称标识符。Thrift 接口文件中的结构体类型，编译后会转换成一个类，类的属性就是结构体中的各个类型字段，而类的方法就是对这些类型字段进行处理的相关函数。结构体类型的关键字是 <code>struct</code>，参考下面的 IDL 代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">struct Student &#123;</div><div class="line">    1: i32 id;</div><div class="line">    2: string name;</div><div class="line">    3: i32 age;</div><div class="line">    4: string sex;</div><div class="line">    5: i32 grade;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对应的，Thrift 编译后生成下面的 Student 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</div><div class="line">    <span class="keyword">private</span> String sex;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> grade;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h2><p>Thrift 容器是强类型的，可以映射成大多数编程语言的容器。Thrift 包含 3 种容器——</p>
<ul>
<li>list：元素可重复的有序列表，对应 C++ STL 的 vector、Java 的 ArrayList、脚本语言中的原生数组；</li>
<li>set：元素不可重复的无序列表，对应 STL 的 set、Java 的 HashSet、Python 的 set；</li>
<li>map：key 严格唯一的 key-value 字典，对应 STL 的 map、Java 的 HashMap、Python/Ruby 的 字典；</li>
</ul>
<p>容器元素可能是任意 Thrift 类型。</p>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><p>Thrift 异常和结构体形式上类似，只是关键字是 exception，由指定语言的原生异常类派生，Java 的话，就是 <code>java.lang.Exception</code>。参考下面的 IDL 声明代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">exception RequestException &#123;</div><div class="line">    1: i32 code;</div><div class="line">    2: string message;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h2><p>Thrift 中的服务定义类似 OOP 语言中的接口（或纯虚函数）。Thrift 编译后，会创建客户端和服务端相应的函数和方法。服务中定义的每个方法都是具有返回类型的。另外，对于 void 方法，可以额外的加上 oneway 关键字，使得方法在执行时不会等待返回结果，直接异步处理。</p>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>Thrift 的枚举和 C/C++ 类似，由 <code>enum</code> 关键字声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">enum UserType &#123;</div><div class="line">    VALID,</div><div class="line">    INVALID,</div><div class="line">    FROZEN</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当 IDL 未对枚举赋值时，枚举型的第一个元素默认赋值为 0，并逐个递增。</p>
<h2 id="类型定义"><a href="#类型定义" class="headerlink" title="类型定义"></a>类型定义</h2><p>Thrift 通过关键字 <code>typedef</code> 对类型名进行自定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">typedef i32 MyInt</div><div class="line">typedef string Str</div></pre></td></tr></table></figure>
<h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>Thrift 支持 <code>include</code> 关键字引入其他 thrift 文件，从而引入外部 thrift 文件中声明的类型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">include &quot;test.thrift&quot;</div><div class="line"></div><div class="line">service MyService extends test.FacebookService&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Thrift IDL 和 Java 的类型对应关系如下表所示：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Thrift</th>
<th style="text-align:left">Java</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bool</td>
<td style="text-align:left">布尔值</td>
</tr>
<tr>
<td style="text-align:left">byte</td>
<td style="text-align:left">8 位有符号整型</td>
</tr>
<tr>
<td style="text-align:left">i16</td>
<td style="text-align:left">16 位有符号整型</td>
</tr>
<tr>
<td style="text-align:left">i32</td>
<td style="text-align:left">32 位有符号整型</td>
</tr>
<tr>
<td style="text-align:left">i64</td>
<td style="text-align:left">64 位有符号整型</td>
</tr>
<tr>
<td style="text-align:left">double</td>
<td style="text-align:left">64 位浮点数</td>
</tr>
<tr>
<td style="text-align:left">string</td>
<td style="text-align:left">UTF-8 编码的字符串</td>
</tr>
<tr>
<td style="text-align:left">struct</td>
<td style="text-align:left">公共的对象</td>
</tr>
<tr>
<td style="text-align:left">list</td>
<td style="text-align:left">元素可重复的有序列表，ArrayList</td>
</tr>
<tr>
<td style="text-align:left">set</td>
<td style="text-align:left">元素不可重复的无序列表，HashSet</td>
</tr>
<tr>
<td style="text-align:left">map</td>
<td style="text-align:left">key 唯一的字典，HashMap</td>
</tr>
<tr>
<td style="text-align:left">exception</td>
<td style="text-align:left">Exception</td>
</tr>
<tr>
<td style="text-align:left">service</td>
<td style="text-align:left">服务的接口</td>
</tr>
</tbody>
</table>
<hr>
<p>参考资料：</p>
<ul>
<li><a href="http://thrift.apache.org/docs/" target="_blank" rel="external">Thrift Documentation</a></li>
<li><a href="http://thrift.apache.org/tutorial/java" target="_blank" rel="external">Thrfit Tutorial</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;上月底来到了 M 记，氛围和风格都和 J 记有很大不同，很舒服。开发工作还在按照 Mentor 定制的计划学习适应中，部分技术栈之前没接触过，比如 RPC，M 记用的是自己改写的 Thrift，这两天也在看相关的文档，汇总成学习笔记。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="RPC" scheme="https://isudox.com/tags/RPC/"/>
    
      <category term="Thrift" scheme="https://isudox.com/tags/Thrift/"/>
    
  </entry>
  
  <entry>
    <title>[译] 一个行之有效的 Git 分支模型</title>
    <link href="https://isudox.com/2017/02/18/a-successful-git-branching-model-zh/"/>
    <id>https://isudox.com/2017/02/18/a-successful-git-branching-model-zh/</id>
    <published>2017-02-18T06:51:10.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>原文 <a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="external">A successful Git branching model</a> 是 <a href="https://github.com/nvie/gitflow" target="_blank" rel="external">gitflow</a> 的作者 nvie 于 2010 年撰写的，最近才看到此文，恨晚。网上和微信公众号推送的 Git 最佳实践多多少少应该从这篇文章中获得过经验值。虽然文中有些表述略显唠叨和陈旧，但不缺干货，搬运过来做个日常开发手册也是好的。</p>
<a id="more"></a>
<blockquote>
<p>上面是废话，下面是译文。</p>
</blockquote>
<hr>
<p>本文里，我会介绍一个在一年前就引入进多个项目（包括工作和个人项目）中的开发模型，实践表明该模型很成功。为此专门写篇文章的想法由来已久，但始终没挤出时间来做，直到现在。我不会细究项目的具体细节，仅仅是项目开发的分支策略和发布管理。</p>
<p align="center"><img src="https://o70e8d1kb.qnssl.com/git-model@2x.png" width="575"></p>

<p>该模型专注于使用 <a href="https://git-scm.com/" target="_blank" rel="external">Git</a> 作为代码版本管理工具。（另外，如果你对 Git 感兴趣，我司的 GitPrime 提供了一些很棒的软件性能实时数据分析功能）</p>
<h2 id="为什么使用-Git"><a href="#为什么使用-Git" class="headerlink" title="为什么使用 Git"></a>为什么使用 Git</h2><p>关于 Git 相比于中心化的代码管理系统的优劣，可以从网上找到很多相关讨论。作为开发者，我选择 Git。Git 确实改变了开发者们对分支和合并的理解。在之前使用经典的 CVS/Subversion 时，新建分支和合并分支总是有点吓人（小心代码合并时的冲突，它们会咬你）。</p>
<p>但是用 Git 时，这些日常工作流的主要操作都变得简便易行。举例来说，在 CVS/Subversion 的相关书籍中，分支和合并操作会在靠后的章节中介绍（面向高阶读者），而 Git 的书中，往往是前三章的基础操作里就会做说明。</p>
<p>由于 Git 的简单性和重用性（repetitive），分支和合并不再是令人生畏的高危操作。版本管理工具应该更多的协助代码的新建分支和合并分支。</p>
<p>闲言少叙，进入开发模型的正题吧。我要介绍的模型基本上只是团队里每个成员都要遵循的一组开发流程规范。</p>
<h2 id="去中心化也中心化"><a href="#去中心化也中心化" class="headerlink" title="去中心化也中心化"></a>去中心化也中心化</h2><p>在分支模型下工作良好的代码库，实际上有一个真实的中心代码库。注意这个库被视为一个中心（因为 Git 是分布式的版本管理工具，所以从技术角度上说并不存在中心代码库）。我们将其视为为 origin，因为所有 Git 用户都熟悉这个名称。</p>
<p><img align="center" src="https://o70e8d1kb.qnssl.com/centr-decentr@2x.png" width="487"></p>
<p>每个开发者对 origin 进行 pull 和 push 操作。但是除了中心化的 push-pull，每个开发者也可能会建立子团队并 pull 同个子团队里其他成员的代码改动。比如，和两个或更多开发者合作开发一个大的新功能时，避免过早的将开发进行过程中的代码 push 上去。上图中，有 Alice 和 Bob 的小团队，Clair 和 David 的小团队。</p>
<p>本质上说，这实际上就像是 Alice 定义了一个 Git 远程分支，名叫 bob，并指向 Bob 的代码库，反之亦然。</p>
<h2 id="主干分支"><a href="#主干分支" class="headerlink" title="主干分支"></a>主干分支</h2><p><img align="right" src="https://o70e8d1kb.qnssl.com/main-branches@2x.png" width="267"><br>我的开发模型实际上从现有的模型中得到很多启发。中心库保有两个伴随代码库整个生命流程的主要分支：</p>
<ul>
<li>master</li>
<li>develop</li>
</ul>
<p>Git 用户应该对 origin 上的 <code>master</code> 分支很熟悉。此外，另一个分支命名为 <code>develop</code>。</p>
<p>我们将 <code>origin/master</code> 分支作为一个主干分支，使得它的 HEAD 指针始终指向可发布的生产状态（production-ready state）。</p>
<p><code>origin/develop</code> 分支作为另一主干分支，而它的 HEAD 指针始终指向为下一发版而做的最新开发改动。有人把这成为 integration 分支。通常这就是 nightly 版本发布的出处。</p>
<p>当 <code>develop</code> 分支上的代码开发到 stable 状态并且已经可以发布时，所有的改动都应该 merge 到 <code>master</code> 分支上，然后打上发布版本号的标签。后面会继续讲如何执行这一系列操作。</p>
<p>因此，每次把改动合并到 <code>master</code> 分支上后，就生成了一个新的可发布的生产状态。我们对合并到 <code>master</code> 分支的行为把控严格，所以理论上，每当 <code>master</code> 分支上有 commit 操作时，我们可以通过 Git hook 脚本实现自动构建并把应用推送到生产服务器上。</p>
<h2 id="辅助分支"><a href="#辅助分支" class="headerlink" title="辅助分支"></a>辅助分支</h2><p>主干分支之外，我们的开发模型使用了很多辅助分支来帮助团队成员间的并行开发，减轻功能跟踪的成本，预备新版的发布，协助快速修复已发布版本的问题。和主干分支不同，这些辅助分支只有有限的生命期，最终会被移除。</p>
<p>我们可能会用到的辅助分支有：</p>
<ul>
<li>Feature 分支</li>
<li>Release 分支</li>
<li>Hotfix 分支</li>
</ul>
<p>上面的每个辅助分支都有一个特定的目标，且严格限制哪些是起源分支，哪些是合并的目标分支。我们一会儿会详细解释。</p>
<p>这些辅助分支并不特别，分支的类型是按照我们如何使用它们而划分的，也就是普通的 Git 分支而已。</p>
<h3 id="Feature-分支"><a href="#Feature-分支" class="headerlink" title="Feature 分支"></a>Feature 分支</h3><p><img align="right" src="https://o70e8d1kb.qnssl.com/fb@2x.png" width="133"><br>从 <code>develop</code> 分支派生；<br>必须 merge 回 <code>develop</code> 分支；<br>辅助分支的命名惯例是：除 master，develop，release_* 和 hotfix-* 以外的任意命名。</p>
<p>Feature 分支，或者叫 topic 分支，是用来为未来的发版而开发新 features 的分支。当开始 feature 的开发时，。Feature 分支的本质它会在 feature 的开发期内存在，但最终会合并回 <code>develop</code> 分支（以明确的将 feature 添加进即将 release 的版本中），或者被直接丢弃掉（在令人失望的情况下）。</p>
<p>Feature 分支通常只存在于开发者的 repo 中，而不会在中心库 origin repo 中。</p>
<center><strong>创建 Feature 分支</strong></center>

<p>要创建一个新的 Feature 分支，从 <code>develop</code> 分支上派生：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git checkout -b myfeature develop</div><div class="line">Switched to a new branch <span class="string">"myfeature"</span></div></pre></td></tr></table></figure>
<center><strong>已完成的 feature 合并回 develop</strong></center>

<p>已开发完成的 features 应该被合并至 <code>develop</code> 分支上，将 features 添加到即将发 release 的代码版本中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ git checkout develop</div><div class="line">Switched to branch <span class="string">'develop'</span></div><div class="line">$ git merge --no-ff myfeature</div><div class="line">Updating ea1b82a..05e9557</div><div class="line">(Summary of changes)</div><div class="line">$ git branch <span class="_">-d</span> myfeature</div><div class="line">Deleted branch myfeature (was 05e9557).</div><div class="line">$ git push origin develop</div></pre></td></tr></table></figure>
<p><code>--no-ff</code> 标识使得 merge 操作总是创建一个新的 commit，即使 merge 可以使用 fast-forward。这避免了 feature 分支历史信息的丢失，而且把所有 commit 归并在一起。比较下图的两个案例：</p>
<p align="center"><img src="https://o70e8d1kb.qnssl.com/merge-without-ff@2x.png" width="478"></p>

<p>右边的案例中，无法从 Git 历史中找到是哪些 commit 实现了 feature，你必须要手工的去检查所有的 log 信息。撤销一个 feature 对后一案例而言简直是头疼，而如果使用了 –no-ff 标志，则很容易完成。</p>
<p>是的，它会付出创建更多的 commit 的代价，但所得更多。</p>
<h3 id="Release-分支"><a href="#Release-分支" class="headerlink" title="Release 分支"></a>Release 分支</h3><p>从 <code>develop</code> 分支派生；<br>必须 merge 回 <code>develop</code> 分支和 <code>master</code> 分支；<br>分支命名惯例：release-*</p>
<p>Release 分支为新的生产版本做预备。They allow for last-minute dotting of i’s and crossing t’s. 此外，Release 分支也可以用来修复小 bug 和准备发布版本的元数据（版本号，构建日期等）。通过 Release 分支，<code>develop</code> 分支将被清理以便接收下一个大版本的发布。</p>
<p>从 <code>develop</code> 分支派生新分支的关键时刻是在开发几乎要到达预期的 release 状态时。至少所有针对要构建版本的 feature 必须已经 merge 到 <code>develop</code> 分支上了。而针对未来的 release 的 feature 则需要等到当前的 release 分支派生以后。</p>
<p>正是在 Release 分支的开始时，而不是之前，即将到来的 release 才被分配版本号。直到那时，<code>develop</code> 分支才反映了 next release 的改动，但直到 release 分支开始前，next release 是 0.3 版还是 1.0 版并不确定。对 release 版本的决定是在 release 分支开始时，并由项目的版本号规则来拟定。</p>
<center><strong>创建 release 分支</strong></center>

<p>Release 分支是由 <code>develop</code> 分支派生而来。例如，当前的生产版本是 1.15，且即将有一个大迭代。<code>develop</code> 分支的状态已经为 next release 做好准备，我们也已经决定好即将到来的版本是 1.2。因此我们从当前的 <code>develop</code> 分支上派生并命名该 <code>release</code> 分支为新的版本号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ git checkout -b release-1.2 develop</div><div class="line">Switched to a new branch <span class="string">"release-1.2"</span></div><div class="line">$ ./bump-version.sh 1.2</div><div class="line">Files modified successfully, version bumped to 1.2.</div><div class="line">$ git commit <span class="_">-a</span> -m <span class="string">"Bumped version number to 1.2"</span></div><div class="line">[release-1.2 74d9424] Bumped version number to 1.2</div><div class="line">1 files changed, 1 insertions(+), 1 deletions(-)</div></pre></td></tr></table></figure>
<p>创建并切换到新分支后，我们 bump 了版本号。在这里，<code>bump-version.sh</code> 是一个虚拟出来的 shell 脚本，用来修改一些文件，使其能体现新版本。之后，新的版本被 commit 上去。</p>
<p>该新分支可能会存在一段时间，知道 release 可以确定被发布出来。在此期间，分支上可能会修复一些 bug（而不是在 <code>develop</code> 分支上）。严禁在该分支上添加大的 feature 进来。release 分支最后必须被 merge 回 <code>develop</code> 分支上，然后继续等待下一个大版本的发布。</p>
<center><strong>完成 release 分支</strong></center>

<p>当 release 分支的开发状态到了真正可以发布的时候，就需要采取一些行动了。首先， release 分支得 merge 到 <code>master</code> 分支（记住，<code>master</code> 上的每个 commit 都是一个新的 release）。然后，提交到 <code>master</code> 上的 commit 必须被标记上 Tag，以便将来参考该历史版本。最后，release 分支上的改动还需要 merge 回 <code>develop</code> 分支，以便将来的 release 也能包含这些 bug fixes。</p>
<p>开始的两步操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ git checkout master</div><div class="line">Switched to branch <span class="string">'master'</span></div><div class="line">$ git merge --no-ff release-1.2</div><div class="line">Merge made by recursive.</div><div class="line">(Summary of changes)</div><div class="line">$ git tag <span class="_">-a</span> 1.2</div></pre></td></tr></table></figure>
<p>到此，release 已经完成，并且标记了 Tag。（你可能还想使用 <code>-s</code> 或 <code>-u</code> 参数来对 Tag 进行加密）</p>
<p>为了让 release 分支上的改动能保留下来，继续将改动 merge 回 <code>develop</code> 分支，Git 操作如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ git checkout develop</div><div class="line">Switched to branch <span class="string">'develop'</span></div><div class="line">$ git merge --no-ff release-1.2</div><div class="line">Merge made by recursive.</div><div class="line">(Summary of changes)</div></pre></td></tr></table></figure>
<p>这些操作可能会导致代码冲突，尝试解决冲突后再提交。<br>现在，我们已经彻底完成工作并且 release 分支已经可以被移除了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git branch <span class="_">-d</span> release-1.2</div><div class="line">Deleted branch release-1.2 (was ff452fe).</div></pre></td></tr></table></figure>
<h3 id="Hotfix-分支"><a href="#Hotfix-分支" class="headerlink" title="Hotfix 分支"></a>Hotfix 分支</h3><p><img align="right" src="https://o70e8d1kb.qnssl.com/hotfix-branches@2x.png" width="316"><br>从 <code>master</code> 分支派生；<br>必须 merge 回 <code>develop</code> 分支和 <code>master</code> 分支；<br>分支命名惯例：hotfix-*</p>
<p>Hotfix 分支和 release 分支很类似，都是为发布新的生产版本而准备，虽然是计划外的。其存在的必要性是由于当前生产版本处于需要紧急修复的状态。当生产版本发生严重 bug 时，就必须立即修复，hotfix 分支可以从生产版本的 <code>master</code> 分支上的相应 Tag 派生出来。</p>
<p>实质上，在 <code>develop</code> 分支上开发的人员可以继续，另一边，其他人员则可以快速的进行生产版本的修复工作。</p>
<center><strong>创建 release 分支</strong></center>

<p>Hotfix 分支从 <code>master</code> 派生。比如，当前线上运行的生产版本是 1.2 版，遇到严重 bug，但是 <code>develop</code> 分支上的版本还不到稳定版，就可以派生 hotfix 分支来修复线上发现的 bug：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ git checkout -b hotfix-1.2.1 master</div><div class="line">Switched to a new branch <span class="string">"hotfix-1.2.1"</span></div><div class="line">$ ./bump-version.sh 1.2.1</div><div class="line">Files modified successfully, version bumped to 1.2.1.</div><div class="line">$ git commit <span class="_">-a</span> -m <span class="string">"Bumped version number to 1.2.1"</span></div><div class="line">[hotfix-1.2.1 41e61bb] Bumped version number to 1.2.1</div><div class="line">1 files changed, 1 insertions(+), 1 deletions(-)</div></pre></td></tr></table></figure>
<p>别忘了在派生新分支后 bump 了版本号。<br>然后，修复 bug 并提交上去：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git commit -m <span class="string">"Fixed severe production problem"</span></div><div class="line">[hotfix-1.2.1 abbe5d6] Fixed severe production problem</div><div class="line">5 files changed, 32 insertions(+), 17 deletions(-)</div></pre></td></tr></table></figure>
<center><strong>完成 release 分支</strong></center>

<p>当 bug 修复完成，修复代码需要合并到 <code>master</code> 分支上，同时还得 merge 到 <code>develop</code> 分支，以保证下一个 release 版本不会出现此 bug。这和 release 分支的结束过程是非常类似的。</p>
<p>首先，<code>master</code> 分支合并修复代码，然后为新的 release 标记 Tag：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ git checkout master</div><div class="line">Switched to branch <span class="string">'master'</span></div><div class="line">$ git merge --no-ff hotfix-1.2.1</div><div class="line">Merge made by recursive.</div><div class="line">(Summary of changes)</div><div class="line">$ git tag <span class="_">-a</span> 1.2.1</div></pre></td></tr></table></figure>
<p>然后，轮到 <code>develop</code> 分支合并修复代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ git checkout develop</div><div class="line">Switched to branch <span class="string">'develop'</span></div><div class="line">$ git merge --no-ff hotfix-1.2.1</div><div class="line">Merge made by recursive.</div><div class="line">(Summary of changes)</div></pre></td></tr></table></figure>
<p>有一个例外的原则是，如果当前有一个 release 分支存在，那么 hotfix 分支上的改动需要 merge 到 release 分支，而不是 <code>develop</code> 分支。当 release 分支结束时，merge 到 release 分支上的修复代码最终还是会 merge 到 <code>develop</code> 上。</p>
<p>最后，移除已经完成历史使命的分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git branch <span class="_">-d</span> hotfix-1.2.1</div><div class="line">Deleted branch hotfix-1.2.1 (was abbe5d6).</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个分支模型虽然没什么令人耳目一新的东西，不过文章一开始给出的那张大图已经呈现了它对我们项目的裨益。它构造了一个优雅的模型，易于理解，并允许团队成员对分支的派生和发布有共同的认识。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;原文 &lt;a href=&quot;http://nvie.com/posts/a-successful-git-branching-model/&quot;&gt;A successful Git branching model&lt;/a&gt; 是 &lt;a href=&quot;https://github.com/nvie/gitflow&quot;&gt;gitflow&lt;/a&gt; 的作者 nvie 于 2010 年撰写的，最近才看到此文，恨晚。网上和微信公众号推送的 Git 最佳实践多多少少应该从这篇文章中获得过经验值。虽然文中有些表述略显唠叨和陈旧，但不缺干货，搬运过来做个日常开发手册也是好的。&lt;/p&gt;
    
    </summary>
    
      <category term="Translation" scheme="https://isudox.com/categories/Translation/"/>
    
    
      <category term="Git" scheme="https://isudox.com/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>探索 Spring MVC 重定向和转发</title>
    <link href="https://isudox.com/2017/02/16/spring-mvc-redirect-forward/"/>
    <id>https://isudox.com/2017/02/16/spring-mvc-redirect-forward/</id>
    <published>2017-02-16T03:35:09.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>最近参与的一个微信公众号相关项目的开发中，业务包含大量的页面跳转逻辑，以及拦截器的数据获取校验。其间也遇到一些困惑，在探究 Spring MVC 中 redirect 和 forward 的源码后，把经验归纳整理出来，遂成此文。</p>
<a id="more"></a>
<p>比如客户端的请求进到 Controller 方法中，我们会判断当前用户状态，可能会跳转到用户中心页，也可能会跳转到等待页，又或者错误页。类似的场景很多，都需要用到请求的重定向和转发。Sping MVC 实现重定向或转发的方法有很多，我先大致梳理下，然后再通过源码加深理解。</p>
<h2 id="常用处理方式"><a href="#常用处理方式" class="headerlink" title="常用处理方式"></a>常用处理方式</h2><p>Controller 视图方法间的跳转，无非就是带参跳转和不带参跳转。常用的方法有通过 String 映射 RequestMapping 实现重定向，或者通过 <code>ModelAndView</code> 对象，又或者是 <code>RedirectView</code> 对象，下面逐一说明。</p>
<h3 id="String-重定向"><a href="#String-重定向" class="headerlink" title="String 重定向"></a>String 重定向</h3><p>是 return 映射到另一个 Controller 方法的字符串。如果有请求参数，就拼接在 RequestMapping 映射的字符串后面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回字符串映射的方式</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"hello"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span>&#123;</div><div class="line">    doSomething();</div><div class="line">    <span class="keyword">return</span> <span class="string">"redirect:/bye"</span>;</div><div class="line">    <span class="comment">// return "redirect:/bye?username=sudoz";</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ModelAndView-重定向"><a href="#ModelAndView-重定向" class="headerlink" title="ModelAndView 重定向"></a>ModelAndView 重定向</h3><p>另一种方法是通过返回 <code>ModelAndView</code> 对象来实现跳转。类似的，如果有请求参数，也可以通过类似 GET 参数拼接的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回 ModelAndView 对象</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"hello"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">hello</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span>&#123;</div><div class="line">    doSomething();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="string">"redirect:/bye"</span>);</div><div class="line">    <span class="comment">// return new ModelAndView("redirect:/bye?username=sudoz");</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RedirectView-重定向"><a href="#RedirectView-重定向" class="headerlink" title="RedirectView 重定向"></a>RedirectView 重定向</h3><p>还有一种方法是通过返回 <code>RedirectView</code> 对象实现跳转，该方法和上面的不同之处在于，<code>RedirectView</code> 对象不需要设置 redirect 前缀：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回 RedirectView 对象</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"hello"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> RedirectView <span class="title">hello</span><span class="params">()</span> </span>&#123;</div><div class="line">    doSomething();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RedirectView(<span class="string">"/bye"</span>);</div><div class="line">    <span class="comment">// return new RedirectView("bye?username=sudoz");</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="带参跳转"><a href="#带参跳转" class="headerlink" title="带参跳转"></a>带参跳转</h2><p>在做方法跳转时，如果要把参数带给下一个方法，像上面代码里通过拼接 URL 参数的方法有时候并不实用。因为参数不一定都是是字符串，而且浏览器对 URL 的长度是有限制的。<code>RedirectAttributes</code> 对象可以用来保存请求重定向时的参数。利用 <code>RedirectAttributes</code> 改写上面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> RedirectView <span class="title">hello</span><span class="params">(RedirectAttributes attrs)</span> </span>&#123;</div><div class="line">    attrs.addAttribute(<span class="string">"message"</span>, <span class="string">"hello"</span>);    </div><div class="line">    attrs.addFlashAttribute(<span class="string">"username"</span>, <span class="string">"sudoz"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RedirectView(<span class="string">"hello"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"hello"</span>)</div><div class="line">    <span class="function">Map&lt;String, String&gt; <span class="title">hello</span><span class="params">(@ModelAttribute(<span class="string">"username"</span>)</span> String username,</span></div><div class="line">                              @<span class="title">ModelAttribute</span><span class="params">(<span class="string">"message"</span>)</span> String message) &#123;</div><div class="line">    Map&lt;String, String&gt; map = Maps.newHashMap();</div><div class="line">    map.put(<span class="string">"username"</span>, username);</div><div class="line">    map.put(<span class="string">"message"</span>, message);</div><div class="line">    <span class="keyword">return</span> map;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中，调用 <code>addAttribute()</code> 和 <code>addFlashAttribute()</code> 方法往 <code>RedirectAttributes</code> 对象中插入了两个值，如果看源码，就能知道，<code>RedirectAttributes</code> 接口的实现类 <code>RedirectAttributesModelMap</code> 继承了 <code>ModelMap</code>，本质上就是 <code>HashMap</code> 的子类，因此可以用来存储 Key-Value 对。这两个方法都很常用，使用上也必然存在不同：</p>
<ul>
<li><code>addAttribute()</code> 方法会把 Key-Value 作为请求参数添加的 URL 的后面；</li>
<li><code>addFlashAttribute()</code> 方法会把 Key-Value 暂存在 session 中，在跳转到目标方法后，即完成任务，会从 session 中删掉；</li>
</ul>
<p>用 <code>curl</code> 命令来测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">curl -i http://localhost:8080/</div><div class="line"></div><div class="line">HTTP/1.1 302 </div><div class="line">Set-Cookie: JSESSIONID=D1CC5E15FA8EF9474C4CED7D4F660E66;path=/;HttpOnly</div><div class="line">Location: http://localhost:8080/hello;jsessionid=D1CC5E15FA8EF9474C4CED7D4F660E66?username=sudoz</div><div class="line">Content-Language: en-US</div><div class="line">Content-Length: 0</div><div class="line">Date: Thu, 16 Feb 2017 12:33:46 GMT</div></pre></td></tr></table></figure>
<p>可以看到，通过 <code>addAttribute()</code> 添加的键值对变成了 URL 后面的参数，<code>addFlashAttribute()</code> 方法添加的键值对则没有出现在 URL 上，而是存储在了 session 中。跳转的目标方法通过 <code>@ModelAttribute(&quot;key&quot;)</code> 注解指定接收的参数。</p>
<h2 id="redirect-和-forward-的区别"><a href="#redirect-和-forward-的区别" class="headerlink" title="redirect 和 forward 的区别"></a>redirect 和 forward 的区别</h2><p>上面列出的 3 种方法，其实都是 Spring MVC 在处理请求时的重定向，即 redirect 跳转。另一种分发请求的方式是转发，即 forward。（我不确定这么翻译是否正确，所以下面就直接用 redirect 和 forward 来表述），二者的区别从 HTTP 的规范中就明确了：</p>
<ul>
<li>redirect 的 HTTP 返回码是 302，且跳转的新 URL 会存储在 HTTP Response Headers 的 Location 字段中。客户端在接收到 Response 后，会发起另一次请求，这次请求的 URL 就是重定向的 URL；</li>
<li>forward 的转发过程只发生在服务端；Servlet 容器会直接把源请求打向目标 URL，而不会经由客户端发起请求；因此客户端接收到的响应是来自转发后的目标方法，但是浏览器呈现的 URL 却并不会改变，且 forward 不能将参数转发出去。</li>
</ul>
<h2 id="Spring-Boot-测试"><a href="#Spring-Boot-测试" class="headerlink" title="Spring Boot 测试"></a>Spring Boot 测试</h2><p>为了更清晰的比较各种方法，我把 Spring Boot 的测试代码贴出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line">    <span class="meta">@Value</span>(<span class="string">"sudoz"</span>)</div><div class="line">    <span class="keyword">private</span> String username;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/"</span>)</div><div class="line">    <span class="function">String <span class="title">index</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"redirect:hello?username=jim&amp;message=how are you"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"redirectView"</span>)</div><div class="line">    <span class="function">RedirectView <span class="title">redirectView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedirectView(<span class="string">"hello"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"forward"</span>)</div><div class="line">    <span class="function">ModelAndView <span class="title">forward</span><span class="params">(RedirectAttributes attrs)</span> </span>&#123;</div><div class="line">        attrs.addFlashAttribute(<span class="string">"username"</span>, username);</div><div class="line">        attrs.addAttribute(<span class="string">"message"</span>, <span class="string">"hello"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="string">"forward:hello"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"redirect"</span>)</div><div class="line">    <span class="function">ModelAndView <span class="title">redirect</span><span class="params">(RedirectAttributes attrs)</span> </span>&#123;</div><div class="line">        attrs.addFlashAttribute(<span class="string">"username"</span>, username);</div><div class="line">        attrs.addAttribute(<span class="string">"message"</span>, <span class="string">"hello"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="string">"redirect:hello"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"hello"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function">Map&lt;String, String&gt; <span class="title">hello</span><span class="params">(Model model, @ModelAttribute(<span class="string">"username"</span>)</span> String username,</span></div><div class="line">                              @<span class="title">ModelAttribute</span><span class="params">(<span class="string">"message"</span>)</span> String message) &#123;</div><div class="line">        Map&lt;String, String&gt; map = Maps.newHashMap();</div><div class="line">        map.put(<span class="string">"username"</span>, username);</div><div class="line">        map.put(<span class="string">"message"</span>, message);</div><div class="line">        <span class="keyword">return</span> map;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="分析源码"><a href="#分析源码" class="headerlink" title="分析源码"></a>分析源码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlBasedViewResolver</span> <span class="keyword">extends</span> <span class="title">AbstractCachingViewResolver</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REDIRECT_URL_PREFIX = <span class="string">"redirect:"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FORWARD_URL_PREFIX = <span class="string">"forward:"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">createView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// If this resolver is not supposed to handle the given view,</span></div><div class="line">        <span class="comment">// return null to pass on to the next resolver in the chain.</span></div><div class="line">        <span class="keyword">if</span> (!canHandle(viewName, locale)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Check for special "redirect:" prefix.</span></div><div class="line">        <span class="keyword">if</span> (viewName.startsWith(REDIRECT_URL_PREFIX)) &#123;</div><div class="line">            String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length());</div><div class="line">            RedirectView view = <span class="keyword">new</span> RedirectView(redirectUrl, isRedirectContextRelative(), isRedirectHttp10Compatible());</div><div class="line">            <span class="keyword">return</span> applyLifecycleMethods(viewName, view);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Check for special "forward:" prefix.</span></div><div class="line">        <span class="keyword">if</span> (viewName.startsWith(FORWARD_URL_PREFIX)) &#123;</div><div class="line">            String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InternalResourceView(forwardUrl);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Else fall back to superclass implementation: calling loadView.</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.createView(viewName, locale);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>参考资料</p>
<ul>
<li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html" target="_blank" rel="external">Spring MVC Documentation</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近参与的一个微信公众号相关项目的开发中，业务包含大量的页面跳转逻辑，以及拦截器的数据获取校验。其间也遇到一些困惑，在探究 Spring MVC 中 redirect 和 forward 的源码后，把经验归纳整理出来，遂成此文。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Java" scheme="https://isudox.com/tags/Java/"/>
    
      <category term="Spring" scheme="https://isudox.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>读 Flask 源码：源码结构</title>
    <link href="https://isudox.com/2017/02/14/explore-flask-source-code-structure/"/>
    <id>https://isudox.com/2017/02/14/explore-flask-source-code-structure/</id>
    <published>2017-02-14T11:47:11.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>打算对 <a href="https://github.com/pallets/flask" target="_blank" rel="external">Flask</a> 的学习做个整理，以 Flask 的 GitHub 代码库的 <code>master</code> 分支为参考。其实早期的 <code>0.3</code> 版还是单文件，整个 <code>flask.py</code> 加上注释也只有 1426 行代码，非常简洁，很适合作为 Python 源码学习的教材。</p>
<a id="more"></a>
<p>拿到源码先不着急，就像读书一样，不妨浏览下目录，以便有个全局的了解。Flask 的源码有一个非常好的优点，就是它的注释非常完备，即使不看源码，只看注释，也能有个大概的理解。</p>
<p>从 Flask 根目录下的 <code>setup.py</code> 可以看到，Flask 依赖的组件主要有 3 个：</p>
<ul>
<li><a href="http://werkzeug.pocoo.org/docs/" target="_blank" rel="external">Werkzeug</a>：一个 HTTP 和 WSGI 的工具集；</li>
<li><a href="http://jinja.pocoo.org/docs/" target="_blank" rel="external">Jinja2</a>：Python 的前端模板引擎；</li>
<li><a href="http://pythonhosted.org/itsdangerous/" target="_blank" rel="external">itsdangerous</a>：处理并传递可信数据的辅助函数集；</li>
</ul>
<p>Flask 的核心代码都在 <code>flask</code> 目录下，其目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">flask</div><div class="line">├── ext</div><div class="line">│   └── __init__.py     flask 扩展</div><div class="line">├── __init__.py         导入模块</div><div class="line">├── __main__.py         命令行运行</div><div class="line">├── _compat.py          Py2/3 兼容性模块</div><div class="line">├── app.py              核心模块</div><div class="line">├── blueprints.py       蓝图模块</div><div class="line">├── cli.py              命令行支持模块</div><div class="line">├── config.py           flask 配置模块</div><div class="line">├── ctx.py              flask context 模块</div><div class="line">├── debughelpers.py     debug 辅助函数</div><div class="line">├── exthook.py          flask 扩展迁移，flaskext.foo 迁移到 flask_foo</div><div class="line">├── globals.py          flask 全局变量模块，包括 `g`，`current_app`，`request`</div><div class="line">├── helpers.py          辅助函数模块</div><div class="line">├── json.py             JSON 支持模块</div><div class="line">├── logging.py          日志模块</div><div class="line">├── sessions.py         基于 itsdangerous 的 cookie 和 session 模块</div><div class="line">├── signals.py          基于 blinker 的信号模块</div><div class="line">├── templating.py       桥接 Jinja2 的模板模块</div><div class="line">├── testing.py          测试模块</div><div class="line">├── views.py            view_func 模块</div><div class="line">└── wrappers.py         WSGI request 和 response 的封装模块</div></pre></td></tr></table></figure>
<hr>
<p>参考资料：</p>
<ul>
<li><a href="http://flask.pocoo.org/docs/0.12/" target="_blank" rel="external">Flask Documentation</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;打算对 &lt;a href=&quot;https://github.com/pallets/flask&quot;&gt;Flask&lt;/a&gt; 的学习做个整理，以 Flask 的 GitHub 代码库的 &lt;code&gt;master&lt;/code&gt; 分支为参考。其实早期的 &lt;code&gt;0.3&lt;/code&gt; 版还是单文件，整个 &lt;code&gt;flask.py&lt;/code&gt; 加上注释也只有 1426 行代码，非常简洁，很适合作为 Python 源码学习的教材。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Python" scheme="https://isudox.com/tags/Python/"/>
    
      <category term="Flask" scheme="https://isudox.com/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot 学习笔记 1：起手式 Hello World</title>
    <link href="https://isudox.com/2017/02/10/spring-boot-note-1/"/>
    <id>https://isudox.com/2017/02/10/spring-boot-note-1/</id>
    <published>2017-02-10T15:59:24.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://projects.spring.io/spring-boot/" target="_blank" rel="external">Spring Boot</a> 是 Pivotal 团队开发的开源 Java Web 框架，相比同门师兄 Spring，Spring Boot 把开发者从繁重的配置中解放出来，遵循“约定大于配置”(convention over configuration)的设计范式。从零搭建 Spring Boot 项目几乎是傻瓜化的，因为框架把大量配置自动完成了。</p>
<a id="more"></a>
<h2 id="Spring-Initializr-创建空项目"><a href="#Spring-Initializr-创建空项目" class="headerlink" title="Spring Initializr 创建空项目"></a>Spring Initializr 创建空项目</h2><p><a href="http://start.spring.io/" target="_blank" rel="external">Spring Initializr</a> 是 Spring 官方提供的 Spring Boot 项目初始化工具，为开发者实现一个基本的项目骨架。很多 Java IDE 也集成了这个工具，以 Intellij IDEA 为例，新建项目，选择 Spring Initializr，进入如下组件选择面板</p>
<p><img src="https://o70e8d1kb.qnssl.com/spring-initializr.png" alt="spring boot dependencies"></p>
<p>其中 Core 包含了像 AOP Cashe 这些核心组件，Web 包含了 SpringMVC Thymeleaf 等 Web 开发组件，还有数据库相关，配置中心相关等一系列组件……因为是 Hello World 程序演示，就不选组件了，直接点下一步，创建空项目。空项目结构如下图。</p>
<p><img src="https://o70e8d1kb.qnssl.com/spring-boot-structure.png" alt="spring boot project structure"></p>
<ul>
<li><code>DemonApplication.java</code>：是应用程序的启动引导类（bootstrap class），也是主要的 Spring 配置类；</li>
<li><code>DemoApplicationTest.java</code>：集成 JUnit 的测试类；</li>
<li><code>application.properties</code>：配置应用程序和 Spring Boot 的属性；</li>
</ul>
<p>OK，到此为止，第一个 Spring Boot 项目就创建完成了！是的，几乎什么都不需要做，一个能编译能运行的 Spring 项目已经搭建好了，真是幸福到泪奔啊<del>o(&gt;_&lt;)o</del><br>但是空项目什么效果都看不到，所以接下来就往里面填充内容，实现一个简单的 Web 应用。</p>
<h2 id="集成基础-Web-组件"><a href="#集成基础-Web-组件" class="headerlink" title="集成基础 Web 组件"></a>集成基础 Web 组件</h2><p>上面的项目采用 gradle 作为项目构建工具，所以依赖组件是配置在 <code>build.gradle</code> 文件中。gradle 和 maven 用法相似，选用 gradle 的好处很多，简洁是很重要的一点，参考下面的示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>向 <code>build.gradle</code> 中添加 SpringMVC </p>
<hr>
<p>参考资料：</p>
<ul>
<li>《Spring Boot 实战》 Craig Walls</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://projects.spring.io/spring-boot/&quot;&gt;Spring Boot&lt;/a&gt; 是 Pivotal 团队开发的开源 Java Web 框架，相比同门师兄 Spring，Spring Boot 把开发者从繁重的配置中解放出来，遵循“约定大于配置”(convention over configuration)的设计范式。从零搭建 Spring Boot 项目几乎是傻瓜化的，因为框架把大量配置自动完成了。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Java" scheme="https://isudox.com/tags/Java/"/>
    
      <category term="Spring" scheme="https://isudox.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>通过反射统一 RPC 调用入口</title>
    <link href="https://isudox.com/2017/02/06/rpc-uni-entry-with-reflection/"/>
    <id>https://isudox.com/2017/02/06/rpc-uni-entry-with-reflection/</id>
    <published>2017-02-06T07:18:55.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>最近项目开发中，有这样一个场景，依赖外部很多服务，每个服务从功能上彼此独立，因此各个外部服务的调用也是相对独立的。因此当时为每个调用都写了一个专属的 Porcessor 去处理服务调用的结果。当然好处就是功能区分清晰，不好的地方就是当 Processor 多了后维护起来不太方便。一种思路就是利用反射思想，为 Processor 中的 RPC 调用添加统一入口，通过服务名和方法名对调用进行定位。</p>
<a id="more"></a>
<p>代理的思路很简单，但真的非常实用，在实际开发中，合理使用代理，能精简很多固有代码。从代理的统一入口进入，根据传入的远程服务名和方法名，自动定位到需要被远程调用的方法，再传入入参并调用该方法，就能代理过多的 Processor 调用 RPC。</p>
<p>代理入口的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span>(value = <span class="string">"rpcEntry"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcEntry</span> </span>&#123;</div><div class="line">    <span class="meta">@Resource</span></div><div class="line">  <span class="keyword">private</span> Map&lt;String, Object&gt; serviceMap;  <span class="comment">// 远程服务的 k-v 映射</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Method&gt; actions = <span class="keyword">new</span> HashMap&lt;&gt;();  <span class="comment">// 存储方法调用</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">process</span><span class="params">(String invokeStr, Object[] args)</span> </span>&#123;</div><div class="line">        String serviceName = methodKey.split(<span class="string">"\\."</span>)[<span class="number">0</span>];</div><div class="line">        <span class="keyword">if</span> (!actions.containsKey(invokeStr)) &#123;</div><div class="line">            Object service = serviceMap.get(serviceName);</div><div class="line">            <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (Method m : service.getClass().getMethods()) &#123;</div><div class="line">                    actions.put(String.format(<span class="string">"%s.%s"</span>, serviceName, m.getName()), m);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        Method method = actions.get(invokeStr);  <span class="comment">// 定位要调用的方法</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</div><div class="line">            Object service = serviceMap.get(serviceName);</div><div class="line">            Object res = method.invoke(service, args);</div><div class="line"></div><div class="line">            <span class="comment">// 对调用结果进行自定义处理</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            log.error(String.format(<span class="string">"调用的方法[%s]不存在，请确认。"</span>, methodKey));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中的远程服务映射可以在 Spring 中配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceMap"</span> <span class="attr">class</span>=<span class="string">"java.util.HashMap"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"example1"</span> <span class="attr">value-ref</span>=<span class="string">"example1ServiceImpl"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"example2"</span> <span class="attr">value-ref</span>=<span class="string">"example2ServiceImpl"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"example3"</span> <span class="attr">value-ref</span>=<span class="string">"example3ServiceImpl"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>有了统一的调用入口后，如果想调用 example1ServiceImpl.debug() 方法，不需要在专门的 Processor 中进行调用，只需用下面的代码进行调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> RpcEntry rpcEntry;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">    rpcEntry.process(<span class="string">"example1.debug"</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近项目开发中，有这样一个场景，依赖外部很多服务，每个服务从功能上彼此独立，因此各个外部服务的调用也是相对独立的。因此当时为每个调用都写了一个专属的 Porcessor 去处理服务调用的结果。当然好处就是功能区分清晰，不好的地方就是当 Processor 多了后维护起来不太方便。一种思路就是利用反射思想，为 Processor 中的 RPC 调用添加统一入口，通过服务名和方法名对调用进行定位。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Java" scheme="https://isudox.com/tags/Java/"/>
    
      <category term="RPC" scheme="https://isudox.com/tags/RPC/"/>
    
  </entry>
  
  <entry>
    <title>Travis CI 持续部署静态站方案</title>
    <link href="https://isudox.com/2017/01/24/deploy-site-with-travis-ci/"/>
    <id>https://isudox.com/2017/01/24/deploy-site-with-travis-ci/</id>
    <published>2017-01-24T14:07:42.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>这两天在想 GitHub Page 部署的最佳实践。本站之前的部署方案，是通过在 VPS 上创建 Git 仓库后，再把生成的静态文件同时 Push 到 GitHub Page 和 VPS 的 Git 仓库。其中，VPS 上的 Git 仓库会设置 hook，使得有新的 Commit 被 Push 上来后，自动把 Nginx 下的站点目录进行 Pull 更新。这种方案只是一开始的设置比较麻烦，之后就能一劳永逸，但我觉得还可以再抢救下。</p>
<a id="more"></a>
<h2 id="初步方案"><a href="#初步方案" class="headerlink" title="初步方案"></a>初步方案</h2><p>既然核心目标都是一键部署，为什么不利用持续集成，那就用 <a href="https://travis-ci.org/" target="_blank" rel="external">Travis CI</a> 吧，和 GitHub 无缝结合。</p>
<p>先来梳理下整个部署思路：</p>
<ol>
<li>源码文件 Push 到 GitHub Page <code>source</code> 分支;</li>
<li>Travis-CI 在 GitHub Page <code>source</code> 分支更新后，自动构建生成站点文件；</li>
<li>Travis-CI 将站点文件推送到 GtiHub Page <code>master</code> 分支，使得 username.github.io 更新；</li>
<li>VPS 从 GitHub Page <code>master</code> 分支拉取更新；</li>
</ol>
<p>也就是说，整个部署过程只需要将写好源码文件 Push 到 GitHub 相应分支，后面的操作全部交给 Travis-CI 处理。</p>
<h2 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h2><h3 id="Travis-关联-GitHub"><a href="#Travis-关联-GitHub" class="headerlink" title="Travis 关联 GitHub"></a>Travis 关联 GitHub</h3><p>首先要让 Travis 监听 GitHub 的更新，打开 Travis，选择要监听的 GitHub 仓库，选中后记得勾选 “Build only if .travis.yml is present” 和 “Build pushes” 两个选项。</p>
<p>Travis 要有更改 GitHub 仓库的权限，因此还要到 GitHub 那为 Travis 设置权限 key。打开上面所关联的 GitHub 仓库的 Settings，在 Deploy keys 选项中，为 Travis 添加 SSH key。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 生成 ssh key 私钥公钥对，无需 passphrase</span></div><div class="line">ssh-keygen -t rsa -C <span class="string">"your_email@example.com"</span></div></pre></td></tr></table></figure>
<p>然后讲 SSH 公钥 <code>id_rsa.pub</code> 粘贴到 Deploy key 中，如下图示——</p>
<p><img src="https://o70e8d1kb.qnssl.com/deploy-key.png" alt="deploy-key"></p>
<p>接下来就是将 SSH 私钥赋给 Travis，参考下面的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">travis encrypt-file ~/.ssh/id_rsa --add</div></pre></td></tr></table></figure>
<p>Travis 命令行工具会根据私钥自动匹配到对应的 GitHub 仓库，控制台会得到类似如下回显——</p>
<blockquote>
<p>Detected repository as isudox/isudox.github.io, is this correct? |yes|<br>encrypting /home/sudoz/.ssh/id_rsa for isudox/isudox.github.io<br>storing result as id_rsa.enc<br>storing secure env variables for decryption<br>Make sure to add id_rsa.enc to the git repository.<br>Make sure <strong>not</strong> to add /home/sudoz/.ssh/id_rsa to the git repository.<br>Commit all changes to your .travis.yml.</p>
</blockquote>
<p>对 Travis 添加私钥后，就能在 Travis 网站上看到新增的环境变量配置，如下图示——</p>
<p><img src="https://o70e8d1kb.qnssl.com/travis-env-var.png" alt="travis-environment-variables"></p>
<p>上面的操作会对私钥再次加密，并在当前路径下生成加密文件 <code>id_rsa.enc</code>，同时在当前路径下的 <code>.travis.yml</code> 配置中添加一条解密命令——</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl aes-256-cbc -K $encrypted_xxx_key -iv $encrypted_xxx_iv -in .travis/id_rsa.enc -out ~/.ssh/id_rsa -d</div></pre></td></tr></table></figure>
<p>然后对加密文件解密，存放在 <code>~/.ssh/</code> 下，并配置 <code>~/.ssh/config</code> 指定要使用的私钥文件，这些操作和普通的 SSH 操作是一致的，很易懂。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># Set the permission of the key</div><div class="line">chmod 600 ~/.ssh/id_rsa</div><div class="line"># Start SSH agent</div><div class="line">eval $(ssh-agent)</div><div class="line"># Add the private key to the system</div><div class="line">ssh-add ~/.ssh/id_rsa</div></pre></td></tr></table></figure>
<p>下面是 <code>~/.ssh/config</code> 的参考——</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Host github.com</div><div class="line">  HostName github.com</div><div class="line">  User git</div><div class="line">  StrictHostKeyChecking no</div><div class="line">  IdentityFile ~/.ssh/id_rsa</div><div class="line">  IdentitiesOnly yes</div></pre></td></tr></table></figure>
<p>Push 到 GitHub 前还得对 Git 的全局参数进行配置，例如 username 和 email 信息——</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># Set Git config</div><div class="line">git config --global user.name &apos;sudoz&apos;</div><div class="line">git config --global user.email &apos;me@isudox.com&apos;</div></pre></td></tr></table></figure>
<p>剩下的工作就都是 Hexo 的操作了，安装依赖，构建静态文件，部署静态站点——</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># Install Hexo</div><div class="line">npm install hexo-cli -g</div><div class="line">npm install</div><div class="line"></div><div class="line">hexo generate</div><div class="line">hexo deploy</div></pre></td></tr></table></figure>
<h3 id="travis-yml-配置"><a href="#travis-yml-配置" class="headerlink" title="travis.yml 配置"></a>travis.yml 配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="attr">language:</span> node_js</div><div class="line"></div><div class="line"><span class="attr">node_js:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">'6'</span></div><div class="line"></div><div class="line"><span class="attr">sudo:</span> <span class="literal">false</span></div><div class="line"></div><div class="line"><span class="attr">cache:</span></div><div class="line"><span class="attr">  apt:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  directories:</span></div><div class="line"><span class="bullet">    -</span> node_modules</div><div class="line"></div><div class="line"><span class="attr">addons:</span></div><div class="line"><span class="attr">  ssh_known_hosts:</span> github.com</div><div class="line"></div><div class="line"><span class="attr">script:</span></div><div class="line"><span class="bullet">  -</span> npm run build</div><div class="line"></div><div class="line"><span class="attr">deploy:</span></div><div class="line"><span class="attr">  provider:</span> script</div><div class="line"><span class="attr">  script:</span> .travis/deploy.sh</div><div class="line"><span class="attr">  skip_cleanup:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  on:</span></div><div class="line"><span class="attr">    branch:</span> source</div></pre></td></tr></table></figure>
<p>Travis deploy script 参考如下——</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line"># Decrypt the private key</div><div class="line">openssl aes-256-cbc -K $encrypted_xxx_key -iv $encrypted_xxx_iv -in .travis/id_rsa.enc -out ~/.ssh/id_rsa -d</div><div class="line"># Set the permission of the key</div><div class="line">chmod 600 ~/.ssh/id_rsa</div><div class="line"># Start SSH agent</div><div class="line">eval $(ssh-agent)</div><div class="line"># Add the private key to the system</div><div class="line">ssh-add ~/.ssh/id_rsa</div><div class="line"># Copy SSH config</div><div class="line">cp .travis/ssh_config ~/.ssh/config</div><div class="line"># Set Git config</div><div class="line">git config --global user.name &apos;sudoz&apos;</div><div class="line">git config --global user.email &apos;me@isudox.com&apos;</div><div class="line"># Clone the repository</div><div class="line">git clone --branch master git@github.com:isudox/isudox.github.io.git .deploy_git</div><div class="line"># Deploy to GitHub</div><div class="line">npm run deploy</div></pre></td></tr></table></figure>
<blockquote>
<p>需要注意，上面的 deploy.sh 需要有执行权限，<code>chmod +x deploy.sh</code></p>
</blockquote>
<p>踩了好几个坑，足足 Push 了 7 次才调试成功</p>
<p><img src="https://o70e8d1kb.qnssl.com/travis-build-success.png" alt=""></p>
<h3 id="VPS-定时更新静态站内容"><a href="#VPS-定时更新静态站内容" class="headerlink" title="VPS 定时更新静态站内容"></a>VPS 定时更新静态站内容</h3><p>Travis CI 完成集成工作后，VPS 就能从 GitHub 上拉取更新了。之前我的方案是在 VPS 上也搭建一个 Git Repo，本地将改动同时 commit 到 GitHub 和 VPS 上的 Repo，触发 VPS Git Repo 的 Hook 事件，将更新拉取并复制静态站全部内容到 Nginx 站点路径下。这次改版不打算沿用之前的方案了，虽然这种 Hook 触发事件很及时高效。我打算使用 Linux 自带的 Crontab 定时任务功能。</p>
<p>Crontab 的使用很简单，将可执行的脚本或命令通过 <code>crontab -e</code> 写入系统用户的定时任务中即可。我设置的是每小时执行一次 <code>git pull</code> 操作。写法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># m h  dom mon dow   command</div><div class="line">0 * * * * su -s /bin/sh root -c &apos;cd /usr/share/nginx/html/isudox.github.io &amp;&amp; /usr/bin/git pull -q origin master&apos;</div></pre></td></tr></table></figure>
<p>如果不确定命令行是否生效，可以在控制台里执行下上面的 shell 脚本。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这两天在想 GitHub Page 部署的最佳实践。本站之前的部署方案，是通过在 VPS 上创建 Git 仓库后，再把生成的静态文件同时 Push 到 GitHub Page 和 VPS 的 Git 仓库。其中，VPS 上的 Git 仓库会设置 hook，使得有新的 Commit 被 Push 上来后，自动把 Nginx 下的站点目录进行 Pull 更新。这种方案只是一开始的设置比较麻烦，之后就能一劳永逸，但我觉得还可以再抢救下。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="CI" scheme="https://isudox.com/tags/CI/"/>
    
  </entry>
  
  <entry>
    <title>Docker 容器化应用</title>
    <link href="https://isudox.com/2017/01/16/dockerize-applications/"/>
    <id>https://isudox.com/2017/01/16/dockerize-applications/</id>
    <published>2017-01-16T05:30:31.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>最近看了一篇<a href="http://www.kkblog.me/notes/%E4%BD%BF%E7%94%A8Docker%E6%9E%84%E5%BB%BA%E9%AB%98%E6%95%88Web%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" target="_blank" rel="external">博文</a>，大受启发，也想着手尝试把自己 VPS 上的应用容器化，一方面尝试下新的开发方式，另一方面也便于应用迁移。</p>
<a id="more"></a>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>Docker 通过 <code>dockerfile</code> 配置来把应用构建成镜像，<code>dockerfile</code> 是一个包含了配置和创建应用的全部命令的文本。Docker 官网上有对 <code>dockerfile</code> 的详细<a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="external">说明文档</a></p>
<p>看了文档后，对其使用有大致的了解，对不是太复杂的应用的容器化，已经能实践了，下面对 <code>dockerfile</code> 的编写和使用简单总结下。</p>
<h3 id="编写-dockerfile"><a href="#编写-dockerfile" class="headerlink" title="编写 dockerfile"></a>编写 dockerfile</h3><h4 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h4><p><code>FROM</code> 指令会设置要构建的镜像所依赖的基础镜像，比如应用是运行在 Ubuntu 系统上，那么就用 FROM 指定依赖镜像为 Ubuntu，<code>FROM</code> 必须是第一条非注释指令。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> &lt;image&gt;</div><div class="line"><span class="comment"># tag 可选</span></div><div class="line"><span class="keyword">FROM</span> &lt;image&gt;:&lt;tag&gt;</div></pre></td></tr></table></figure>
<h4 id="MAINTAINER"><a href="#MAINTAINER" class="headerlink" title="MAINTAINER"></a>MAINTAINER</h4><p>该指令设置镜像的作者信息。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">MAINTAINER</span> &lt;name&gt;</div></pre></td></tr></table></figure>
<h4 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h4><p><code>RUN</code> 会运行其指定的命令，一个 <code>RUN</code> 运行一条命令，单条命令可以通过 <code>\</code> 反斜杠换行。<code>RUN</code> 支持两种格式：</p>
<ul>
<li><code>RUN &lt;cmd&gt;</code>：shell 格式，直接运行一条完整的 shell 命令，默认使用 <code>/bin/sh -c</code> 执行该 shell 命令；</li>
<li><code>RUN [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code>： exec 格式，第一个参数是可执行文件，后面跟参数；<br>参考下面的例子：</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">RUN</span><span class="bash"> /bin/bash -c <span class="string">'source $HOME/.bashrc; echo $HOME'</span></span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"echo hello"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h4><p><code>CMD</code> 也是执行命令的指令，和 <code>RUN</code> 的区别在于，<code>RUN</code> 发生在镜像构建过程中，<code>CMD</code> 发生在容器启动时。<code>dockerfile</code> 中只能存在一条有效的 <code>CMD</code> 指令，如果编写了多条，则只有最后一条生效。</p>
<p><code>CMD</code> 最主要的作用是给容器提供默认的配置，它支持 3 种格式：</p>
<ul>
<li><code>CMD [&quot;executable&quot;,&quot;param1&quot;,&quot;param2&quot;]</code>：exex 格式，推荐；</li>
<li><code>CMD [&quot;param1&quot;,&quot;param2&quot;]</code>：提供给 ENTRYPOINT 脚本的参数；</li>
<li><code>CMD command param1 param2</code>：shell 格式；</li>
</ul>
<p>参考示例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="comment"># shell 格式</span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"This is a test."</span> | wc -</span></div><div class="line"><span class="comment"># exec 格式</span></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/usr/bin/wc"</span>,<span class="string">"--help"</span>]</span></div></pre></td></tr></table></figure>
<h4 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h4><p><code>ENTRYPOINT</code> 指令是在容器启动时执行的命令或脚本，一般是对容器进行设置。它支持两种格式：</p>
<ul>
<li><code>ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code>：exec 格式，推荐；</li>
<li><code>ENTRYPOINT command param1 param2</code>：shell 格式；</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">run</span><span class="bash"> -i -t --rm -p 80:80 nginx</span></div></pre></td></tr></table></figure>
<p>例如上面的 nginx 容器启动命令，docker run <image> -d 会将参数 <code>-d</code> 传递给 entry point，如果是在 <code>CMD</code> 中已经被设置的参数，则会被覆盖掉。启动时，如果要覆盖 <code>ENTRYPOINT</code>，可以通过 <code>--entrypoint</code> 标识设置新的 <code>ENTRYPOINT</code>。</image></p>
<p>只有最后一条 <code>ENTRYPOINT</code> 指令才会生效。</p>
<h4 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h4><p><code>EXPOSE</code> 指令设置容器运行时监听的端口号。<code>EXPOSE</code> 并不能直接使容器内端口被主机访问，如果要实现主机访问容器端口，必须通过 <code>-p</code> 标识来指定可访问的容器端口。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPOSE</span> &lt;port&gt; [&lt;port&gt;...]</div><div class="line"></div><div class="line"><span class="comment"># 映射一个端口</span></div><div class="line"><span class="keyword">EXPOSE</span> port1</div><div class="line"><span class="comment"># 相应的运行容器使用的命令</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> -p port1 image</span></div><div class="line"></div><div class="line"><span class="comment"># 映射多个端口</span></div><div class="line"><span class="keyword">EXPOSE</span> port1 port2 port3</div><div class="line"><span class="comment"># 相应的运行容器使用的命令</span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> -p port1 -p port2 -p port3 image</span></div><div class="line"></div><div class="line"><span class="comment"># 还可以指定需要映射到宿主机器上的某个端口号  </span></div><div class="line">docker <span class="keyword">run</span><span class="bash"> -p host_port1:port1 -p host_port2:port2 -p host_port3:port3 image</span></div></pre></td></tr></table></figure>
<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h4><p><code>ENV</code> 指令会设置键值对环境变量，它有两种格式：</p>
<ul>
<li><code>ENV &lt;key&gt; &lt;value&gt;</code>：一次设置单个环境变量；</li>
<li><code>ENV &lt;key&gt;=&lt;value&gt; ...</code>：一次设置多个环境变量，以空格作为不同环境变量之间的分隔；</li>
</ul>
<p>环境变量设置后，无论是在容器镜像构建时，还是在容器启动运行时，都能引用到。另外，在容器运行时，如果需要额外指定环境变量，可以通过 <code>run --env &lt;key&gt;=&lt;value&gt;</code> 设置。</p>
<h4 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h4><p><code>ADD</code> 指令把源地址的文件、文件夹复制到目的地址，支持通配符。<code>ADD</code> 有两种格式：</p>
<ul>
<li><code>ADD &lt;src&gt;... &lt;dest&gt;</code></li>
<li><code>ADD [&quot;&lt;src&gt;&quot;,... &quot;&lt;dest&gt;&quot;]</code>：当路径中存在空格时，需要采用这种格式；</li>
</ul>
<p><dest> 是绝对路径，或者基于 <code>WORKDIR</code> 的相对路径，例如：</dest></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ADD</span><span class="bash"> <span class="built_in">test</span> relativeDir/          <span class="comment"># adds "test" to `WORKDIR`/relativeDir/</span></span></div><div class="line"><span class="keyword">ADD</span><span class="bash"> <span class="built_in">test</span> /absoluteDir/         <span class="comment"># adds "test" to /absoluteDir/</span></span></div></pre></td></tr></table></figure>
<h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h4><p><code>WORKDIR</code> 设置工作目录，类似 shell 的 <code>cd</code>，使 <code>RUN</code> <code>CMD</code> <code>ENCRYPT</code> <code>COPY</code> <code>ADD</code> 指令在该工作目录下执行。在 <code>dockerfile</code> 中，<code>WORKDIR</code> 可以多次指定，如果设置的是一个相对路径，则是相对于前一个 <code>WORKDIR</code> 设置的路径，比如：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /a</span></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> b</span></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> c</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">pwd</span></span></div></pre></td></tr></table></figure>
<p>得到的结果应该是 <code>/a/b/c</code>。</p>
<h4 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h4><p><code>COPY</code> 和 <code>ADD</code> 功能上基本相同，不同之处在于，<code>ADD</code> 支持从远程拉取文件复制到 <dest>，支持自动解压 <code>tar</code> 包并删除。</dest></p>
<h4 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h4><p><code>VOLUME</code> 指令创建一个挂载点，使得容器内的该挂载点具有持久数据的功能，换句话说，就是容器和主机之间的共享目录，当关闭容器后，共享目录仍会保留。参考示例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /myvol</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"hello world"</span> &gt; /myvol/greeting</span></div><div class="line"><span class="keyword">VOLUME</span><span class="bash"> /myvol</span></div><div class="line"><span class="comment"># 多个挂载点</span></div><div class="line"><span class="comment"># VOLUME ["&lt;mountpoint1&gt;, &lt;mountpoint2&gt;"]</span></div></pre></td></tr></table></figure>
<p><code>myvol</code> 成为容器在主机里的挂载点。容器的挂载点还可以提供给其他容器使用，只需通过 <code>-volumes-from</code> 标识指定要使用的容器挂载点即可。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">run</span><span class="bash"> -t -i -rm -volumes-from container1 image2 bash</span></div></pre></td></tr></table></figure>
<p>其中，container1 为第一个容器的 ID， image2 为第二个容器运行镜像的名称。</p>
<h4 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h4><p><code>USER</code> 指令设置容器运行时和执行 <code>RUN</code> <code>CMD</code> <code>ENTRYPOINT</code> 的用户或 UID，默认为 root 用户。</p>
<h4 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a>ARG</h4><p><code>ARG</code> 指令规定了用户在通过 <code>docker build --build-arg &lt;varname&gt;=&lt;value&gt;</code> 构建镜像时允许传递的变量 varname。如果用户传递了 dockerfile 中未定义的变量，构建会报 “One or more build-args were not consumed, failing build.” 的错误信息。</p>
<p><code>ARG</code> 也可以设置默认变量值，当设置了默认值后，用户如果在构建时没有传相应变量，则使用默认值，构建正常进行。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ARG &lt;name&gt;[=&lt;default value&gt;]</div></pre></td></tr></table></figure>
<p>还有一个注意点，当 <code>ARG</code> 和 <code>ENV</code> 同时设置了一个变量时，<code>ENV</code> 的设置会覆盖 <code>ARG</code>。</p>
<h3 id="dockerfile-完整示例"><a href="#dockerfile-完整示例" class="headerlink" title="dockerfile 完整示例"></a>dockerfile 完整示例</h3><p>官网给了几个完整的 <code>dockerfile</code> 示例，例如 Firefox over VNC：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Firefox over VNC</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># VERSION               0.3</span></div><div class="line"></div><div class="line"><span class="keyword">FROM</span> ubuntu</div><div class="line"></div><div class="line"><span class="comment"># Install vnc, xvfb in order to create a 'fake' display and firefox</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y x11vnc xvfb firefox</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> mkdir ~/.vnc</span></div><div class="line"><span class="comment"># Setup a password</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> x11vnc -storepasswd 1234 ~/.vnc/passwd</span></div><div class="line"><span class="comment"># Autostart firefox (might not be the best way, but it does the trick)</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> bash -c <span class="string">'echo "firefox" &gt;&gt; /.bashrc'</span></span></div><div class="line"></div><div class="line"><span class="keyword">EXPOSE</span> <span class="number">5900</span></div><div class="line"><span class="keyword">CMD</span><span class="bash">    [<span class="string">"x11vnc"</span>, <span class="string">"-forever"</span>, <span class="string">"-usepw"</span>, <span class="string">"-create"</span>]</span></div></pre></td></tr></table></figure>
<h2 id="容器化应用实践"><a href="#容器化应用实践" class="headerlink" title="容器化应用实践"></a>容器化应用实践</h2><h3 id="shadowsocks-libev"><a href="#shadowsocks-libev" class="headerlink" title="shadowsocks-libev"></a>shadowsocks-libev</h3><p><a href="https://github.com/shadowsocks/shadowsocks-libev" target="_blank" rel="external">shadowsocks-libev</a> 的容器化相对比较简单，对上面的指令初步了解后，再参考别人已有的镜像，实践编写 dockerfile 不算麻烦。</p>
<p>我的 VPS 是 Debian 系统，<code>FROM</code> 可以设为 debian，不过还是选了非常了流行的小镜像 <a href="https://alpinelinux.org/" target="_blank" rel="external">alpine</a>。然后根据 shadowsocks-libev README 编写安装的命令。</p>
<p>shadowsocks-libev 的源码编译安装过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Debian / Ubuntu</div><div class="line">sudo apt-get install --no-install-recommends build-essential autoconf libtool libssl-dev libpcre3-dev asciidoc xmlto zlib1g-dev</div><div class="line">./autogen.sh &amp;&amp; ./configure &amp;&amp; make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p>如果采用 Alpine 作为基础镜像的话，个别命令要改动，<code>apt-get install</code> 要替换成 <code>apk add</code>。用 <code>RUN</code> 指令完成源码的编译安装。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ENV</span> DEP asciidoc autoconf build-base curl libtool linux-headers openssl-dev pcre-dev tar xmlto</div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -ex &amp;&amp; \</span></div><div class="line">    apk add --no-cache --virtual .build-deps <span class="variable">$DEP</span> &amp;&amp; \</div><div class="line">    curl <span class="_">-s</span>SL <span class="variable">$URL</span> | tar xz &amp;&amp; \</div><div class="line">    <span class="built_in">cd</span> <span class="variable">$DIR</span> &amp;&amp; \</div><div class="line">        ./configure --disable-documentation &amp;&amp; \</div><div class="line">        make install &amp;&amp; \</div><div class="line">        <span class="built_in">cd</span> .. &amp;&amp; \</div><div class="line">    apk del .build-deps &amp;&amp; \</div><div class="line">    rm -rf <span class="variable">$DIR</span></div></pre></td></tr></table></figure>
<p>参考 shadowsocks 的启动参数，编写 <code>CMD</code> 或 <code>ENTRYPOINT</code> 指令：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CMD</span><span class="bash"> ss-server <span class="_">-s</span> <span class="variable">$ADDR</span> \</span></div><div class="line">              -p <span class="variable">$PORT</span> \</div><div class="line">              -k <span class="variable">$&#123;PASSWORD:-$(hostname)&#125;</span> \</div><div class="line">              -m <span class="variable">$METHOD</span> \</div><div class="line">              -t <span class="variable">$TIMEOUT</span> \</div><div class="line">              --fast-open \</div><div class="line">              <span class="_">-d</span> <span class="variable">$DNS</span> \</div><div class="line">              -u</div></pre></td></tr></table></figure>
<p>本地构建成功后，就可以推送镜像到 Docker Hub 分享给他人，或者把 Dockerfile 上传到 GitHub，通过 Docker Hub 关联 GitHub 实现自动构建。完整的 Dockerfile 已上传到 GitHub 仓库，并结合 Docker Hub 实现自动构建镜像：</p>
<ul>
<li>GitHub <a href="https://github.com/isudox/dockerfile/tree/master/shadowsocks-libev" target="_blank" rel="external">仓库地址</a></li>
<li>Docker Hub <a href="https://hub.docker.com/r/sudoz/shadowsocks-libev/" target="_blank" rel="external">镜像地址</a></li>
</ul>
<p>Docker Hub 上有镜像后，以后再安装 shadowsocks 只需要一条命令就能完成安装和配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -e METHOD=aes-256-cfb -e PASSWORD=123456 -p 8388:8388 --restart always sudoz/shadowsocks-libev</div></pre></td></tr></table></figure>
<p>一劳永逸！</p>
<h3 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h3><p>如果每次启动 Docker 镜像都要手敲一大段命令来给容器配置参数的话，还是不够简洁优雅，docker-compose 就解决了这个问题，直接把配置写成文本，由 docker-compose 来读取配置文件 <code>docker-compose.yml</code> 并启动容器，真正做到一次编写，到处运行。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">shadowsocks:</span></div><div class="line"><span class="attr">  image:</span> sudoz/shadowsocks-libev</div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">"8388:8388"</span></div><div class="line"><span class="attr">  environment:</span></div><div class="line"><span class="bullet">    -</span> METHOD=aes<span class="bullet">-256</span>-cfb</div><div class="line"><span class="bullet">    -</span> PASSWORD=<span class="number">123456</span></div><div class="line"><span class="attr">  restart:</span> always</div></pre></td></tr></table></figure>
<p>配置很明白，对应了 <code>docker run</code> 启动容器时的参数配置，现在只需要一行简单的命令来启动容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker-compose up -d</div></pre></td></tr></table></figure>
<hr>
<p>参考资料：</p>
<ul>
<li><a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="external">Dockerfile reference</a></li>
<li><a href="http://zone.gaospot.com/2016/05/11/Docker%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA/" target="_blank" rel="external">Docker 镜像创建</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近看了一篇&lt;a href=&quot;http://www.kkblog.me/notes/%E4%BD%BF%E7%94%A8Docker%E6%9E%84%E5%BB%BA%E9%AB%98%E6%95%88Web%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83&quot;&gt;博文&lt;/a&gt;，大受启发，也想着手尝试把自己 VPS 上的应用容器化，一方面尝试下新的开发方式，另一方面也便于应用迁移。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Docker" scheme="https://isudox.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>展望 2017</title>
    <link href="https://isudox.com/2017/01/01/todo-list-2017/"/>
    <id>https://isudox.com/2017/01/01/todo-list-2017/</id>
    <published>2016-12-31T16:39:29.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>看完李安的《推手》，迎来了 2017 年的第一天。这算是新的一年里的开篇吧，就不写代码了，看社区里很多同行在做过 2016 年的总结，或是新一年的期望。对过去一年，我似乎很难整理出一条清晰的逻辑去完整的复盘和总结，总体来讲，自己并不是很满意，当然也有令我激动的地方，比如遇到了 Kiki 啊……自认为在毕业后的一年里没有取得自己想要的进步，没有达到我想达到的层次，新的一年里还得加油啊。既然不做总结了，展望还是要有的，万一做到了呢？</p>
<a id="more"></a>
<blockquote>
<p>博客的 Markdown 解析器好像不支持 <code>checkbox</code> 语法，尴尬</p>
</blockquote>
<ul>
<li>锻炼身体，体重达到 65 kg 以上，用肌肉武装自己；</li>
<li>学习英语，雅思争取拿到满意的成绩；</li>
<li>提升阅读量，重拾中学时的阅读热情。目标每个月都能啃掉一本书；</li>
<li>向 Kiki 学吉他，光看 Live 有什么劲啊；</li>
<li>养一条狗，陪它长大；</li>
<li>好好写博客，向大牛看齐，写出有深度有干货的技术博客，好好混 GitHub，写出自己满意的开源作品；</li>
<li>为爱自己的人，为自己爱的人，赚钱！赚更多钱！！赚好多钱！！！</li>
</ul>
<p>嗯，就是这样。其实上面有些是 2016 年的计划，当然这就意味着我没做到，只能延期一年，希望明年这时候会是另外一个状态。</p>
<p>最后，既然是程序员，自然要用程序员的方式辞旧迎新——</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;/<span class="name">2016</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">2017</span>&gt;</span></div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;看完李安的《推手》，迎来了 2017 年的第一天。这算是新的一年里的开篇吧，就不写代码了，看社区里很多同行在做过 2016 年的总结，或是新一年的期望。对过去一年，我似乎很难整理出一条清晰的逻辑去完整的复盘和总结，总体来讲，自己并不是很满意，当然也有令我激动的地方，比如遇到了 Kiki 啊……自认为在毕业后的一年里没有取得自己想要的进步，没有达到我想达到的层次，新的一年里还得加油啊。既然不做总结了，展望还是要有的，万一做到了呢？&lt;/p&gt;
    
    </summary>
    
      <category term="Life" scheme="https://isudox.com/categories/Life/"/>
    
    
      <category term="Todo" scheme="https://isudox.com/tags/Todo/"/>
    
  </entry>
  
  <entry>
    <title>2016 前端补习 Yarn 篇</title>
    <link href="https://isudox.com/2016/12/27/yarn-front-end-development-trends-in-2016/"/>
    <id>https://isudox.com/2016/12/27/yarn-front-end-development-trends-in-2016/</id>
    <published>2016-12-27T14:39:09.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>目前使用最广泛的 JavaScript 的包管理工具应该是 npm，可以说是非常时髦的工具。但是在前端圈子，三岁就得叫爷爷，拳怕少壮，不久前 Facebook 和 Google 等联手推出了新的包管理工具 Yarn，一阵横扫之势，GitHub 上狂收 2w+ stars，令人侧目……在上一篇讲 webpack 学习的博客中也尝试使用了 Yarn，本篇就专门写写 Yarn。</p>
<a id="more"></a>
<h2 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h2><p>如果使用过 npm 的话，能发现二者在使用上非常接近，从 npm 迁移到 Yarn 近乎零成本。</p>
<p>初始化新项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># same as npm init</span></div><div class="line">yarn init</div></pre></td></tr></table></figure>
<p>执行该命令时，会询问项目名称，入口文件，作者等信息，确认后自动创建包管理文件 <code>package.json</code>，以后每次对包的增删更新都会同步到 <code>package.json</code> 中。</p>
<p>安装依赖包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># same as npm install [package]</span></div><div class="line">yarn add [package]</div><div class="line">yarn add [package]@[version]</div><div class="line">yarn add [package]@[tag]</div></pre></td></tr></table></figure>
<p>另外，该命令可以通过标识参数来指定依赖类型：</p>
<ul>
<li><code>yarn add --dev</code> 会把依赖包添加进 <code>devDependencies</code> 字段；</li>
<li><code>yarn add --peer</code> 会把依赖包添加进 <code>peerDependencies</code> 字段；</li>
<li><code>yarn add --optional</code> 会把依赖包添加进 <code>optionalDependencies</code> 字段；</li>
</ul>
<p>更新依赖包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># same as npm upgrade [package]</span></div><div class="line">yarn upgrade [package]</div><div class="line">yarn upgrade [package]@[version]</div><div class="line">yarn upgrade [package]@[tag]</div></pre></td></tr></table></figure>
<p>卸载依赖包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># same as npm uninstall [package]</span></div><div class="line">yarn remove [package]</div></pre></td></tr></table></figure>
<p>根据 <code>package.json</code> 安装所有依赖包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># same as npm install</span></div><div class="line">yarn install</div></pre></td></tr></table></figure>
<p>该命令也支持通过标识参数来实现额外的功能：</p>
<ul>
<li><code>yarn install --flat</code> 每个包都只允许安装唯一的版本，第一次运行时会提示用户确认版本；</li>
<li><code>yarn install --force</code> 强制联网下载所有包，即使之前下载过；</li>
<li><code>yarn install --production</code> 使用该标识符或者环境变量 <code>NODE_ENV</code> 为 <code>production</code> 时，Yarn 会忽略 <code>devDependencies</code> 中的依赖包；</li>
</ul>
<p>除了 <code>package.json</code> 外，Yarn 还维护了 <code>yarn.lock</code> 来精确匹配所有依赖包的版本号，来弥补 <code>package.json</code> 管理依赖包版本时的不精确问题。因此，如果使用 Yarn，需要把 <code>yarn.lock</code> 添加进版本管理中。</p>
<p>Yarn 还有其他一些比较常用的命令：</p>
<ul>
<li><code>yarn clean</code> 命令会清理掉不需要的依赖包，释放 <code>node_modules</code> 的空间。在执行该命令后，Yarn 会在项目根目录下创建 <code>.yarnclean</code> 文件，它也应该添加到版本管理中；</li>
<li><code>yarn config set &lt;key&gt; &lt;value&gt; [-g|--global]</code> 命令会设置默认的 Yarn 信息，相应的，读取的命令是 <code>yarn config get &lt;key&gt;</code>。可以设置的 <code>key</code> 可以由 <code>yarn config list</code> 命令查看到；</li>
<li><code>yarn global</code> 是一个前缀命令，可以加在 <code>add</code>、<code>remove</code> 等命令上，使得作用在全局上，类似 npm 的 <code>--global</code> 参数；</li>
<li><code>yarn info &lt;package&gt;</code> 命令用来查看依赖包的详细信息；</li>
<li><code>yarn login</code> 和 <code>yarn logout</code> 命令分别用来登录和登出 npm 的账户；</li>
<li><code>yarn run [script] [-- &lt;args&gt;]</code> 命令用来执行 <code>package.json</code> 配置的 <code>scripts</code> 脚本命令，和 <code>npm run [script]</code> 一样；</li>
<li><code>yarn why [package]</code> 命令检查安装该依赖包的原因，并列出依赖该包的其他包；</li>
</ul>
<h2 id="npm-命令比较"><a href="#npm-命令比较" class="headerlink" title="npm 命令比较"></a>npm 命令比较</h2><table>
<thead>
<tr>
<th style="text-align:center">npm</th>
<th style="text-align:center">Yarn</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">npm install</td>
<td style="text-align:center">yarn install</td>
</tr>
<tr>
<td style="text-align:center">(N/A)</td>
<td style="text-align:center">yarn install –flat</td>
</tr>
<tr>
<td style="text-align:center">(N/A)</td>
<td style="text-align:center">yarn install –har</td>
</tr>
<tr>
<td style="text-align:center">(N/A)</td>
<td style="text-align:center">yarn install –no-lockfile</td>
</tr>
<tr>
<td style="text-align:center">(N/A)</td>
<td style="text-align:center">yarn install –pure-lockfile</td>
</tr>
<tr>
<td style="text-align:center">npm install [package]</td>
<td style="text-align:center">(N/A)</td>
</tr>
<tr>
<td style="text-align:center">npm install –save [package]</td>
<td style="text-align:center">yarn add [package]</td>
</tr>
<tr>
<td style="text-align:center">npm install –save-dev [package]</td>
<td style="text-align:center">yarn add [package] [–dev/-D]</td>
</tr>
<tr>
<td style="text-align:center">(N/A)</td>
<td style="text-align:center">yarn add [package] [–peer/-P]</td>
</tr>
<tr>
<td style="text-align:center">npm install –save-optional [package]</td>
<td style="text-align:center">yarn add [package] [–optional/-O]</td>
</tr>
<tr>
<td style="text-align:center">npm install –save-exact [package]</td>
<td style="text-align:center">yarn add [package] [–exact/-E]</td>
</tr>
<tr>
<td style="text-align:center">(N/A)</td>
<td style="text-align:center">yarn add [package] [–tilde/-T]</td>
</tr>
<tr>
<td style="text-align:center">npm install –global [package]</td>
<td style="text-align:center">yarn global add [package]</td>
</tr>
<tr>
<td style="text-align:center">npm rebuild</td>
<td style="text-align:center">yarn install –force</td>
</tr>
<tr>
<td style="text-align:center">npm uninstall [package]</td>
<td style="text-align:center">(N/A)</td>
</tr>
<tr>
<td style="text-align:center">npm uninstall –save [package]</td>
<td style="text-align:center">yarn remove [package]</td>
</tr>
<tr>
<td style="text-align:center">npm uninstall –save-dev [package]</td>
<td style="text-align:center">yarn remove [package]</td>
</tr>
<tr>
<td style="text-align:center">npm uninstall –save-optional [package]</td>
<td style="text-align:center">yarn remove [package]</td>
</tr>
<tr>
<td style="text-align:center">npm cache clean</td>
<td style="text-align:center">yarn cache clean</td>
</tr>
<tr>
<td style="text-align:center">rm -rf node_modules &amp;&amp; npm install</td>
<td style="text-align:center">yarn upgrade</td>
</tr>
</tbody>
</table>
<h2 id="package-json-依赖配置"><a href="#package-json-依赖配置" class="headerlink" title="package.json 依赖配置"></a>package.json 依赖配置</h2><h3 id="功能区分管理"><a href="#功能区分管理" class="headerlink" title="功能区分管理"></a>功能区分管理</h3><p>有的依赖包是为了编译构建工程，而有的包视为了运行，因此不同功能的包在 <code>package.json</code> 中被分离到不同的依赖集合中：<code>dependencies</code>、<code>devDependencies</code>、<code>optionalDependencies</code> 和 <code>peerDependencies</code>。</p>
<p>参考 Yarn 文档里的示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"my-project"</span>,</div><div class="line">  <span class="attr">"dependencies"</span>: &#123;</div><div class="line">    <span class="attr">"package-a"</span>: <span class="string">"^1.0.0"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"package-b"</span>: <span class="string">"^1.2.1"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"peerDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"package-c"</span>: <span class="string">"^2.5.4"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"optionalDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"package-d"</span>: <span class="string">"^3.1.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用的最多的应该是 <code>dependencies</code> 和 <code>devDependencies</code>，下面按照官方文档具体说明：</p>
<ul>
<li><code>dependencies</code>：记录运行程序时所需的依赖包；</li>
<li><code>devDependencies</code>：这是开发的依赖包，是开发构建时所需的依赖包，但在运行时不需要；</li>
<li><code>peerDependencies</code>：只有当开发者需要发布自己的包时，才需要配置；</li>
<li><code>optionalDependencies</code>：顾名思义就是可选的依赖包，即使安装失败，也不会影响；</li>
<li><code>bundledDependencies</code>：是项目内部的包，而不是从 npm 上安装；</li>
</ul>
<h3 id="版本号管理"><a href="#版本号管理" class="headerlink" title="版本号管理"></a>版本号管理</h3><p><code>package.json</code> 也对依赖包的版本做了管理，版本号遵循 <code>major.minor.patch</code> 的规则，如果是 beta 版，则会在版本号后追加 <code>-beta.x</code>。除了明确指定版本号，还可以通过操作符实现指定版本号范围。</p>
<p>最简单易懂的就是 <code>=</code>、<code>&gt;</code>、<code>&lt;=</code> 等符号，这个不多讲，还有两个特殊的符号 <code>~</code> 和 <code>^</code>：</p>
<ul>
<li><code>~</code> 符：当版本号带有 <code>minor</code> 版本时，<code>~</code> 表示允许 <code>patch</code> 版本在 <code>minor</code> 保持不变时，递增变化。比如 <code>~3.1.4</code> 等同 <code>&gt;=3.1.4 &lt;3.2.0</code>；<code>~3.1</code> 等同于 <code>3.1.x</code>。当 <code>~</code> 后的版本号只有 <code>major</code> 时，只允许在 <code>major</code> 不变时，<code>minor</code> 的变化，比如 <code>~3</code> 等同于 <code>3.x</code>。</li>
<li><code>^</code> 符：允许版本号在不改变第一个非零版本位的范围变动，比如 <code>^3.1.4</code> 表示 <code>&gt;=3.1.4 &lt;4.0.0</code>，<code>^0.4.2</code> 表示 <code>&gt;=0.4.2 &lt;0.5.0</code>， <code>^0.0.2</code> 表示 <code>&gt;=0.0.2 &lt;0.0.3</code>。Yarn 在安装依赖包时，默认使用 <code>^</code> 来设置版本号。</li>
</ul>
<p>还有逻辑符号，用空格表示 <code>and</code> 关系，<code>||</code> 表示 <code>or</code> 关系，比如 <code>&gt;=2.0.0 &lt;3.1.4</code> 的意思是版本号大于等于 <code>2.0.0</code> 且小于 <code>3.1.4</code>。连字符 <code>-</code> 很有用，直接表示起止范围，上面这个版本范围用 <code>-</code> 符表示的话就是 <code>2.0.0 - 3.1.4</code>。</p>
<p>Yarn 的内容不多，使用也很简单，花半小时操练下命令就都了解了。</p>
<hr>
<p>参考资料：</p>
<ul>
<li>Yarn - <a href="https://yarnpkg.com/en/docs" target="_blank" rel="external">Docs</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;目前使用最广泛的 JavaScript 的包管理工具应该是 npm，可以说是非常时髦的工具。但是在前端圈子，三岁就得叫爷爷，拳怕少壮，不久前 Facebook 和 Google 等联手推出了新的包管理工具 Yarn，一阵横扫之势，GitHub 上狂收 2w+ stars，令人侧目……在上一篇讲 webpack 学习的博客中也尝试使用了 Yarn，本篇就专门写写 Yarn。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Frontend" scheme="https://isudox.com/tags/Frontend/"/>
    
  </entry>
  
  <entry>
    <title>2016 前端补习 Webpack 篇</title>
    <link href="https://isudox.com/2016/12/26/webpack-front-end-development-trends-in-2016/"/>
    <id>https://isudox.com/2016/12/26/webpack-front-end-development-trends-in-2016/</id>
    <published>2016-12-26T02:40:41.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>对于前端开发者而言，2016 又是一个风不平浪不静的一年。今年新冒出的框架工具，如果不是专职前端或全栈，估计现在和我是差不多的状态，一脸懵逼外加黑人问号脸。为了以后和前端协作时不被鄙视，努力在 2016 年结束前，赶紧先上车，这就是我一个后端开发做前端补习的动机，本文是 Webpack 篇，后续还会更新 Yarn、React、Redux 等。</p>
<a id="more"></a>
<blockquote>
<p>因为我对前端的认知停留在三脚猫的水平，因此本文不会执著于对不同框架/工具的优劣比较，谨作为个人浅尝辄止的学习记录。</p>
</blockquote>
<h2 id="Webpack-基础命令"><a href="#Webpack-基础命令" class="headerlink" title="Webpack 基础命令"></a>Webpack 基础命令</h2><h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h3><p><img src="https://webpack.github.io/assets/what-is-webpack.png" alt="What is webpack"></p>
<p><a href="https://webpack.js.org/" target="_blank" rel="external">Webpack</a> 是一个前端的模块（Module Bundler）打包工具，如上图所示，它可以对各种类型的静态文件做统一的加载和处理。在展开对它的学习之前，先把准备工作做好，Webpack 的安装很简单，全局或本地安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># globally install</span></div><div class="line">yarn global add webpack@2.1.0-beta.20</div><div class="line"><span class="comment"># locally install</span></div><div class="line">yarn add webpack@2.1.0-beta.20 -D</div></pre></td></tr></table></figure>
<p>安装完后，就可以在控制台使用 <code>webpack</code> 命令了。在目录下执行 <code>webpack</code>，首先需要配置 <code>webpack.config.js</code> 文件，由该配置文件来控制 <code>webpack</code> 的操作。参考阮一峰老师 GitHub 上的示例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.config.js</span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: <span class="string">'./main.js'</span>,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>然后执行 <code>webpack</code> 命令就可以按照配置文件的设置，把目录下的 <code>main.js</code> 打包成 <code>bundle.js</code>。</p>
<h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><p>Webpack 有 4 个核心概念必须要了解：<a href="https://webpack.js.org/concepts/entry-points/" target="_blank" rel="external">Entry</a>、<a href="https://webpack.js.org/concepts/output/" target="_blank" rel="external">Output</a>、<a href="https://webpack.js.org/concepts/loaders/" target="_blank" rel="external">Loaders</a> 和 <a href="https://webpack.js.org/concepts/plugins/" target="_blank" rel="external">Plugins</a>。</p>
<h4 id="Entry"><a href="#Entry" class="headerlink" title="Entry"></a>Entry</h4><p>webpack 为 web 应用的依赖关系创建了图表，而 Entry 则是告诉 webpack 这张图表的入口位置并循着依赖关系去打包，webpack 通过对 webpack configuration object 设置 <code>entry</code> 属性来定义 Entry，参考下面的代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># webpack.config.js</div><div class="line">module.exports = &#123;</div><div class="line">  entry: './path/to/my/entry/file.js'</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如果要指定多个 Entry，则需要将 <code>entry</code> 属性从 <code>string</code> 改为 <code>Array&lt;string&gt;</code>，比如 [‘./main.js’, ‘./index.js’]。也可以使用 Object 语法，把 <code>entry</code> 属性设置为一个 key-value 对象，这是更具扩展性的定义 <code>entry</code> 的写法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> config = &#123;</div><div class="line">  <span class="attr">entry</span>: &#123;</div><div class="line">    <span class="attr">app</span>: <span class="string">'./src/app.js'</span>,</div><div class="line">    <span class="attr">vendors</span>: <span class="string">'./src/vendors.js'</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"><span class="built_in">module</span>.exports = config;</div></pre></td></tr></table></figure>
<h4 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h4><p>既然由 Bundle 的入口 Entry，相应的必然也会有 Bundle 的出口，这就是 Output。我们需要告知 webpack 对打包后的静态资源如何处置，存放在哪，文件名是什么。webpack 的 <code>output</code> 属性描述了该如何处理打包后的代码。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># webpack.config.js</div><div class="line">var path = require('path');</div><div class="line"></div><div class="line">module.exports = &#123;</div><div class="line">  entry: './path/to/my/entry/file.js',</div><div class="line">  output: &#123;</div><div class="line">    path: path.resolve(__dirname, 'dist'),</div><div class="line">    filename: 'my-first-webpack.bundle.js'</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>对于 <code>output.filename</code>，如果 <code>entry</code> 属性配置了多个文件，则需要使用命名替换的方式确保 output filename 不重名。其中，占位符 <code>[name]</code> 采用 chunk 的名称作为替换，<code>[hash]</code> 是采用编译后文件的 hash 值替换，而 <code>[chunkhash]</code> 则是根据 chunk 的 hash 值来替换。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">entry</span>: &#123;</div><div class="line">    <span class="attr">app</span>: <span class="string">'./src/app.js'</span>,</div><div class="line">    <span class="attr">search</span>: <span class="string">'./src/search.js'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">filename</span>: <span class="string">'[name].js'</span>,</div><div class="line">    <span class="attr">path</span>: __dirname + <span class="string">'/build'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于 <code>output.path</code> 属性，必须设为绝对路径，占位符 <code>[hash]</code> 会被编译后文件的 hash 值替换：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">output: &#123;</div><div class="line">    <span class="attr">path</span>: <span class="string">"/home/proj/public/assets"</span>,</div><div class="line">    <span class="attr">publicPath</span>: <span class="string">"/assets/"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Loaders"><a href="#Loaders" class="headerlink" title="Loaders"></a>Loaders</h4><p>webpack 可以对项目里所有静态资源（包括 <code>.css</code>、<code>.html</code>、<code>scss</code>、<code>jpg</code> 等）所谓模块进行处理，但是 webpack 只能理解 JavaScript，如果要处理其他类型的静态文件，就需要 webpack 的 Loaders，把这些静态文件转换成模块的处理器。在 <code>webpack.config.js</code> 的 Loaders 属性配置中，有两个目标需要确认：</p>
<ol>
<li>标识什么文件可以被转换成模块（由 <code>test</code> 属性指定）；</li>
<li>指定转换这些文件的处理器 loader（由 <code>use</code> 属性指定）;</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> config = &#123;</div><div class="line">  <span class="attr">entry</span>: <span class="string">'./path/to/my/entry/file.js'</span>,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">path</span>: path.resolve(__dirname, <span class="string">'dist'</span>),  <span class="comment">// bundle 文件的绝对路径</span></div><div class="line">    publicPath: <span class="string">"/dist/"</span>,  <span class="comment">// 网站运行时的访问路径</span></div><div class="line">    filename: <span class="string">'my-first-webpack.bundle.js'</span>  <span class="comment">// bundle 的文件名</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">rules</span>: [</div><div class="line">      &#123;<span class="attr">test</span>: <span class="regexp">/\.(js|jsx)$/</span>, <span class="attr">use</span>: <span class="string">'babel-loader'</span>&#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>上面的配置，通过 <code>rule</code> 属性对单个模块的处理进行设置，因此 webpack 会对项目依赖关系中被 <code>require</code> 或 <code>import</code> 的 <code>.js</code> 和 <code>.jsx</code> 文件，在它们被添加进 bundle 之前，用 <code>babel-loader</code> 处理器进行转换处理（该处理器会把 JSX 和 ES6 的文件转换成 JS 文件）。另外，loaders 的名称都是 <code>xxx-loader</code> 格式，<code>use</code> 属性也可以简写为 <code>xxx</code>。</p>
<h4 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h4><p>Loaders 只能在 bundle 之前对静态资源作预处理，而 Plugins 则可以对编译后文件和 chunk 文件进行处理，比如 <code>UglifyJsPlugin</code> 可以对 bundle 后的 JavaScript 代码进行压缩处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</div><div class="line"><span class="keyword">var</span> uglifyJsPlugin = webpack.optimize.UglifyJsPlugin;</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: <span class="string">'./main.js'</span>,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">plugins</span>: [</div><div class="line">    <span class="keyword">new</span> uglifyJsPlugin(&#123;</div><div class="line">      <span class="attr">compress</span>: &#123;</div><div class="line">        <span class="attr">warnings</span>: <span class="literal">false</span></div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  ]</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="结合-React"><a href="#结合-React" class="headerlink" title="结合 React"></a>结合 React</h2><p>在了解 webpack 的基础操作后，可以在 React 项目中实际运用 webpack 进行打包。为了便于描述，就采用最简单的 Hello World 例子。React 项目结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- hello-world</div><div class="line">    - dist/</div><div class="line">    - src/</div><div class="line">        - js/</div><div class="line">            Welcome.js</div><div class="line">            entry.js</div><div class="line">    index.html</div><div class="line">    webpack.config.js</div></pre></td></tr></table></figure>
<p>其中，<code>Welcome.js</code> 定义了一个 React Component，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Welcome.js</span></div><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;this.props.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>entry.js</code> 是依赖关系的入口文件，引入依赖的模块，并输出页面元素：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// entry.js</span></div><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> Welcome <span class="keyword">from</span> <span class="string">'./Welcome'</span>;</div><div class="line"></div><div class="line">React.render(<span class="xml"><span class="tag">&lt;<span class="name">Welcome</span> <span class="attr">name</span>=<span class="string">"sudoz"</span> /&gt;</span>, document.getElementById('root'));</span></div></pre></td></tr></table></figure>
<p>而 <code>index.html</code> 的页面源码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- This HTML file is a template. --&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/dist/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>webpack.config.js</code> 需要对 React 的 JSX 文件进行 babel 转换：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.config.js</span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: [</div><div class="line">    path.resolve(root_path, <span class="string">'./src/js/entry'</span>)</div><div class="line">  ],</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">path</span>: path.resolve(root_path, <span class="string">'dist'</span>),</div><div class="line">    <span class="attr">publicPath</span>: <span class="string">'/dist/'</span>,</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">rules</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.js[x]$/</span>,</div><div class="line">        <span class="attr">use</span>: [<span class="string">'babel-loader'</span>],</div><div class="line">        <span class="attr">query</span>: &#123;</div><div class="line">          <span class="attr">presets</span>: [<span class="string">'es2015'</span>, <span class="string">'react'</span>]</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="模块热替换"><a href="#模块热替换" class="headerlink" title="模块热替换"></a>模块热替换</h2><p>当修改、新增或移除模块时，热替换（Hot Module Replacement, HMR）可以使程序无需重新载入页面就能实现更新。</p>
<p>要使用 HMR，需要安装一下依赖，另外在安装 React 依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yarn add -D babel@6.5.2 babel-core@6.13.2 babel-loader@6.2.4 babel-preset-es2015@6.13.2 babel-preset-react@6.11.1 babel-preset-stage-2@6.13.0 css-loader@0.23.1 postcss-loader@0.9.1 react-hot-loader@3.0.0-beta.6 style-loader@0.13.1 webpack@2.1.0-beta.20 webpack-dev-server@2.1.0-beta.0</div><div class="line"></div><div class="line">yarn add react@15.3.0 react-dom@15.3.0</div></pre></td></tr></table></figure>
<p>配置 <code>.babelrc</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"presets"</span>: [</div><div class="line">    [<span class="string">"es2015"</span>, &#123;<span class="string">"modules"</span>: <span class="literal">false</span>&#125;],</div><div class="line">    <span class="comment">// webpack understands the native import syntax, and uses it for tree shaking</span></div><div class="line"></div><div class="line">    <span class="string">"stage-2"</span>,</div><div class="line">    <span class="comment">// Specifies what level of language features to activate.</span></div><div class="line">    <span class="comment">// Stage 2 is "draft", 4 is finished, 0 is strawman.</span></div><div class="line">    <span class="comment">// See https://tc39.github.io/process-document/</span></div><div class="line"></div><div class="line">    <span class="string">"react"</span></div><div class="line">    <span class="comment">// Transpile React components to JavaScript</span></div><div class="line">  ],</div><div class="line">  <span class="string">"plugins"</span>: [</div><div class="line">    <span class="string">"react-hot-loader/babel"</span></div><div class="line">    <span class="comment">// Enables React code to work with HMR.</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>webpack.config.js</code> 的参考配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123; resolve &#125; = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: [</div><div class="line">    <span class="string">'react-hot-loader/patch'</span>,</div><div class="line">    <span class="comment">// activate HMR for React</span></div><div class="line"></div><div class="line">    <span class="string">'webpack-dev-server/client?http://localhost:8080'</span>,</div><div class="line">    <span class="comment">// bundle the client for webpack-dev-server</span></div><div class="line">    <span class="comment">// and connect to the provided endpoint</span></div><div class="line"></div><div class="line">    <span class="string">'webpack/hot/only-dev-server'</span>,</div><div class="line">    <span class="comment">// bundle the client for hot reloading</span></div><div class="line">    <span class="comment">// only- means to only hot reload for successful updates</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="string">'./index.js'</span></div><div class="line">    <span class="comment">// the entry point of our app</span></div><div class="line">  ],</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span>,</div><div class="line">    <span class="comment">// the output bundle</span></div><div class="line"></div><div class="line">    path: resolve(__dirname, <span class="string">'dist'</span>),</div><div class="line"></div><div class="line">    <span class="attr">publicPath</span>: <span class="string">'/'</span></div><div class="line">    <span class="comment">// necessary for HMR to know where to load the hot update chunks</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="attr">context</span>: resolve(__dirname, <span class="string">'src'</span>),</div><div class="line"></div><div class="line">  <span class="attr">devtool</span>: <span class="string">'inline-source-map'</span>,</div><div class="line"></div><div class="line">  <span class="attr">devServer</span>: &#123;</div><div class="line">    <span class="attr">hot</span>: <span class="literal">true</span>,</div><div class="line">    <span class="comment">// enable HMR on the server</span></div><div class="line"></div><div class="line">    contentBase: resolve(__dirname, <span class="string">'dist'</span>),</div><div class="line">    <span class="comment">// match the output path</span></div><div class="line"></div><div class="line">    publicPath: <span class="string">'/'</span></div><div class="line">    <span class="comment">// match the output `publicPath`</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">rules</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</div><div class="line">        <span class="attr">use</span>: [</div><div class="line">          <span class="string">'babel-loader'</span>,</div><div class="line">        ],</div><div class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</div><div class="line">        <span class="attr">use</span>: [</div><div class="line">          <span class="string">'style-loader'</span>,</div><div class="line">          <span class="string">'css-loader?modules'</span>,</div><div class="line">          <span class="string">'postcss-loader'</span>,</div><div class="line">        ],</div><div class="line">      &#125;,</div><div class="line">    ],</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="attr">plugins</span>: [</div><div class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</div><div class="line">    <span class="comment">// enable HMR globally</span></div><div class="line"></div><div class="line">    <span class="keyword">new</span> webpack.NamedModulesPlugin(),</div><div class="line">    <span class="comment">// prints more readable module names in the browser console on HMR updates</span></div><div class="line">  ],</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>上面的配置是假定入口文件是 <code>./src/index.js</code>，且需要引入 Loader 来处理 CSS 模块。注意 <code>entry</code> 属性中增加了 <code>react-hot-loader</code> 模块，这是开启 React 组件 HMR 的必要操作。<code>NamedModulesPlugin</code> 是非常有用的 Plugin，它能友好的显示什么模块发生了 HMR。</p>
<p>再来看 webpack 官方文档给出的入口 JS 文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ./src/index.js</span></div><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; AppContainer &#125; <span class="keyword">from</span> <span class="string">'react-hot-loader'</span>;</div><div class="line"><span class="comment">// AppContainer is a necessary wrapper component for HMR</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./components/App'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> render = <span class="function">(<span class="params">Component</span>) =&gt;</span> &#123;</div><div class="line">  ReactDOM.render(</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">AppContainer</span>&gt;</span></span></div><div class="line">      <span class="tag">&lt;<span class="name">Component</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">AppContainer</span>&gt;</span>,</div><div class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</div><div class="line">  );</div><div class="line">&#125;;</div><div class="line"></div><div class="line">render(App);</div><div class="line"></div><div class="line"><span class="comment">// Hot Module Replacement API</span></div><div class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</div><div class="line">  <span class="built_in">module</span>.hot.accept(<span class="string">'./components/App'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> NewApp = <span class="built_in">require</span>(<span class="string">'./components/App'</span>).default</div><div class="line">    render(NewApp)</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>App 组件 <code>App.js</code> 源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ./src/components/App.js</span></div><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">'./App.css'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> (</div><div class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.app&#125;</span>&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Hello, <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</div></pre></td></tr></table></figure>
<p><code>App.css</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// ./src/components/App.css</div><div class="line">.app &#123;</div><div class="line">    text-size-adjust: none;</div><div class="line">    font-family: helvetica, arial, sans-serif;</div><div class="line">    line-height: 200%;</div><div class="line">    padding: 6px 20px 30px;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在项目根目录下执行 <code>webpack-dev-server</code>，打开 <code>http：//127.0.0.1:8080</code> 查看页面控制台。</p>
<hr>
<p>参考资料：</p>
<ul>
<li>Webpack 2 - <a href="https://webpack.js.org" target="_blank" rel="external">Docs</a></li>
<li>阮一峰 - <a href="https://github.com/ruanyf/webpack-demos" target="_blank" rel="external">webpack-demos</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对于前端开发者而言，2016 又是一个风不平浪不静的一年。今年新冒出的框架工具，如果不是专职前端或全栈，估计现在和我是差不多的状态，一脸懵逼外加黑人问号脸。为了以后和前端协作时不被鄙视，努力在 2016 年结束前，赶紧先上车，这就是我一个后端开发做前端补习的动机，本文是 Webpack 篇，后续还会更新 Yarn、React、Redux 等。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Frontend" scheme="https://isudox.com/tags/Frontend/"/>
    
      <category term="Webpack" scheme="https://isudox.com/tags/Webpack/"/>
    
  </entry>
  
  <entry>
    <title>CORS 跨域调试记录</title>
    <link href="https://isudox.com/2016/11/12/cors-in-action/"/>
    <id>https://isudox.com/2016/11/12/cors-in-action/</id>
    <published>2016-11-11T16:31:58.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>之前写了篇关于 JSONP 和 CORS 解决跨域请求的博客，在最近和深圳凹凸团队前后端联调时实打实的实战了一把 CORS。还是应了纸上得来终觉浅的老话，因为实际运用中会存在不同的状况，只是看文档理解概念并不能真正成为实战派。</p>
<a id="more"></a>
<p>这次联调采用前后端分离的方式，后端由 Spring MVC 提供数据接口，前端通过异步的方式做数据渲染，和以往不同的是，由于前端开发全部交给深圳的凹凸实验室，所以静态文件都跑在独立的一个域名上，就是京东的通天塔项目。因此所有来自前端的请求都成了跨域请求。</p>
<p>JSONP 确实是通过一种巧妙的伎俩解决了跨域请求被浏览器拒绝的问题，但是它并不能解决 POST 跨域，联调的接口是跨域上传头像，采用 POST 发送 FormData 对象的方式。所以由服务端 CORS 来处理。</p>
<p>对于服务端，Spring MVC 设置 CORS 很简单，如果 springframework 版本是 4.2 及以上，Spring MVC 可以直接由注解 <code>@CrossOrigin</code> 对标记的控制器方法设置 CORS。例如下面的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@CrossOrigin</span>(origins = <span class="string">"http://localhost:9000"</span>)</div><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/greeting"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> Greeting <span class="title">greeting</span><span class="params">(@RequestParam(required=<span class="keyword">false</span>, defaultValue=<span class="string">"World"</span>)</span> String name) </span>&#123;</div><div class="line">    System.out.println(<span class="string">"==== in greeting ===="</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Greeting(counter.incrementAndGet(), String.format(template, name));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@CrossOrigin</code> 注解可以通过设置 <code>origins</code>、<code>methods</code>、<code>maxAge</code>、<code>allowHeaders</code>、<code>allowCredentials</code> 等参数来确定 CORS 接受跨域的来源域，请求类型，请求头等。如果 origins 设置为星号，则对所有来源域的请求都允许跨域，methods 设置为 POST 就只允许请求类型为 POST 的跨域请求。</p>
<p>前端正常发送异步请求，类似如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</div><div class="line">formData.append(<span class="string">'avatar'</span>, <span class="string">'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEX/TQBcNTh/AAAAAXRSTlPM0jRW/QAAAApJREFUeJxjYgAAAAYAAzY3fKgAAAAASUVORK5CYII='</span>);</div><div class="line"><span class="keyword">var</span> req = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">req.open(<span class="string">'POST'</span>, <span class="string">'//xxx.jd.com/xxx/xxx'</span>);</div><div class="line">req.send(fromData);</div></pre></td></tr></table></figure>
<p>但是结果并不如人意，返回码 302，请求被强制跳转京东的统一登录，这就是一个问题点，因为上传头像要求登录状态，所以浏览器请求时必须带上本地的 cookies，如果是 JSONP 的方式，它默认会传递 cookies。所以需要将 XMLHttpRequest 的凭证信息标识位设为 true：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> req = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">req.withCredentials = <span class="literal">true</span>;</div></pre></td></tr></table></figure>
<p>这里有一点需要留意，如果请求带上了 cookies 那么服务端 CORS 的 origins 不能是 <code>*</code> 号，必须明确指定允许的来源 origin。再次联调测试，跨域还是失败了，看服务端日志发现，请求根本没有进入到 Controller 层，在登录拦截器里就被拒绝了。这是另外一个问题，因为 Spring MVC 设置了 interceptors，符合规则的请求都会被 interceptor 拦截，要么排除该跨域请求，但这是不可取，因为必须是登录用户才能进行的操作。所以需要在拦截器的 <code>preHandle()</code> 方法里进行处理，把来源域的加入到响应头的 <code>Access-Control-Allow-Origin</code> 字段中，同时设置 <code>Access-Control-Allow-Headers</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span></span>&#123;</div><div class="line">  <span class="comment">// before the actual handler will be executed</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">    HttpServletResponse response, Object handler) <span class="keyword">throws</span> Exception &#123;</div><div class="line">            response.addHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"http://h5.m.jd.com"</span>);</div><div class="line">            response.addHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET, PUT, POST, DELETE, OPTIONS"</span>);</div><div class="line">            response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type, Authorization, X-Requested-With, isAjaxRequest"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>心想这次总该 OK 了吧，还是没调通，我摔！但是这次是有进步的，因为请求进到 Controller 的方法里，执行完了头像上传，只是浏览器的到的响应体为空，打开浏览器的控制台看到一段错误信息：</p>
<blockquote>
<p>XMLHttpRequest cannot load <a href="http://xxxp.jd.com/xxx/xxx" target="_blank" rel="external">http://xxxp.jd.com/xxx/xxx</a>. Credentials flag is ‘true’, but the ‘Access-Control-Allow-Credentials’ header is ‘’. It must be ‘true’ to allow credentials. Origin ‘<a href="http://h5.m.jd.com" target="_blank" rel="external">http://h5.m.jd.com</a>‘ is therefore not allowed access.</p>
</blockquote>
<p>这是第三个问题，POST 请求是标记了凭证信息标识位，但是服务端回传的响应头的 <code>Access-Control-Allow-Credentials</code> 字段却是空，而不是 <code>true</code>，解决办法显而易见了，设置 <code>HttpServletResponse</code> 响应字段为 <code>true</code> 即可：</p>
<pre><code class="java"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request,
    HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>{
        response.addHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);        
        <span class="keyword">return</span> <span class="keyword">true</span>;
}
</code></pre>
<p>这样处理后，浏览器就收到的 Controller 层方法返回的 JSON 结果。</p>
<p>以上就是这次由服务端 CORS 实现的跨域请求的调试过程。其实从结果看真的很简单，只是有些问题如果实际开发中没有遇到，很容易疏漏，仅仅是看文档学怎么用还是不够的。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前写了篇关于 JSONP 和 CORS 解决跨域请求的博客，在最近和深圳凹凸团队前后端联调时实打实的实战了一把 CORS。还是应了纸上得来终觉浅的老话，因为实际运用中会存在不同的状况，只是看文档理解概念并不能真正成为实战派。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="HTTP" scheme="https://isudox.com/tags/HTTP/"/>
    
      <category term="SpringMVC" scheme="https://isudox.com/tags/SpringMVC/"/>
    
  </entry>
  
  <entry>
    <title>理解 Python 生成器</title>
    <link href="https://isudox.com/2016/10/26/python-generator-guide/"/>
    <id>https://isudox.com/2016/10/26/python-generator-guide/</id>
    <published>2016-10-26T12:23:03.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>在 Python 里创建一个有一定规律的序列，很直观的做法就是在循环里创建序列的各个元素。但 Python 有更加符合 Pythonic 风格的做法，就是用生成器来实现。</p>
<a id="more"></a>
<p>举个被写滥的例子吧，用 Python 生成 Fibonacci 数列的前 n 个数字，该怎么做？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_fib</span><span class="params">(n)</span>:</span></div><div class="line">    res = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</div><div class="line">        res.append(fib(i))</div><div class="line">    <span class="keyword">return</span> res</div></pre></td></tr></table></figure>
<p>而 Pythonic 的写法是像下面这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</div><div class="line">        <span class="keyword">yield</span> fib(i)</div></pre></td></tr></table></figure>
<p>查看把上面两种做法的返回结果，可以找到二者的不同：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;class &apos;list&apos;&gt;</div><div class="line">&lt;class &apos;generator&apos;&gt;</div></pre></td></tr></table></figure>
<p>前者返回的是 <code>list</code> 对象，后者返回的是 <code>generator</code> 对象。这就是本文要探讨的点。</p>
<h3 id="Generator-对象"><a href="#Generator-对象" class="headerlink" title="Generator 对象"></a>Generator 对象</h3><p>再看上面的代码，第一种写法里，<code>gen_fib()</code> 方法由 <code>return</code> 关键字返回结果；在第二种写法里，<code>gen_fib()</code> 方法却没有显式的返回，而是通过 <code>yield</code> 关键字得到处理结果。</p>
<p><code>yield</code> 关键字的作用是使对象变成一个 <code>generator</code>，换句话说，此时 <code>generator</code> 对象还没有把结果生成出来。可以通过 <code>next()</code> 方法使 <code>generator</code> 对象把待生成的元素逐个生成。看下面这段简单的示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_yield</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">yield</span> n</div><div class="line">    <span class="keyword">yield</span> n + <span class="number">1</span></div><div class="line"></div><div class="line">g = test_yield(<span class="number">1</span>)</div><div class="line">next(g)</div><div class="line">next(g)</div><div class="line">next(g)</div></pre></td></tr></table></figure>
<p>运行得到的结果是依次输出 1、2 和抛出 <code>StopIteration</code> 的异常信息。<code>yield</code> 类似程序执行的断点，<code>next()</code> 方法进入到断点的现场，执行断点处的代码，再次调用 <code>next()</code>，则进入下一个断点处，直到越界为止。注意，虽然上面多次用了 <code>yield</code>，但 <code>generator</code> 对象只被创建了一次，且并不是再它被创建时就执行了生成元素的全部过程，而是在调用 <code>next()</code> 方法时，才去执行了断点所在处的代码，取得变量值。</p>
<p>因为 <code>generator</code> 是 iterable 的，因此可以直接在 for 循环中将元素迭代生成出来，也避免了 <code>next()</code> 方法在最后一次查找断点现场时发生越界的问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">g = gen_fib(<span class="number">10</span>)</div><div class="line"><span class="keyword">for</span> e <span class="keyword">in</span> g:</div><div class="line">    do_something(e)</div></pre></td></tr></table></figure>
<p><code>generator</code> 的好处显而易见，它不需要像普通的写法那样预先创建一个 iterable 的集合再将其返回，它只是在需要生成某个元素时再去执行生成的代码，这有效提升了内存管理。</p>
<hr>
<p>参考资料：</p>
<ul>
<li>Python Wiki - <a href="https://wiki.python.org/moin/Generators" target="_blank" rel="external">Generators</a></li>
<li><a href="https://jeffknupp.com/blog/2013/04/07/improve-your-python-yield-and-generators-explained/" target="_blank" rel="external">Improve Your Python: ‘yield’ and Generators Explained</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在 Python 里创建一个有一定规律的序列，很直观的做法就是在循环里创建序列的各个元素。但 Python 有更加符合 Pythonic 风格的做法，就是用生成器来实现。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Python" scheme="https://isudox.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode 26-30</title>
    <link href="https://isudox.com/2016/10/17/leetcode-26-30/"/>
    <id>https://isudox.com/2016/10/17/leetcode-26-30/</id>
    <published>2016-10-17T09:09:15.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>三个月没上 LeetCode了，最近工作不顺心，好想被虐个痛快，接着写 LeetCode 第 26 至 30 题。<br><a id="more"></a></p>
<h3 id="Remove-Duplicates-from-Sorted-Array"><a href="#Remove-Duplicates-from-Sorted-Array" class="headerlink" title="Remove Duplicates from Sorted Array"></a>Remove Duplicates from Sorted Array</h3><p>第 26 题 <a href="https://leetcode.com/problems/remove-duplicates-from-sorted-array/" target="_blank" rel="external">Remove Duplicates from Sorted Array</a></p>
<blockquote>
<p>给定一个有序数组，去掉其中重复的元素，并返回新数组的长度。<br>不要为其他数组分配额外的空间，必须在给定的内存中完成。</p>
</blockquote>
<p>假设传入的数组是 <code>[1, 1, 2]</code>，得到的结果应该是 2。题意很简单，但是有两个注意点，一个是该数组是有序的，即从小到大排列，另一个是不允许分配新数组的存储空间，这就意味着不用创建新的数组来保存数据，也不能通过 Set 来过滤重复元素。</p>
<p>因为第二点的限，只能在给定的数组上进行数值比较的同时，计算非重复元素的数量；因为第一点的设定，所以可以做到对数组只遍历一次。具体做法就是，在遍历数组元素时，比较前后两个元素，如果相等，则重复元素的数量加一，同时移动当前遍历位置，直到遍历到数组最末元素。</p>
<p>编写 Java 解法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Rejected ×</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">removeDuplicates</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = nums.length;</div><div class="line">        <span class="keyword">int</span> dup = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (count &lt; <span class="number">2</span>)</div><div class="line">            <span class="keyword">return</span> count;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count - <span class="number">1</span>; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (nums[i] == nums[i + <span class="number">1</span>])</div><div class="line">                dup++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> count - dup;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>本地测试结果是正确的，但是提交的 LeetCode 上却被否决，因为上面的方法只计算出了非重复元素的个数 n，没有考虑把有序数组前 n 位修改成正确的有序非重复元素。因此在遍历的同时，需要修改发现重复的位置上的元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Accepted √</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">removeDuplicates</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = nums.length;</div><div class="line">        <span class="keyword">if</span> (count &lt; <span class="number">2</span>)</div><div class="line">            <span class="keyword">return</span> count;</div><div class="line">        <span class="keyword">int</span> left = <span class="number">0</span>, right = <span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> (right &lt; count) &#123;</div><div class="line">            <span class="keyword">if</span> (nums[left] == nums[right]) &#123;</div><div class="line">                right++;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                nums[++left] = nums[right++];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> left + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Remove-Element"><a href="#Remove-Element" class="headerlink" title="Remove Element"></a>Remove Element</h3><p>第 27 题 <a href="https://leetcode.com/problems/remove-element/" target="_blank" rel="external">Remove Element</a></p>
<blockquote>
<p>给定一个数组和一个数，移除数组中所有和给定数相同的数，并返回该数组修改后的长度。<br>不要为其他数组分配额外的空间，必须在给定的内存中完成。<br>数组元素的顺序可以被改变。</p>
</blockquote>
<p>例如传入的数组为 <code>[3, 2, 2, 3]</code>，数值是 3，函数处理后返回的长度是 2，且数组的前两个元素是 2。</p>
<p>这道题比上题简单，无非就是数组元素和给定数值的比较，如果相等，则去掉，如果不等则保留。唯一需要想办法的是如何把要保留的元素放在数组前面的位置。当找到第一个和给定数不等的元素时，就把它放在数组的首位，再找下一个不等的元素，放在数组的第二个位置，这样递推直到遍历完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">removeElement</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> num : nums) &#123;</div><div class="line">            <span class="keyword">if</span> (num != val)</div><div class="line">                nums[index++] = num;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> index;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Implement-strStr"><a href="#Implement-strStr" class="headerlink" title="Implement strStr()"></a>Implement strStr()</h3><p>第 28 题 <a href="https://leetcode.com/problems/implement-strstr/" target="_blank" rel="external">Implement strStr()</a></p>
<blockquote>
<p>实现 <code>strStr()</code> 方法。<br>判断字符串 <code>needle</code> 是否在字符串 <code>haystack</code> 中，如果是，则返回首次出现的位置，如果不是，则返回 -1</p>
</blockquote>
<p>粗暴的解法很简单，用两个指针分别遍历字符串，逐次比较指针所指向的字符，如果相同指针往下移动，如果不同，<code>needle</code> 上的指针回到起始位置 0，<code>haystack</code> 上的指针则后退 <code>needle</code> 指针移动的距离回到之前和 <code>needle</code> 首字符相同的位置后，再往下移动一步。如果 <code>needle</code> 上的指针最终完成了遍历，则表明 <code>haystack</code> 中首次出现了 <code>needle</code>。</p>
<p>Java 解法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">strStr</span><span class="params">(String haystack, String needle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (needle.equals(<span class="string">""</span>))</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (haystack.length() &lt; needle.length())</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, start = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (i &lt; haystack.length() &amp;&amp; j &lt; needle.length()) &#123;</div><div class="line">            <span class="keyword">if</span> (haystack.charAt(i) == needle.charAt(j)) &#123;</div><div class="line">                i++;</div><div class="line">                j++;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                i = i - j + <span class="number">1</span>;</div><div class="line">                j = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (j == needle.length())</div><div class="line">                <span class="keyword">return</span> i - j;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Divide-Two-Integers"><a href="#Divide-Two-Integers" class="headerlink" title="Divide Two Integers"></a>Divide Two Integers</h3><p>第 29 题 <a href="https://leetcode.com/problems/divide-two-integers/" target="_blank" rel="external">Divide Two Integers</a></p>
<blockquote>
<p>两个整数做除法，要求不能使用乘法、除法、取余运算。如果结果溢出，则返回 MAX_INT。</p>
</blockquote>
<p>整数相除，又不允许使用乘法、除法、取余，那么能想到的只能是减法了。除数不断减去被除数，直到小于除数为止。但是这样做效率很低，试想如果计算 10000 和 1 相除，那么岂不是要做 10000 次减法！就是要找一种方法使得除数能快速接近被除数，除了幂运算外，乘法是最快的，既然不能直接用乘法，那就用位运算，向左位移 n 位就是乘以 2<sup>n</sup>。接下来就相当于做折半操作，每次减去 2<sup>n</sup> 个除数，再递减 n，直到不够做减法为止。当然这个方法有个前提，就是需要把两个整数都取绝对值。</p>
<p>这里还需要注意，Java 里 <code>-2147483648</code> 取绝对值还是 <code>-2147483648</code>，因为试图把它变成正数时出现越界，又变成了 <code>-2147483648</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> dividend, <span class="keyword">int</span> divisor)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (divisor == <span class="number">0</span> || dividend == Integer.MIN_VALUE &amp;&amp; divisor == -<span class="number">1</span>)</div><div class="line">            <span class="keyword">return</span> Integer.MAX_VALUE;</div><div class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">        <span class="keyword">boolean</span> positive = dividend &gt; <span class="number">0</span> == divisor &gt; <span class="number">0</span>;</div><div class="line">        <span class="keyword">long</span> dividend1 = dividend == Integer.MIN_VALUE ? <span class="number">2147483648</span> : Math.abs(dividend);</div><div class="line">        <span class="keyword">long</span> divisor1 = divisor == Integer.MIN_VALUE ? <span class="number">2147483648L</span> : Math.abs(divisor);</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (divisor1 &lt;&lt; (i + <span class="number">1</span>) &lt;= dividend1)</div><div class="line">            i++;</div><div class="line">        <span class="keyword">while</span> (dividend1 &gt;= divisor1) &#123;</div><div class="line">            <span class="keyword">if</span> (dividend1 &gt;= divisor1 &lt;&lt; i) &#123;</div><div class="line">                result = result + (<span class="number">1</span> &lt;&lt; i);</div><div class="line">                dividend1 = dividend1 - (divisor1 &lt;&lt; i);</div><div class="line">            &#125;</div><div class="line">            i--;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> positive ? result : -result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Substring-with-Concatenation-of-All-Words"><a href="#Substring-with-Concatenation-of-All-Words" class="headerlink" title="Substring with Concatenation of All Words"></a>Substring with Concatenation of All Words</h3><p>第 30 题 <a href="https://leetcode.com/problems/substring-with-concatenation-of-all-words" target="_blank" rel="external">Substring with Concatenation of All Words</a></p>
<blockquote>
<p>给定一个字符串 s，和单词数组 words，数组中每个单词的长度都是相同的。依次从 s 中找到所有由 words 数组中元素能组成的字符串的匹配位置。（不需要考虑 words 是空字符串）<br>例如，<br>s: “barfoothefoobarman”<br>words: [“foo”, “bar”]<br>处理的结果为 [0, 9]。对顺序不作要求。</p>
</blockquote>
<p>题意比较绕，根据上面给出的例子，words 数组元素可组成 <code>foobar</code> 和 <code>barfoo</code> 两个字符串，从 s 中查找这两个字符串的首次匹配位置，分别是 0 和 9，所以结果是 [0, 9]。</p>
<p>最暴力直接的思路就是用 words 数组元素所有可能的组合去撞字符串 s，如果匹配到，就记录下匹配位置。但是这种方法性能很差，一来组合的字符串可能出现重复，二来每个字符串都要和 s 进行比较，产生大量冗余操作。</p>
<p>换个方向，用 s 去撞 words。从初始位置 i = 0 开始，截取 s 中起止位置为 i 和 i + len 的子字符串 substring，其中 len 为 words 中每个元素的长度。如果 substring_1 是 words 数组中的元素，则再截取 s 中起止位置为 i 和 i + count 的子字符串 substring_2，count 为 words 数组所有元素的总长度，然后用这个 substring_2 去匹配 words 中的元素，匹配的思路也是一样，从 substring_2 拆分成每个元素长度为 len 的列表 list，再用 list 去匹配 words 中的元素，如果没有匹配到，就放弃该 substring_2，继续从 i + 1 处截取 s 的子字符串；如果匹配到，则继续下一个匹配，直到全部匹配 words，保存索引位置 i 到结果中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">findSubstring</span><span class="params">(String s, String[] words)</span> </span>&#123;</div><div class="line">        List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">        <span class="keyword">if</span> (words.length == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        List&lt;String&gt; wordList = Arrays.asList(words);</div><div class="line">        <span class="keyword">int</span> len = words[<span class="number">0</span>].length();</div><div class="line">        <span class="keyword">int</span> sLen = s.length();</div><div class="line">        <span class="keyword">if</span> (len &gt; sLen)</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        <span class="keyword">int</span> wordsLen = len * (words.length);</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (i &lt;= sLen - wordsLen) &#123;</div><div class="line">            String word = s.substring(i, i + len);</div><div class="line">            <span class="keyword">if</span> (wordList.contains(word)) &#123;</div><div class="line">                String substr = s.substring(i, i + wordsLen);</div><div class="line">                <span class="keyword">if</span> (isValid(substr, wordList, len))</div><div class="line">                    result.add(i);</div><div class="line">            &#125;</div><div class="line">            i++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String str, List&lt;String&gt; wordList, <span class="keyword">int</span> len)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length() / len; i++) &#123;</div><div class="line">            String s = str.substring(i * len, (i + <span class="number">1</span>) * len);</div><div class="line">            list.add(s);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (String s : wordList) &#123;</div><div class="line">            <span class="keyword">if</span> (list.contains(s)) &#123;</div><div class="line">                list.remove(s);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中把 Array 转换成 List，借 Java Collections 现成的方法，偷懒省去了一些原本需要自己实现的方法。</p>
<p>另，LeetCode 的 OJ 系统有 bug，同样的代码，提交时偶尔会报 “Time Limit Exceeded”，而实际是正确的，再次提交运行就通过了……</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;三个月没上 LeetCode了，最近工作不顺心，好想被虐个痛快，接着写 LeetCode 第 26 至 30 题。&lt;br&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Algorithm" scheme="https://isudox.com/tags/Algorithm/"/>
    
      <category term="LeetCode" scheme="https://isudox.com/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>敏捷开发实战：AOP + 反射</title>
    <link href="https://isudox.com/2016/10/11/spring-aop-with-reflection/"/>
    <id>https://isudox.com/2016/10/11/spring-aop-with-reflection/</id>
    <published>2016-10-11T03:40:04.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>双十一前遭到产品突袭，要把非自营商家的处方药购买流程改为预约流程（出于某种考虑），内心一万只草泥马呼啸而过，那么多接口只给几天时间怎么改的过来……好在需要调用的购物车服务已经为新的预约流程分离了单独的 Redis 存储分组，要做的工作就是在恰当的时候调用恰当的服务。</p>
<a id="more"></a>
<p>如果直接在原有的相关接口方法中进行修改，一方面改动面太大，另一方面回归测试的压力也大，这种侵入式的代码不可取；从本质上看，从购买流程改预约流程无非就是改变相关服务的调用，是对行为的改变，这正是 AOP 的施展舞台。通过 AOP 在切面上织入切点，由 Advice 改变切面的行为，配合反射，根据业务决定动态的调用适配的方法，在不影响原有流程的同时，实现了业务行为的改变。总而言之四个字——亦可赛艇！</p>
<p>Spring AOP 有多种写法，XML 写法的，Java 写法的，Java 的写法会比 XML 来的更灵活，但对 Spring 的版本要求会高一点。受 《Spring 实战》一书的影响，我倾向于 Java 写法（由于项目是基于 Spring 3.0.5，因此还是需要写一点 XML）。</p>
<h3 id="写法一"><a href="#写法一" class="headerlink" title="写法一"></a>写法一</h3><h4 id="后端部分"><a href="#后端部分" class="headerlink" title="后端部分"></a>后端部分</h4><p>假设创建的 AOP 类为 <code>DemoAspect</code>，在 Spring 的配置文件中，将其注册到 aop 配置中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demoAspect"</span> <span class="attr">class</span>=<span class="string">"com.isudox.aspect.DemoAspect"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">aop:include</span> <span class="attr">name</span>=<span class="string">"demoAspect"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></div></pre></td></tr></table></figure>
<p>把流程改造相关的服务 bean 再次声明一份，修改其 id 和新流程的分组，以作为新流程所需服务的 bean（配置就省略了）。下面用 Java 的方式来声明切面和织入的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoAspect</span> </span>&#123;</div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> CartService cartService2;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"bean(cartService)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">advice</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        Object result;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            MethodSignature signature = (MethodSignature) joinPoint.getSignature();</div><div class="line">            Method method = signature.getMethod();</div><div class="line">            String clazz = method.getDeclaringClass().getSimpleName();</div><div class="line">            Object[] args = joinPoint.getArgs();</div><div class="line">            <span class="keyword">if</span> (...) &#123;</div><div class="line">                <span class="comment">// 新的流程</span></div><div class="line">                BeanClass bean = getBean();</div><div class="line">                result = method.invoke(bean, args);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 既定流程</span></div><div class="line">                result = joinPoint.proceed();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>思路很简单，<code>@Aspect</code> 注解将 DemoAspect 声明为一个 Aspect，<code>@Around(&quot;bean(cartService)&quot;)</code> 注解则将织入方法 <code>advice</code> 声明为织入名为 cartService 的 bean 的方法，意在运行时修改 cartService 里所有方法的行为。</p>
<h4 id="前端部分"><a href="#前端部分" class="headerlink" title="前端部分"></a>前端部分</h4><p>虽然后端完成了对流程调用的拆分，但是前端是复用的同一个工程，也就是说，还需要对来自同一个页面的请求进行分离，这样才能在上面的 Java 代码中完成 <code>if-else</code> 条件。具体就是区别哪些请求是调用原有的购物流程，哪些请求是调用新的预约流程。</p>
<p>思路很简单，先在页面模板上种下一个隐藏域作为不同业务流程的区分，如果业务是预约流程，就拦截所有来自这个页面的 Ajax 请求，修改其请求参数，然后再放行。其实就是前端的拦截器，而 jQuery 自带能拦截 Ajax 请求的神器方法—— <code>jQuery.ajaxPrefilter()</code>，参考 jQuery 的 API <a href="http://api.jquery.com/jquery.ajaxprefilter/" target="_blank" rel="external">文档</a>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$.ajaxPrefilter(<span class="function"><span class="keyword">function</span>(<span class="params">options, originalOptions, jqXHR</span>) </span>&#123;</div><div class="line">  <span class="comment">// Modify options, control originalOptions, store jqXHR, etc</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>jQuery.ajaxPrefilter()</code> 必须传入一个 <code>handler</code> 函数，用来完成对被拦截到的 Ajax 请求的自定义。<code>handler</code> 方法内包含 3 个参数：</p>
<ul>
<li><code>option</code> 从请求中获取到的参数字典；</li>
<li><code>originalOptions</code> 是原始传给 <code>$.ajax()</code> 方法的字典对象，没有被修改过，也就是说，不包含由 <code>$.ajaxSetup</code> 设置的参数（如果有的话）；</li>
<li><code>jqXHR</code> 是请求的 jqXHR 对象；</li>
</ul>
<p>所以，前端的 Ajax 请求拦截器可以这么写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 拦截 Ajax 请求，并修改请求参数，再放行</span></div><div class="line">$.ajaxPrefilter(<span class="function"><span class="keyword">function</span> (<span class="params">options, originalOptions, jqXHR</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> ($(<span class="string">'#hidden_type'</span>).val() === <span class="string">'xyz'</span>) &#123;</div><div class="line">        options.data += <span class="string">'&amp;type=xyz'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面还提到了 <code>$.ajaxSetup</code> 方法，它和 <code>$.ajaxPrefilter</code> 的区别可以参考 stackoverflow 上的这篇问答 <a href="http://stackoverflow.com/questions/29843732/ajaxprefilter-vs-ajaxsetup-jquery-ajax" target="_blank" rel="external">$.ajaxPrefilter() Vs $.ajaxSetup() - jQuery Ajax</a>。简单总结下，<code>$.ajaxSetup</code> 用来对页面上的 Ajax 请求设置预设值，比如预设 url 参数，这是在 Ajax 请求发出前；<code>$.ajaxPrefilter</code> 用来修改页面上的 Ajax 请求里的参数，比如像上面一个增加一个参数，这是在请求发出后。这有点类似单元测试里的 <code>setup()</code> 和 <code>tear_down()</code>。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;双十一前遭到产品突袭，要把非自营商家的处方药购买流程改为预约流程（出于某种考虑），内心一万只草泥马呼啸而过，那么多接口只给几天时间怎么改的过来……好在需要调用的购物车服务已经为新的预约流程分离了单独的 Redis 存储分组，要做的工作就是在恰当的时候调用恰当的服务。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Java" scheme="https://isudox.com/tags/Java/"/>
    
      <category term="Spring" scheme="https://isudox.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>JUnit + Mockito 单元测试的风云际会</title>
    <link href="https://isudox.com/2016/10/10/unit-test-with-junit-mockito/"/>
    <id>https://isudox.com/2016/10/10/unit-test-with-junit-mockito/</id>
    <published>2016-10-10T14:12:35.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://junit.org/junit4/" target="_blank" rel="external">JUnit</a> 是 2015 年 Java 开发者引用最多的库，是 Java 单元测试框架里无可争议的 No.1。JUnit 基本上能覆盖大部分接口的测试，但如果待测接口依赖外部服务，比如我之前写的这篇<a href="/2016/08/03/imitate-rpc-invoke-locally-by-spring-aop">小文</a>里描述的情况，JUnit 就可能捉襟见肘了。而 <a href="http://mockito.org/" target="_blank" rel="external">Mockito</a> 在 Mock 数据方面功能强大，正好弥补了 JUnit 在这方面的不足。风云合璧，摩诃无量。</p>
<a id="more"></a>
<p>上面其实已经点到 JUnit 和 Mockito 的不同了，虽然二者都是运用在单元测试中，但 JUnit 侧重对接口的运行状态和结果的测试，而 Mockito 侧重 “Mock” 数据，即对对象的模拟，尤其是不容易构造的复杂对象。</p>
<p>JUnit + Mockito 组合的优势是显而易见的，对于服务化的系统，有了这个组合，就能实现各上下游模块并行开发，同时进行单元测试验证可用性，减少串行联调的时间。</p>
<h3 id="JUnit"><a href="#JUnit" class="headerlink" title="JUnit"></a>JUnit</h3><blockquote>
<p>PS: 虽然 <a href="http://junit.org/junit5/" target="_blank" rel="external">JUnit5</a> 已经发布，但目前使用最多的还是 JUnit4，所以本文仍然基于 JUnit4。</p>
</blockquote>
<p>利用 Maven 初始化一个简单的 Java 应用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn archetype:generate -DgroupId=com.isudox -DartifactId=test-demo -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false</div></pre></td></tr></table></figure>
<p>Maven 会自动创建好类文件和测试类，路径如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">test-demo</div><div class="line">├── pom.xml       ---- pom 依赖配置文件</div><div class="line">└── src           ---- 源码路径</div><div class="line">    ├── main      ---- 类文件</div><div class="line">    │   └── java</div><div class="line">    │       └── com</div><div class="line">    │           └── isudox</div><div class="line">    │               └── App.java</div><div class="line">    └── test      ---- 测试类</div><div class="line">        └── java</div><div class="line">            └── com</div><div class="line">                └── isudox</div><div class="line">                    └── AppTest.java</div></pre></td></tr></table></figure>
<p>在 pom.xml 中引入 JUnit4，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- junit4 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>引入 JUnit 依赖后，就能在测试类中，通过 JUnit 提供的注解和静态方法，对接口进行测试了。先编写一个简单的待测试类 Calculator.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// App.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Calculator</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">evaluate</span><span class="params">(String expression)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (expression == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"null value"</span>);</div><div class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (String summand: expression.split(<span class="string">"\\+"</span>))</div><div class="line">            sum += Integer.valueOf(summand);</div><div class="line">        <span class="keyword">return</span> sum;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在 src/test/ 路径下创建同样的包，将测试类命名为 CalculatorTest.java，如果是用 IntelliJ IDEA，可以直接在待测试类下通过快捷键 Ctrl+Shift+T 生成对应的测试类——</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CalculatorTest.java</span></div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculatorTest</span> </span>&#123;</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evaluate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Calculator calculator = <span class="keyword">new</span> Calculator();</div><div class="line">        <span class="keyword">int</span> sum = calculator.evaluate(<span class="string">"1+2+3"</span>);</div><div class="line">        assertEquals(<span class="number">6</span>, sum);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行 <code>mvn test</code>，反馈得接口运行正确。<br>在上面这段简单的代码里，引入了 JUnit 的 <code>@Test</code> 注解和 <code>Assert</code> 下的系列静态断言方法。其中 <code>@Test</code> 注解把方法包装为测试方法，<code>assertEquals</code> 方法用来断言两个入参是否一致。通过这个简单的例子就实现了对待测方法的测试。</p>
<p>JUnit 支持丰富的测试规则，除了 <code>@Test</code> 注解外，还有下面这些注解——</p>
<ul>
<li><code>@Before</code> 注解的作用是使被标记的方法在测试类里每个方法执行前调用；同理 <code>After</code> 使被标记方法在当前测试类里每个方法执行后调用。</li>
<li><code>@BeforeClass</code> 注解的作用是使被标记的方法在当前测试类被实例化前调用；同理 <code>@AfterClass</code> 使被标记的方法在测试类被实例化后调用。</li>
<li><code>@Ignore</code> 注解的作用是使被标记方法暂时不执行。</li>
</ul>
<p>参考下面这段代码的运行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.junit.*;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculatorTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CalculatorTest</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Constructor"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BeforeClass</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beforeThis</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"BeforeClass"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@AfterClass</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">afterThis</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"AfterClass"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Before</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Before"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@After</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"After"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evaluate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Calculator calculator = <span class="keyword">new</span> Calculator();</div><div class="line">        <span class="keyword">int</span> sum = calculator.evaluate(<span class="string">"1+2+3"</span>);</div><div class="line">        assertEquals(<span class="number">6</span>, sum);</div><div class="line">        System.out.println(<span class="string">"Test evaluate"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">idiot</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        assertTrue(<span class="keyword">true</span>);</div><div class="line">        System.out.println(<span class="string">"Test idiot"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Ignore</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ignoreMe</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Ignore"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试结果如下，从输出结果可以印证不同注解对执行顺序的影响：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">BeforeClass</div><div class="line">Constructor</div><div class="line">Before</div><div class="line">Test idiot</div><div class="line">After</div><div class="line">Constructor</div><div class="line">Before</div><div class="line">Test evaluate</div><div class="line">After</div><div class="line">AfterClass</div></pre></td></tr></table></figure>
<p>另外，每个测试方法执行时都会实例化一次测试类，JUnit 这样处理的原因是保证每个测试方法彼此独立互不干扰。</p>
<p>对于 <code>@Test</code> 注解标记的方法，<code>@Test</code> 支持两个参数的设置：<code>timeout</code> 和 <code>expected</code>。前者是设置待测方法的执行超时时间，后者是设置对待测方法期望的抛出异常。修改 <code>evaluate</code> 测试方法的注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>(timeout = <span class="number">100</span>, expected = Exception.class)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evaluate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Calculator calculator = <span class="keyword">new</span> Calculator();</div><div class="line">    <span class="keyword">int</span> sum = calculator.evaluate(<span class="keyword">null</span>);</div><div class="line">    assertEquals(<span class="number">6</span>, sum);</div><div class="line">    i++;</div><div class="line">    System.out.println(<span class="string">"Test evaluate "</span> + i);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Maven 运行测试，从结果可以看到，方法抛出了异常，测试通过。</p>
<h3 id="Mockito"><a href="#Mockito" class="headerlink" title="Mockito"></a>Mockito</h3><p>相对于 JUnit，Mockito 则是 Mock 数据的测试框架，它简化了对有外部依赖的类的单元测试。Mockito 的工作流程如下图示（<a href="http://www.vogella.com/tutorials/Mockito/article.html" target="_blank" rel="external">图片来源</a>）：</p>
<p><img src="https://o70e8d1kb.qnssl.com/mockito.webp" alt=""></p>
<p>首先在 pom.xml 中导入 mockito 依赖，</p>
<p>pom.xml 依赖中添加 Mockito：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mockito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mockito-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>再静态导入 <code>org.mockito.Mockito.*;</code> 里的静态方法，这样就能在测试方法进行对象的 Mock。Mockito 支持通过静态方法 <code>mock()</code> 来 Mock 对象，或者通过 <code>@Mock</code> 注解，来创建 Mock 对象，但必须将其实例化。先演示下如何 Mock 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.*;</div><div class="line"></div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mockIterator</span><span class="params">()</span> </span>&#123;</div><div class="line">    Iterator i = mock(Iterator.class);</div><div class="line">    when(i.next()).thenReturn(<span class="string">"hello"</span>).thenReturn(<span class="string">"world"</span>);</div><div class="line">    String result = i.next() + <span class="string">" "</span> + i.next();</div><div class="line">    assertEquals(<span class="string">"hello world"</span>, result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mock 出来的对象拥有和源对象同样的方法和属性，<code>when()</code> 和 <code>thenReturn()</code> 方法是对源对象的配置，怎么理解，就是说在第一步 <code>mock()</code> 时，mock 出来的对象还不具备被 Mock 对象实例的行为特征，而 <code>when(...).thenReturn(...)</code> 就是根据条件去配置源对象的预期行为，即：当执行 <code>when()</code> 中的操作时，返回 <code>thenReturn()</code> 中的结果。比如上面的代码中，mock 出来的 <code>i</code> 实例在被遍历时会依次输出 “hello” 和 “world”，<code>assertEquals()</code> 就是对预期结果和实际结果的判断。</p>
<p>同理，也可以 Mock 网络请求，比如 <code>HttpServletRequest</code> 里的参数，也可以通过上面的方式来设定被 Mock 的源对象的表现行为。</p>
<p>对于 <code>when()</code> 不定条件，Mockito 定义了 <code>any()</code>、 <code>anyInt()</code>、<code>anyString()</code>、<code>anySet()</code> 等方法来匹配指定类型的不定输入，<code>anyInt()</code> 匹配 int 参数，<code>anyString()</code> 匹配 String 参数, <code>any()</code> 匹配 任意类型的参数。如果需要匹配自定义的类型，可以通过 <code>any(CustomedClass.class)</code> 来配置。</p>
<p><code>thenReturn()</code> 返回的是一个确定值，这在模拟可见的行为时是没问题的，但有时候，我们需要得到一个复杂的不定输出的行为，比如返回一个回调方法，或者返回一个类实例，Mockito 可以通过 <code>thenAnswer()</code> 来实现。参考 StackOverflow 上的这篇问答 <a href="http://stackoverflow.com/questions/36615330/mockito-thenanswer-vs-thenreturn" target="_blank" rel="external">Mockito : thenAnswer Vs thenReturn</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Duplicator counter = mock(Counter.class);</div><div class="line">    Answer&lt;Integer&gt; answer = <span class="keyword">new</span> Answer&lt;Integer&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">answer</span><span class="params">(InvocationOnMock invocationOnMock)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="keyword">return</span> ((String) invocationOnMock.getArguments()[<span class="number">0</span>]).length();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    when(counter.count(anyString())).thenAnswer(answer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>InvocationOnMock</code> 接口提供了获取被测试方法的调用信息的几个重要方法：</p>
<ul>
<li><code>getMock()</code> 接口返回 mock 对象；</li>
<li><code>getMethod()</code> 接口返回被调用方法的 Method 对象；</li>
<li><code>getArguments()</code> 接口返回被测试方法的入参列表；</li>
<li><code>getArgument()</code> 接口返回北侧方法指定位置的入参；</li>
<li><code>callRealMethod()</code> 接口返回实际的调用方法；</li>
</ul>
<p>上面的例子已经说明了 Mockito 能跟踪被 Mock 对象所有的方法调用和它们的入参。除了对方法调用结果是否正确的测试，有时还需要验证一些方法的行为，比如验证方法被调用的次数，验证方法的入参等，Mockito 通过 <code>verify()</code> 方法实现这些场景的测试需求。这被称为“行为测试”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVerify</span><span class="params">()</span> </span>&#123;</div><div class="line">    Duplicator mock = mock(Duplicator.class);</div><div class="line">    when(mock.getUniqueId()).thenReturn(<span class="number">43</span>);</div><div class="line"></div><div class="line">    mock.duplicate(<span class="string">"Halo"</span>);</div><div class="line">    mock.getUniqueId();</div><div class="line">    mock.getUniqueId();</div><div class="line"></div><div class="line">    verify(mock).duplicate(Matchers.eq(<span class="string">"Halo"</span>));</div><div class="line">    verify(mock, times(<span class="number">2</span>)).getUniqueId();</div><div class="line">    verify(mock, never()).someMethod();</div><div class="line">    verify(mock, atLeastOnce()).someMethod();</div><div class="line">    verify(mock, atLeast(<span class="number">2</span>)).someMethod();</div><div class="line">    verify(mock, atMost(<span class="number">3</span>)).someMethod();;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>verify()</code> 内的条件设置简洁明了，第一个参数是 mock 对象，第二个参数可选，作为状语描述，从方法的名称上就能知道具体的用法，不多赘述了。</p>
<p>Mockito 支持通过 <code>@Spy</code> 注解或 <code>spy()</code> 方法包裹实际对象，除非明确指定对象，否则都会调用包裹后的对象。这种方式实现了对实际对象的部分自定义修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSpy</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; spyList = spy(<span class="keyword">new</span> ArrayList&lt;String&gt;());</div><div class="line"></div><div class="line">    assertEquals(<span class="number">0</span>, spyList.size());</div><div class="line"></div><div class="line">    doReturn(<span class="number">100</span>).when(spyList).size();</div><div class="line">    assertEquals(<span class="number">100</span>, spyList.size());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的测试代码中，<code>spy()</code> 修改了 <code>ArrayList</code> 对象的 <code>size()</code>。但是如果只是在执行某个操作是返回一个期望值，用之前的 <code>mock()</code> 也能实现，<code>spy()</code> 存在的理由是什么，看下面的代码能解释二者之间的差异：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">differMockSpy</span><span class="params">()</span> </span>&#123;</div><div class="line">    List mock = mock(ArrayList.class);</div><div class="line">    mock.add(<span class="string">"one"</span>);</div><div class="line">    verify(mock).add(<span class="string">"one"</span>);</div><div class="line">    assertEquals(<span class="number">0</span>, mock.size());</div><div class="line"></div><div class="line">    List spy = spy(<span class="keyword">new</span> ArrayList());</div><div class="line">    spy.add(<span class="string">"one"</span>);</div><div class="line">    verify(spy).add(<span class="string">"one"</span>);</div><div class="line">    assertEquals(<span class="number">1</span>, spy.size());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的运行结果可以看出，<code>mock()</code> 传入的是类，创建出来的是一个裸的实例，只是为了跟踪该实例下的方法调用，而不会对实例有其他副作用产生；而 <code>spy()</code> 传入的是类实例，它会对该实例进行包裹，创建出来的实例和源实例相同，唯一的不同在于，<code>spy()</code> 包裹后的实例可以对实例内部进行自定义的改动。</p>
<p>对于依赖注入，Mockito 支持通过 <code>@InjectMocks</code> 注解将被标记的对象自动注入，其依赖会由 mock 出来的对象实例来填充。Mockito 会依次尝试通过 constructor injection、 property injection 和 filed injection，注意，如果其中任一注入策略失败，Mockito 也不会报告错误，就必须自行解决依赖。</p>
<ul>
<li><strong>Constructor injection</strong>：<code>@InjectMocks</code> 优先选择的注入策略，如果对象通过构造函数成功 mock 出来，则不会再进行后面的注入策略。</li>
<li><strong>Property setter injection</strong>：会首先根据属性的类型（如果类型匹配则忽略变量名），如果有多个匹配项，则选择 mock 名和属性名相同的变量进行注入。</li>
<li><strong>Field injection</strong>：同样首先根据域的类型（如果类型匹配则忽略变量名），如果有多个匹配项，则选择 mock 名和域名相同的变量进行注入。</li>
</ul>
<p>参考下面的样例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleManagerTest</span> <span class="keyword">extends</span> <span class="title">SampleBaseTestCase</span> </span>&#123;</div><div class="line">    <span class="meta">@Mock</span></div><div class="line">    <span class="keyword">private</span> ArticleCalculator calculator;</div><div class="line">    <span class="meta">@Mock</span>(name = <span class="string">"database"</span>)</div><div class="line">    <span class="keyword">private</span> ArticleDatabase dbMock; <span class="comment">// note the mock name attribute</span></div><div class="line">    <span class="meta">@Spy</span></div><div class="line">    <span class="keyword">private</span> UserProvider userProvider = <span class="keyword">new</span> ConsumerUserProvider();</div><div class="line"></div><div class="line">    <span class="meta">@InjectMocks</span></div><div class="line">    <span class="keyword">private</span> ArticleManager manager;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shouldDoSomething</span><span class="params">()</span> </span>&#123;</div><div class="line">        manager.initiateArticle();</div><div class="line">        verify(database).addListener(any(ArticleListener.class));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleBaseTestCase</span> </span>&#123;</div><div class="line">    <span class="meta">@Before</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMocks</span><span class="params">()</span> </span>&#123;</div><div class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中，<code>@InjectMocks</code> 注解会把 mock 出来的 <code>dbMock</code> 和 <code>calculator</code> 注入进 <code>manager</code> 中。<code>ArticleManager</code> 可以只有一个有参构造函数，或者只有无参构造器，或者都有。需要注意的是，Mockito 无法实例化 inner class、local class、abstract class 和 interface。</p>
<p>对需要注入的域，Constructor injection 会发生在下面的代码中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleManager</span> </span>&#123;</div><div class="line">    ArticleManager(ArticleCalculator calculator, ArticleDatabase database) &#123;</div><div class="line">        <span class="comment">// parameterized constructor</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Property setter injection 在下面的代码中完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleManager</span> </span>&#123;</div><div class="line">    <span class="comment">// no-arg constructor</span></div><div class="line">    ArticleManager() &#123;  &#125;</div><div class="line"></div><div class="line">    <span class="comment">// setter</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDatabase</span><span class="params">(ArticleDatabase database)</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">    <span class="comment">// setter</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCalculator</span><span class="params">(ArticleCalculator calculator)</span> </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Field injection：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ArticleDatabase database;</div><div class="line">    <span class="keyword">private</span> ArticleCalculator calculator;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>参考资料：</p>
<ul>
<li><a href="https://github.com/junit-team/junit4/wiki" target="_blank" rel="external">JUnit4 Wiki</a></li>
<li><a href="https://github.com/mockito/mockito/wiki" target="_blank" rel="external">Mockito Wiki</a></li>
<li><a href="https://dzone.com/articles/getting-started-mocking-java" target="_blank" rel="external">Getting Started with Mocking in Java using Mockit</a></li>
<li><a href="http://www.vogella.com/tutorials/Mockito/article.html" target="_blank" rel="external">Unit tests with Mockito - Tutorial</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://junit.org/junit4/&quot;&gt;JUnit&lt;/a&gt; 是 2015 年 Java 开发者引用最多的库，是 Java 单元测试框架里无可争议的 No.1。JUnit 基本上能覆盖大部分接口的测试，但如果待测接口依赖外部服务，比如我之前写的这篇&lt;a href=&quot;/2016/08/03/imitate-rpc-invoke-locally-by-spring-aop&quot;&gt;小文&lt;/a&gt;里描述的情况，JUnit 就可能捉襟见肘了。而 &lt;a href=&quot;http://mockito.org/&quot;&gt;Mockito&lt;/a&gt; 在 Mock 数据方面功能强大，正好弥补了 JUnit 在这方面的不足。风云合璧，摩诃无量。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Java" scheme="https://isudox.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>读 Flask 源码：Context</title>
    <link href="https://isudox.com/2016/10/02/flask-context-guide/"/>
    <id>https://isudox.com/2016/10/02/flask-context-guide/</id>
    <published>2016-10-02T12:11:40.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>Flask Context 类似 Spring 框架的核心组件 Context，给应用程序提供运行时所需的环境（包含状态、变量等）的快照。如果程序本身就包含了运行所需的完备条件，那么它可以独立运行了；如果程序需要外部环境的支持，Context 的存在就有意义。比如 Flask Web 开发中常用的 <code>current_app</code>、<code>request</code> 都是 Context，可以在不同方法中调用，并且实现通信及交互。</p>
<a id="more"></a>
<h3 id="Context-的实现"><a href="#Context-的实现" class="headerlink" title="Context 的实现"></a>Context 的实现</h3><p>Flask 提供了 4 个 Context：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Context</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">flask.current_app</td>
<td style="text-align:center">Application Context</td>
<td style="text-align:center">当前 app 的实例对象</td>
</tr>
<tr>
<td style="text-align:center">flask.g</td>
<td style="text-align:center">Application Context</td>
<td style="text-align:center">处理请求时用作临时存储的对象</td>
</tr>
<tr>
<td style="text-align:center">flask.request</td>
<td style="text-align:center">Request Context</td>
<td style="text-align:center">封装了 HTTP 请求中的内容</td>
</tr>
<tr>
<td style="text-align:center">flask.session</td>
<td style="text-align:center">Request Context</td>
<td style="text-align:center">存储了用户回话</td>
</tr>
</tbody>
</table>
<p>这些 Context 分为 Application Context 和 Request Context 两类：</p>
<ul>
<li>Application Context: 是提供给由 <code>app = Flask(__name__)</code> 所创建的 Flask app 的 Context；</li>
<li>Request Context: 是客户端发起 HTTP 请求时，Flask 对象为 HTTP 请求对象所创建的 Context；</li>
</ul>
<p>这些 Context 定义在 Flask 源码（v0.11）的 <code>global.py</code> 中，截取部分源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalStack, LocalProxy</div><div class="line"></div><div class="line">_request_ctx_stack = LocalStack()</div><div class="line">_app_ctx_stack = LocalStack()</div></pre></td></tr></table></figure>
<p><code>_request_ctx_stack</code> 和 <code>_app_ctx_stack</code> 分别是 Flask 保存 request context 和 application context 的全局栈，由 Werkzeug 库的 <code>LocalStack</code> 和 <code>LocalProxy</code> 创建实例。</p>
<h4 id="LocalStack-和-LocalProxy"><a href="#LocalStack-和-LocalProxy" class="headerlink" title="LocalStack 和 LocalProxy"></a>LocalStack 和 LocalProxy</h4><p>在认识 LocalStack 之前，先来了解 <code>local.py</code> 中的 Local 类，Local 类内由 <code>__slots__</code> 确定了唯二两个属性：<code>__storage__</code> 和 <code>__ident_func__</code>，其中，<code>__ident_func__</code> 属性是获取当前线程标识符的方法调用，<code>__storage__</code> 属性是字典，其 key 就是当前线程的标识符。参看源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># werkzeug.local.Local</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span><span class="params">(object)</span>:</span></div><div class="line">    __slots__ = (<span class="string">'__storage__'</span>, <span class="string">'__ident_func__'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        object.__setattr__(self, <span class="string">'__storage__'</span>, &#123;&#125;)</div><div class="line">        object.__setattr__(self, <span class="string">'__ident_func__'</span>, get_ident)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self.__storage__[self.__ident_func__()][name]</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">raise</span> AttributeError(name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></div><div class="line">        ident = self.__ident_func__()</div><div class="line">        storage = self.__storage__</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            storage[ident][name] = value</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            storage[ident] = &#123;name: value&#125;</div></pre></td></tr></table></figure>
<p>LocalStack 类内置的 <code>_local</code> 是 Local 类的实例，总体作用和 Local 类似。不同之处在于，LocalStack “自作主张”的在 <code>__storage__</code> 的 value 内维护一个名为 “stack” 的栈， 可以通过 <code>push</code>、<code>pop</code> 和 <code>top</code> 将对象入栈、出栈和取得栈顶元素。源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># werkzeug.local.LocalStack</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._local = Local()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, obj)</span>:</span></div><div class="line">        rv = getattr(self._local, <span class="string">'stack'</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            self._local.stack = rv = []</div><div class="line">        rv.append(obj)</div><div class="line">        <span class="keyword">return</span> rv</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></div><div class="line">        stack = getattr(self._local, <span class="string">'stack'</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> stack <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">elif</span> len(stack) == <span class="number">1</span>:</div><div class="line">            release_local(self._local)</div><div class="line">            <span class="keyword">return</span> stack[<span class="number">-1</span>]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> stack.pop()</div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self._local.stack[<span class="number">-1</span>]</div><div class="line">        <span class="keyword">except</span> (AttributeError, IndexError):</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure>
<p>LocalStack 的使用非常简单，简单的示例如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; ls = LocalStack()</div><div class="line">&gt;&gt;&gt; ls.push(42)</div><div class="line">&gt;&gt;&gt; ls.top</div><div class="line">42</div><div class="line">&gt;&gt;&gt; ls.push(23)</div><div class="line">&gt;&gt;&gt; ls.top</div><div class="line">23</div><div class="line">&gt;&gt;&gt; ls.pop()</div><div class="line">23</div><div class="line">&gt;&gt;&gt; ls.top</div><div class="line">42</div></pre></td></tr></table></figure>
<p>LocalProxy 类是 werkzeug local 的代理，LocalProxy 类的构造函数必须传入一个可调用的参数（方法），通过调用得到的结果就是 LocalStack 实例化的栈的栈顶元素。<code>__local</code> 就是被代理的对象，对 LocalProxy 对象的操作都会作用于实际被代理的对象上。参考源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># werkzeug.local.LocalProxy</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalProxy</span><span class="params">(object)</span>:</span></div><div class="line">    __slots__ = (<span class="string">'__local'</span>, <span class="string">'__dict__'</span>, <span class="string">'__name__'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, local, name=None)</span>:</span></div><div class="line">        object.__setattr__(self, <span class="string">'_LocalProxy__local'</span>, local)</div><div class="line">        object.__setattr__(self, <span class="string">'__name__'</span>, name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_current_object</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self.__local, <span class="string">'__release_local__'</span>):</div><div class="line">            <span class="keyword">return</span> self.__local()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> getattr(self.__local, self.__name__)</div><div class="line">        <span class="keyword">except</span> AttributeError:</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'no object bound to %s'</span> % self.__name__)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">if</span> name == <span class="string">'__members__'</span>:</div><div class="line">            <span class="keyword">return</span> dir(self._get_current_object())</div><div class="line">        <span class="keyword">return</span> getattr(self._get_current_object(), name)</div></pre></td></tr></table></figure>
<h4 id="request-和-session"><a href="#request-和-session" class="headerlink" title="request 和 session"></a>request 和 session</h4><p>Flask 对 <code>request</code> 的定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_req_object</span><span class="params">(name)</span>:</span></div><div class="line">    top = _request_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_request_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> getattr(top, name)</div><div class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">'request'</span>))</div></pre></td></tr></table></figure>
<p>由偏函数 <code>partial()</code> 将属性名 “request” 传入 <code>_lookup_req_object()</code> 得到可调用的方法，该方法的执行结果就是 LocalProxy 代理的 <code>_request_ctx_stack</code> 栈顶元素 <code>RequestContext</code> 实例。</p>
<p><code>RequestContext</code> 包含了 Request 的所有相关信息，它在请求开始时被创建并被推入到 <code>_request_ctx_stack</code> 栈中，在请求结束后出栈。<br>参考源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># flask.ctx.RequestContext</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, environ, request=None)</span>:</span></div><div class="line">        self.app = app</div><div class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            request = app.request_class(environ)</div><div class="line">        self.request = request</div><div class="line">        self.session = <span class="keyword">None</span></div><div class="line">        self._implicit_app_ctx_stack = []</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""部分省略"""</span></div><div class="line">        app_ctx = _app_ctx_stack.top</div><div class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> app_ctx.app != self.app:</div><div class="line">            app_ctx = self.app.app_context()</div><div class="line">            app_ctx.push()</div><div class="line">            self._implicit_app_ctx_stack.append(app_ctx)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._implicit_app_ctx_stack.append(<span class="keyword">None</span>)</div><div class="line">        </div><div class="line">        _request_ctx_stack.push(self)</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self, exc=_sentinel)</span>:</span></div><div class="line">        <span class="string">"""省略"""</span></div></pre></td></tr></table></figure>
<p>这里需要留意 <code>push()</code> 方法，它首先会找出 <code>_app_ctx_stack</code> 栈顶元素 <code>AppContext</code>，如果栈顶元素为空，或者当前 app 不是栈顶 Context 所属的 app（AppContext 对应所属的 Flask app，这种情况存在于 Flask 应用包含多个 app 时），则将当前的 <code>AppContext</code> 入栈到当前 app 的 <code>_app_ctx_stack</code> 中，之后再将 <code>RequestContext</code> 入栈到 <code>_request_ctx_stack</code> 栈中。这就完成了 Request Context 和 Application Context 的关联。</p>
<p>RequestContext 中 <code>session</code> 初始化为 <code>None</code>，当 RequestContext 入栈时，<code>session</code> 被赋值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># flask.ctx.RequestContext</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""部分省略"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, environ, request=None)</span>:</span></div><div class="line">        self.session = <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></div><div class="line">        self.session = self.app.open_session(self.request)</div><div class="line">        <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            self.session = self.app.make_null_session()</div></pre></td></tr></table></figure>
<p><code>app.open_session()</code> 方法会通过 Flask app 从 <code>SecureCookieSessionInterface</code> 实例中打开或创建 session。</p>
<p>正因为 <code>request</code> 和 <code>session</code> 都是 RequestContext 的属性，所以是由如下方式从 Flask app 中获取：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># flask.globals</span></div><div class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">'request'</span>))</div><div class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">'session'</span>))</div></pre></td></tr></table></figure>
<p>偏函数 <code>partial</code> 把属性名传入可调用的 <code>_lookup_req_object</code> 方法中，分别得到当前 Flask app 的 RequestContext 实例中的 <code>request</code> 和 <code>session</code>。</p>
<h4 id="current-app-和-g"><a href="#current-app-和-g" class="headerlink" title="current_app 和 g"></a>current_app 和 g</h4><p>继续看 <code>flask.local</code> 中对 <code>current_app</code> 的定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span><span class="params">()</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> top.app</div><div class="line"></div><div class="line">current_app = LocalProxy(_find_app)</div></pre></td></tr></table></figure>
<p><code>current_app</code> 是通过 LocalProxy 获取代理的 application request 的栈顶对象。先对它做一个试验：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, current_app</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line">print(current_app.name)</div></pre></td></tr></table></figure>
<p>运行后会抛出 “RuntimeError: Working outside of application context.” 的异常，这是因为在创建 Flask App 时，<code>AppContext</code> 还没有压入到 <code>_app_ctx_stack</code> 栈内，栈顶没有元素，所以需要先做入栈操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app_ctx = app.app_context()  <span class="comment"># 手动创建 AppContext</span></div><div class="line">app_ctx.push()  <span class="comment"># 把 AppContext 入栈到 _app_ctx_stack</span></div><div class="line">print(current_app.name)</div><div class="line">app_ctx.pop()  <span class="comment"># 从 _app_ctx_stack 出栈</span></div></pre></td></tr></table></figure>
<p>但实际开发中，我们并没有人为的去对 <code>_app_ctx_stack</code> 进行入栈出栈操作，那么栈内元素是什么时候入栈的呢？其实之前在分析 RequestContext 时已经涉及到了，因为当请求到达 Flask 应用时，会自动将 Request Context 推入到 <code>_request_ctx_stack</code>，因为 Request Context 必须是和 Application Context 关联，即必须在后者的生命周期内，因此如果 <code>_app_ctx_stack</code> 为空，会隐式的把 AppContext 入栈。</p>
<p>再看 <code>g</code> 的定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># flask.globals</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_app_object</span><span class="params">(name)</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> getattr(top, name)</div><div class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">'g'</span>))</div></pre></td></tr></table></figure>
<p><code>g</code> 其实就是通过 LocalProxy 代理得到 <code>_app_ctx_stack</code> 栈顶元素 AppContext 内属性为 “g” 的对象。从 <code>flask.ctx</code> 中回溯对属性 “g” 的定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># flask.ctx.AppContext</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppContext</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app)</span>:</span></div><div class="line">        self.g = app.app_ctx_globals_class()</div></pre></td></tr></table></figure>
<p>属性 “g” 是由 Flask app 调用 <code>app_ctx_globals_class()</code> 赋值，继续回溯源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># flask.app.Flask</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></div><div class="line">    app_ctx_globals_class = _AppCtxGlobals</div></pre></td></tr></table></figure>
<p><code>_AppCtxGlobals</code> 是字典集合，保存了 <code>flask.g</code> 的信息。</p>
<p>这里需要插播一条贴士，在 Flask 0.9 里，<code>flask.g</code> 是通过 <code>request_globals_class</code> 获取，而从 0.10 开始，改为 <code>app_ctx_globals_class</code>，因为 <code>flask.g</code> 变成了 Application Context。</p>
<p>另外，在 RequestContext 中，还拥有 <code>flask.g</code> 的 getter 和 setter：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># flask.ctx.RequestContext</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_g</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> _app_ctx_stack.top.g</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set_g</span><span class="params">(self, value)</span>:</span></div><div class="line">        _app_ctx_stack.top.g = value</div><div class="line">    g = property(_get_g, _set_g)</div><div class="line">    <span class="keyword">del</span> _get_g, _set_g</div></pre></td></tr></table></figure>
<p>也就是说，在每次客户端请求时，生成的 RequestContext 都可以对 <code>flask.g</code> 进行读写，因此在每次处理请求时，<code>flask.g</code> 可以作为临时存储的对象。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>啰啰嗦嗦抄了一大堆源码，写了一大堆废话，归结下来其实就几条结论——</p>
<p>AppContext 是基于 <code>app = Flask(__name__)</code> 创建的 Flask app 层面上的 Context。对于同一个 Flask app 下的成员，都拥有同一个 AppContext。</p>
<p>RequestContext 的生命周期在 AppContext 生命周期内，每个请求都会生成一个 RequestContext，不同的 RequestContext 对应一个 AppContext。</p>
<p>RequestContext 内维护一个 <code>request</code> 属性，即 <code>flask.request</code> 对象。也就是说，每次 HTTP 请求都会新创建一个 <code>flask.request</code>，本质上就是 <code>flask.app.Request</code> 对象。</p>
<hr>
<p>参考资料：</p>
<ul>
<li>Flask Docs</li>
<li>Python Web 开发实战（董伟明）</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flask Context 类似 Spring 框架的核心组件 Context，给应用程序提供运行时所需的环境（包含状态、变量等）的快照。如果程序本身就包含了运行所需的完备条件，那么它可以独立运行了；如果程序需要外部环境的支持，Context 的存在就有意义。比如 Flask Web 开发中常用的 &lt;code&gt;current_app&lt;/code&gt;、&lt;code&gt;request&lt;/code&gt; 都是 Context，可以在不同方法中调用，并且实现通信及交互。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Python" scheme="https://isudox.com/tags/Python/"/>
    
      <category term="Flask" scheme="https://isudox.com/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>跨域请求之 JSONP 和 CORS</title>
    <link href="https://isudox.com/2016/09/24/cross-site-jsonp-and-cors/"/>
    <id>https://isudox.com/2016/09/24/cross-site-jsonp-and-cors/</id>
    <published>2016-09-24T15:55:52.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>Web 开发中，跨域请求是个经常碰到的问题，因为涉及到网站安全，所以浏览器是拒绝跨域请求的。通常解决跨域会采用 <a href="https://en.wikipedia.org/wiki/JSONP" target="_blank" rel="external">JSONP</a>(JSON with Padding) 和 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">CORS</a>(Cross-Origin Resource Sharing)。</p>
<a id="more"></a>
<p>首先理清一个经常会被混淆的概念，AJAX(Asynchronous JavaScript and XML) 和跨域请求是两个不同的概念，AJAX 是异步请求和解析处理 XML 文档的方式，它在服务器端没有提供支持（CORS 是一种解决方案）的前提下，也是无法跨域的。</p>
<h3 id="跨域请求"><a href="#跨域请求" class="headerlink" title="跨域请求"></a>跨域请求</h3><p>跨域请求，顾名思义，就是从 A 地址向非同源的 B 地址发起了请求。参考 MDN 上对同源的定义:</p>
<blockquote>
<p>如果两个页面拥有相同的协议（protocol），端口（如果指定）和主机，那么这两个页面就属于同一个源（origin）。</p>
</blockquote>
<p>MDN 给了同源检测的示例，如果是相对 <a href="http://store.company.com/dir/page.html，那么" target="_blank" rel="external">http://store.company.com/dir/page.html，那么</a></p>
<table>
<thead>
<tr>
<th style="text-align:center">URL</th>
<th style="text-align:center">结果</th>
<th style="text-align:center">原因</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="http://store.company.com/dir2/other.html" target="_blank" rel="external">http://store.company.com/dir2/other.html</a></td>
<td style="text-align:center">成功</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><a href="http://store.company.com/dir/inner/another.html" target="_blank" rel="external">http://store.company.com/dir/inner/another.html</a></td>
<td style="text-align:center">成功</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://store.company.com/secure.html" target="_blank" rel="external">https://store.company.com/secure.html</a></td>
<td style="text-align:center">失败</td>
<td style="text-align:center">协议不同</td>
</tr>
<tr>
<td style="text-align:center"><a href="http://store.company.com:81/dir/etc.html" target="_blank" rel="external">http://store.company.com:81/dir/etc.html</a></td>
<td style="text-align:center">失败</td>
<td style="text-align:center">端口不同</td>
</tr>
<tr>
<td style="text-align:center"><a href="http://news.company.com/dir/other.html" target="_blank" rel="external">http://news.company.com/dir/other.html</a></td>
<td style="text-align:center">失败</td>
<td style="text-align:center">主机名不同</td>
</tr>
</tbody>
</table>
<p>严格的说，浏览器并不是拒绝所有的跨域请求，否则如果想从百度搜索结果页跳转到其他页面就是个伪命题，实际上拒绝的是跨域的读操作。浏览器的同源限制策略是这样执行的：</p>
<ul>
<li>通常浏览器允许进行跨域写操作（Cross-origin writes），如链接，重定向；</li>
<li>通常浏览器允许跨域资源嵌入（Cross-origin embedding），如 <code>img</code>、<code>script</code> 标签；</li>
<li>通常浏览器不允许跨域读操作（Cross-origin reads）。</li>
</ul>
<p>对于跨域资源的嵌入，实际开发中用的非常频繁，从外部引入 js、css、img 这些静态文件，都是被浏览器接受的。</p>
<p>下面对浏览器的同源策略做个测试，探探究竟。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cross-origin request</span></div><div class="line"><span class="keyword">var</span> url = <span class="string">"http://search.jd.com/Search?keyword=python&amp;enc=utf-8&amp;wq=python"</span>;</div><div class="line"><span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">request.open(<span class="string">"GET"</span>, url);</div><div class="line">request.send(<span class="literal">null</span>);</div></pre></td></tr></table></figure>
<p>浏览器控制台会出现错误信息（信息中的 Origin 为 null 是因为我是用浏览器直接打开 html，而不是通过 http server 访问 html）：</p>
<blockquote>
<p>XMLHttpRequest cannot load <a href="http://search.jd.com/Search?keyword=python&amp;enc=utf-8&amp;wq=python" target="_blank" rel="external">http://search.jd.com/Search?keyword=python&amp;enc=utf-8&amp;wq=python</a>. No ‘Access-Control-Allow-Origin’ header is present on the requested resource. Origin ‘null’ is therefore not allowed access.</p>
</blockquote>
<p>该请求来源的 Origin 不在可允许范围内，这种情况就是跨域请求被拒。下面是一个简单的本地 http server：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// local http server writtern by Node.js</span></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> port = <span class="number">8080</span>; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleRequest</span>(<span class="params">request, response</span>)</span>&#123;</div><div class="line">    response.end(<span class="string">'Hello'</span>);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'request url: '</span> + request.url);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> server = http.createServer(handleRequest);</div><div class="line">server.listen(PORT, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Server listening on: http://localhost:%s"</span>, port);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>node simple-server.js</code> 运行，把请求的 URL 改成 <a href="http://localhost:8080，可以看到命令行终端输出日志，这就表明，请求实际上是从浏览器发出了，服务器也接收到了请求，但是浏览器在读取跨域返回的数据时被拒绝了。这就印证了" target="_blank" rel="external">http://localhost:8080，可以看到命令行终端输出日志，这就表明，请求实际上是从浏览器发出了，服务器也接收到了请求，但是浏览器在读取跨域返回的数据时被拒绝了。这就印证了</a> MDN 文档上说明的，浏览器不允许跨域读操作。</p>
<h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>JSONP 并不在 HTML 的标准里，而是开发者为了实现跨域请求而创造的一个 trick。在 HTML 中，可以通过 “src”、”img” 标签引入非同源的静态资源，这就给 JSONP 的实现提供了可能。</p>
<p>JSONP 的实现很简单，需要客户端和服务端配合。客户端在 HTML 中动态生成 <code>script</code> 标签，在 “src” 中引入请求的 URL + 回调函数，这样请求服务器返回的数据会交由回调函数处理，这样就实现了跨域读请求；服务端在接收到客户端请求后，首先取得客户端要回调的函数名，再生成 JavaScript 代码段返回给浏览器，浏览器在获取到返回结果后直接调用回调函数完成任务。</p>
<p>手写一段简陋的 JS 代码演示下 JSONP 的整个流程：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCallback</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(result.message);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> jsonp = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line"><span class="keyword">var</span> ele = <span class="built_in">document</span>.getElementById(<span class="string">'demo'</span>);</div><div class="line">jsonp.type = <span class="string">'text/javascript'</span>;</div><div class="line">jsonp.src = <span class="string">'http://localhost:8080?callback=handleCallback'</span>;</div><div class="line">ele.appendChild(jsonp);</div><div class="line">ele.removeChild(jsonp);</div></pre></td></tr></table></figure>
<p>JSONP 只支持 GET 请求，而且需要服务器端来配合，如果服务器端返回一段恶意代码，客户端也会毅然决然的执行……JSONP 是一个伟大的创造，但还不够好。</p>
<h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><p>CORS 是W3C 推荐的一种新的官方方案，能是服务器支持 XMLHttpRequest 的跨域请求。CORS 实现起来非常方便，只需要增加一些 HTTP 头，让服务器能声明允许的访问来源。</p>
<p>浏览器对 CORS 的使用场景做了区分，有简单请求和非简单请求之分。MDN 对简单请求的定义条件是：</p>
<ul>
<li>只使用 GET, HEAD 或者 POST 请求方法。如果使用 POST 向服务器端传送数据，则数据类型(Content-Type)只能是 application/x-www-form-urlencoded, multipart/form-data 或 text/plain中的一种；</li>
<li>不会使用自定义请求头；</li>
</ul>
<p>浏览器（支持 CORS）对简单的跨域请求，会在请求头里加上 <code>Origin</code> 字段，向服务器说明请求源信息，包括协议、域名和端口，由服务器判断请求源是否在允许的域中。</p>
<p>编写一个简单请求，跨域获取信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> url = <span class="string">"https://ipinfo.io/54.169.237.109/json?token=iplocation.net"</span>;</div><div class="line">$.ajax(&#123;</div><div class="line">    <span class="attr">url</span>: url</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>查看请求头信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Accept:*/*</div><div class="line">Accept-Encoding:gzip, deflate, sdch, br</div><div class="line">Accept-Language:zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4</div><div class="line">Cache-Control:max-age=0</div><div class="line">Connection:keep-alive</div><div class="line">DNT:1</div><div class="line">Host:ipinfo.io</div><div class="line">Origin:https://isudox.com</div><div class="line">Referer:https://isudox.com/test.html</div><div class="line">User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/52.0.2743.116 Chrome/52.0.2743.116 Safari/537.36</div></pre></td></tr></table></figure>
<p>浏览器自动给请求头添加了 <code>Origin</code> 字段，请求的服务端如果允许来自该 <code>Origin</code> 来源的请求，就会在响应头中添加 <code>Access-Control-Allow-Origin</code> 字段，参考上面请求的响应头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Access-Control-Allow-Origin:*</div><div class="line">Connection:keep-alive</div><div class="line">Content-Encoding:gzip</div><div class="line">Content-Length:231</div><div class="line">Content-Type:application/json; charset=utf-8</div><div class="line">Server:nginx/1.8.1</div><div class="line">X-Content-Type-Options:nosniff</div></pre></td></tr></table></figure>
<p><code>Access-Control-Allow-Origin</code> 字段表明服务器接受来自任何请求源的跨域请求。因此，通过客户端的 <code>Origin</code> 和 服务端的 <code>Access-Control-Allow-Origin</code> 实现了跨域的 XMLHttpRequest 请求。</p>
<p>MDN 对非简单请求的定义条件为</p>
<ul>
<li>以 GET、HEAD、或者 POST 以外的方法发起，或者是请求数据为 application/x-www-form-urlencoded, multipart/form-data 或者 text/plain 以外的数据类型；</li>
<li>使用自定义请求头（比如添加诸如 X-PINGOTHER）</li>
</ul>
<p>非简单请求会先向服务器发送一个 <code>OPTIONS</code> 的“预请求”（preflight），来确认该跨域请求是否能被服务端允许，如果允许，则继续发送费简单请求，否则，XMLHttpRequest 的 onerror 回调函数会捕获到错误信息。</p>
<p>编写一个非简单请求：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> url = <span class="string">'http://aruner.net/resources/access-control-with-post-preflight/'</span>;</div><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">xhr.open(<span class="string">'POST'</span>, url, <span class="literal">true</span>);</div><div class="line">xhr.setRequestHeader(<span class="string">'X-PINGOTHER'</span>, <span class="string">'pingpong'</span>);</div><div class="line">xhr.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/xml'</span>);</div><div class="line">xhr.send();</div></pre></td></tr></table></figure>
<p>预请求的请求头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">OPTIONS /resources/post-here/ HTTP/1.1</div><div class="line">Host: bar.com</div><div class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</div><div class="line">Connection: keep-alive</div><div class="line">Origin: http://foo.example</div><div class="line">Access-Control-Request-Method: POST</div><div class="line">Access-Control-Request-Headers: X-PINGOTHER</div></pre></td></tr></table></figure>
<p>预请求由 <code>OPTIONS</code> 请求发出，<code>Access-Control-Request-Method</code> 字段标识跨域请求的方式，<code>Access-Control-Request-Headers</code> 字段标识跨域请求的自定义请求头名称，再加上 <code>Origin</code> 字段，服务端就能判断还没正式发过来的跨域请求是否是安全可允许的。</p>
<p>如果服务端允许该跨域请求，其响应头类似如下形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Date: Mon, 01 Dec 2008 01:15:39 GMT</div><div class="line">Server: Apache/2.0.61 (Unix)</div><div class="line">Access-Control-Allow-Origin: http://foo.com</div><div class="line">Access-Control-Allow-Methods: POST, GET, OPTIONS</div><div class="line">Access-Control-Allow-Headers: X-PINGOTHER</div><div class="line">Access-Control-Max-Age: 1728000</div><div class="line">Vary: Accept-Encoding, Origin</div><div class="line">Content-Encoding: gzip</div><div class="line">Content-Length: 0</div><div class="line">Keep-Alive: timeout=2, max=100</div><div class="line">Connection: Keep-Alive</div><div class="line">Content-Type: text/plain</div></pre></td></tr></table></figure>
<p>其中，响应头中的 <code>Access-Control-*</code> 字段的具体含义如下：</p>
<ul>
<li><code>Access-Control-Allow-Origin</code> 标识可接受的跨域请求源；</li>
<li><code>Access-Control-Allow-Methods</code> 标识可接受的跨域请求方法；</li>
<li><code>Access-Control-Allow-Headers</code> 标识可接受的跨域请求自定义头；</li>
<li><code>Access-Control-Max-Age</code> 标识本次预请求的有效时间（秒），期间内无需再发送预请求；</li>
</ul>
<p>如果拒绝该跨域请求，错误信息也会被 <code>onerror</code> 回调捕获。</p>
<p>XMLHttpRequest 请求可以发送凭证请求（HTTP Cookies 和验证信息），通常不会跨域发送凭证信息，但也有一些情况需要打通不同的登录态，可以把 XMLHttpRequest 的 <code>withCredentials</code> 设置为 <code>true</code>，这样浏览器就能跨域发送凭证信息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">xhr.withCredentials = <span class="literal">true</span>;</div></pre></td></tr></table></figure>
<p>服务端返回的响应头中的 <code>Access-Control-Allow-Credentials</code> 字段存在且为 <code>true</code> 时，浏览器才会将响应结果传递给客户端程序。另外，<code>Access-Control-Allow-Origin</code> 必须指定请求源的域名，否则响应失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Access-Control-Allow-Origin: http://foo.com</div><div class="line">Access-Control-Allow-Credentials: true</div><div class="line">Set-Cookie: pageAccess=3; expires=Wed, 31-Dec-2008 01:34:53 GMT</div><div class="line">Keep-Alive: timeout=2, max=100</div><div class="line">Connection: Keep-Alive</div><div class="line">Content-Type: text/plain</div></pre></td></tr></table></figure>
<hr>
<p>参考：</p>
<ul>
<li>Mozilla Developer Network</li>
<li>阮一峰的网络日志</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Web 开发中，跨域请求是个经常碰到的问题，因为涉及到网站安全，所以浏览器是拒绝跨域请求的。通常解决跨域会采用 &lt;a href=&quot;https://en.wikipedia.org/wiki/JSONP&quot;&gt;JSONP&lt;/a&gt;(JSON with Padding) 和 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS&quot;&gt;CORS&lt;/a&gt;(Cross-Origin Resource Sharing)。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Frontend" scheme="https://isudox.com/tags/Frontend/"/>
    
      <category term="JavaScript" scheme="https://isudox.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Java 常用容器小结</title>
    <link href="https://isudox.com/2016/09/13/java-collections-overview/"/>
    <id>https://isudox.com/2016/09/13/java-collections-overview/</id>
    <published>2016-09-13T12:15:58.000Z</published>
    <updated>2017-04-13T03:12:49.089Z</updated>
    
    <content type="html"><![CDATA[<p>无论是什么编程语言，容器都是非常重要的概念，在 Java 的实际开发中更是无处不在，各种 List、Set、Map。很多时候就是随着编程的惯性用了 ArrayList 或者 HashMap，但是并没对其特性和适用场景作更多的思考。开发者对 Java 容器的讨论比较多，我自己从源码的角度做个粗浅的整理。</p>
<a id="more"></a>
<h2 id="Collection"><a href="#Collection" class="headerlink" title="Collection"></a>Collection</h2><p>java.util 包中的基于 Collection 接口的有 List、Set 和 Queue，下面这张图清楚的显示了 Collection 接口的向下实现和继承关系。</p>
<p><img src="https://o70e8d1kb.qnssl.com/java-collection-hierarchy.png" alt=""></p>
<p>Collection 接口继承了 Iterable 接口，表明所有 Collection 的实现都是可迭代的。Collection 提供最基础的接口方法，如 <code>add()</code>、<code>remove()</code>、<code>contains()</code>、<code>isEmpty()</code>、<code>hashCode()</code> 等。</p>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><blockquote>
<p>An ordered collection (also known as a sequence). The user of this interface has precise control over where in the list each element is inserted. The user can access elements by their integer index (position in the list), and search for elements in the list.</p>
</blockquote>
<p>上面是 Java SE Docs 里对 List 的定义。也就是说，List 是一个有序的 Collection，即队列，List 的使用者通过 List 内元素所在的 index 访问元素，且不限制重复元素。</p>
<h4 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h4><blockquote>
<p>Resizable-array implementation of the List interface. Implements all optional list operations, and permits all elements, including null. In addition to implementing the List interface, this class provides methods to manipulate the size of the array that is used internally to store the list. (This class is roughly equivalent to Vector, except that it is unsynchronized.)</p>
</blockquote>
<p>ArrayList 是 List 里使用度非常高的一个实现。Doc 里有这么几个关键的说明：可动态扩容，允许插入 <code>null</code>，非同步。</p>
<p>ArrayList 实例有一个容量（capacity），就是它所能存储的元素数量，默认是 10。当元素不断被添加进 ArrayList 后，它的 size 域接近 capacity 时，capacity 会自动增加。</p>
<p>先来了解 ArrayList 的自动扩容机制。自动扩容是在执行 <code>add</code> 或 <code>addAll</code> 方法是触发的，这两个方法里会调用 <code>ensureCapacityInternal()</code> 方法来增大 capacity，看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></div><div class="line">    elementData[size++] = e;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</div><div class="line">        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ensureExplicitCapacity(minCapacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    modCount++;</div><div class="line"></div><div class="line">    <span class="comment">// overflow-conscious code</span></div><div class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</div><div class="line">        grow(minCapacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    <span class="comment">// overflow-conscious code</span></div><div class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</div><div class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</div><div class="line">        newCapacity = minCapacity;</div><div class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</div><div class="line">        newCapacity = hugeCapacity(minCapacity);</div><div class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></div><div class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只有当新增元素后的 size 超过当前的容量时，才会触发扩容。扩容的操作由 <code>grow()</code> 通过 <code>Arrays.copyOf()</code> 完成。自动扩容省去了程序员操心 ArrayList 溢出问题，但也带来一个弊端，就是当需要添加大量元素，会频繁触发自动扩容，JDK 提供了 <code>ensureCapacity()</code> 方法手动的预先设置 capacity 去避免这种情况。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ensureCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> minExpand = (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA)</div><div class="line">        <span class="comment">// any size if not default element table</span></div><div class="line">        ? <span class="number">0</span></div><div class="line">        <span class="comment">// larger than default for default empty table. It's already</span></div><div class="line">        <span class="comment">// supposed to be at default size.</span></div><div class="line">        : DEFAULT_CAPACITY;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (minCapacity &gt; minExpand) &#123;</div><div class="line">        ensureExplicitCapacity(minCapacity);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h4><blockquote>
<p>The Vector class implements a growable array of objects. Like an array, it contains components that can be accessed using an integer index. However, the size of a Vector can grow or shrink as needed to accommodate adding and removing items after the Vector has been created.</p>
</blockquote>
<p>Vector 和 ArrayList 很类似，不同之处在于，Vector 是同步的，线程安全，自动扩容时，容量是增大 100%（ArrayList 是增大 50%）。</p>
<h4 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h4><blockquote>
<p>Doubly-linked list implementation of the List and Deque interfaces. Implements all optional list operations, and permits all elements (including null).</p>
</blockquote>
<p>LinkedList 是一个双向链表实现，对 LinkedList 内元素的索引都需要从它的头部或尾部遍历。因此 LinkedList 不能像 ArrayList 和 Vector 那样根据元素索引位置进行随机访问，只能通过 LinkedList 里逐个 Node 依次向下（上）迭代进行查找，访问效率相比会差一点。</p>
<p>LinkedList 内元素是以 <code>Node&lt;E&gt;</code> 结构存储，Node 包含真实的存储元素 item，前一 Node 的引用 prev，后一 Node 的引用 next：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    E item;</div><div class="line">    Node&lt;E&gt; next;</div><div class="line">    Node&lt;E&gt; prev;</div><div class="line"></div><div class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</div><div class="line">        <span class="keyword">this</span>.item = element;</div><div class="line">        <span class="keyword">this</span>.next = next;</div><div class="line">        <span class="keyword">this</span>.prev = prev;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>双向链表的结构使得数据的插入删除变得非常简单高效：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</div><div class="line">    checkPositionIndex(index);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (index == size)</div><div class="line">        linkLast(element);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        linkBefore(element, node(index));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkBefore</span><span class="params">(E e, Node&lt;E&gt; succ)</span> </span>&#123;</div><div class="line">    <span class="comment">// assert succ != null;</span></div><div class="line">    <span class="keyword">final</span> Node&lt;E&gt; pred = succ.prev;</div><div class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(pred, e, succ);</div><div class="line">    succ.prev = newNode;</div><div class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</div><div class="line">        first = newNode;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        pred.next = newNode;</div><div class="line">    size++;</div><div class="line">    modCount++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>插入时，只需要将新元素的 Node 插在 prev 和 next Node之间，并重新建立前后连接关系。同理，删除操作也是。</p>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><blockquote>
<p>A collection that contains no duplicate elements. More formally, sets contain no pair of elements e1 and e2 such that e1.equals(e2), and at most one null element. As implied by its name, this interface models the mathematical set abstraction.</p>
</blockquote>
<p>Set 是不存在重复元素的集合类型。对于重复的定义就是，当 <code>e1.equals(e2)</code> 时，就意味着重复。Set 支持 <code>null</code>，最多也只能存在一个。</p>
<h4 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h4><blockquote>
<p>This class implements the Set interface, backed by a hash table (actually a HashMap instance). It makes no guarantees as to the iteration order of the set; in particular, it does not guarantee that the order will remain constant over time. This class permits the null element.</p>
</blockquote>
<p>凡是和 Hash 相关的都是查询效率很高的集合类型，HashSet 也是。HashSet 内部持有一个 HashMap 域来作为元素的实际存储，也就是说，HashSet 根据元素的 HashCode 来确定顺序，因此 HashSet 无法保证元素的存储顺序和插入顺序一致，甚至都不能保证顺序一直保持不变。参考 OpenJDK 里的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashSet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Set</span>&lt;<span class="title">E</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E, Object&gt; map;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.isEmpty();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.put(var1, PRESENT) == <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.remove(var1) == PRESENT;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.map.clear();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="LinkedHashSet"><a href="#LinkedHashSet" class="headerlink" title="LinkedHashSet"></a>LinkedHashSet</h4><blockquote>
<p>Hash table and linked list implementation of the Set interface, with predictable iteration order.</p>
</blockquote>
<p>LinkedHashSet 继承了 HashSet，不同的是，LinkedHashSet 内部持有一个双向链表，这个链表决定了其元素遍历的顺序，即元素插入的顺序。因此 LinkedHashSet 是有序的集合。</p>
<h4 id="TreeSet"><a href="#TreeSet" class="headerlink" title="TreeSet"></a>TreeSet</h4><blockquote>
<p>A NavigableSet implementation based on a TreeMap. The elements are ordered using their natural ordering, or by a Comparator provided at set creation time, depending on which constructor is used.</p>
</blockquote>
<p>TreeSet 继承 SortedSet（直接父类是 NavigableSet），是有序的集合。元素顺序可以保持自然排序，或者根据提供的比较器 Comparator 排序，因此 TreeSet 中任意两个元素的值都不同。TreeSet 的元素存储在 NavigableMap 中（父类是 SortedMap）。</p>
<p>TreeSet 是非同步的，如果多线程并行访问 TreeSet，且至少有一个线程会修改它，就必须在外部进行同步。典型的办法是采用包装器去把非同步的对象装饰成同步的对象（Java 并发编程实战里讲得很详细），Collections 包提供了这样的方法：<br><code>SortedSet set = Collections.synchronizedSortedSet(new TreeSet(...));</code></p>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p><img src="https://o70e8d1kb.qnssl.com/java-map-hierarchy.png" alt=""></p>
<p>Map 存储的元素是 K-V 键值对，Map 的具体实现通常是由 key 映射到 value，而 Apache Commons 包的 BidiMap 集合，实现了 value 到 key 的反向映射，参考 <a href="http://stackoverflow.com/questions/1383797/java-hashmap-how-to-get-key-from-value" target="_blank" rel="external">StackOverflow</a>。</p>
<h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h3><blockquote>
<p>This implementation provides all of the optional map operations, and permits null values and the null key. (The HashMap class is roughly equivalent to Hashtable, except that it is unsynchronized and permits nulls.) This class makes no guarantees as to the order of the map; in particular, it does not guarantee that the order will remain constant over time.</p>
</blockquote>
<p>之前的<a href="/2016/08/08/how-hashmap-works-in-jdk8/">博客</a>对 JDK8 里的 HashMap 做了简单的介绍。HashMap 的 key 和 value 允许 null，且它是非同步的，这个 Hashtable 有别（HashMap 继承了 AbstractMap，Hashtable 继承了 Dictionary，两者都实现了 Map 接口）。HashMap 是无序的，因为它的元素通过 key 的哈希值决定其在 hash bucket 中的存储位置。</p>
<h3 id="Hashtable"><a href="#Hashtable" class="headerlink" title="Hashtable"></a>Hashtable</h3><p>Hashtable 和 HashMap 类似，但它是同步的，且不支持 null。在单线程环境下，Hashtable 的性能要稍差于 HashMap。</p>
<h3 id="TreeMap"><a href="#TreeMap" class="headerlink" title="TreeMap"></a>TreeMap</h3><blockquote>
<p>A Red-Black tree based NavigableMap implementation. The map is sorted according to the natural ordering of its keys, or by a Comparator provided at map creation time, depending on which constructor is used.</p>
</blockquote>
<p>TreeMap 是基于红黑树的 NavigableMap（父类 SortedMap）实现，是有序集合，以元素 key 的自然顺序或者比较器作为排序依据。它和 TreeSet 除了元素结构的差异，在行为表现上很相似。</p>
<h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>搬运前人总结的表格，总览几个常用集合的特点：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Collection class</th>
<th style="text-align:center">Base class</th>
<th style="text-align:center">Base interfaces</th>
<th style="text-align:center">Duplicate elements?</th>
<th style="text-align:center">Ordered?</th>
<th style="text-align:center">Sorted?</th>
<th style="text-align:center">Thread-safe?</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ArrayList<e></e></td>
<td style="text-align:center">AbstractList<e></e></td>
<td style="text-align:center">List<e></e></td>
<td style="text-align:center">Y</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">LinkedList<e></e></td>
<td style="text-align:center">AbstractSequentialList<e></e></td>
<td style="text-align:center">List<e>; Deque<e></e></e></td>
<td style="text-align:center">Y</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">Vector<e></e></td>
<td style="text-align:center">AbstractList<e></e></td>
<td style="text-align:center">List<e></e></td>
<td style="text-align:center">Y</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">N</td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">HashSet<e></e></td>
<td style="text-align:center">AbstractSet<e></e></td>
<td style="text-align:center">Set<e></e></td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">LinkedHashSet<e></e></td>
<td style="text-align:center">HashSet<e></e></td>
<td style="text-align:center">Set<e></e></td>
<td style="text-align:center">N</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">TreeSet<e></e></td>
<td style="text-align:center">AbstractSet<e></e></td>
<td style="text-align:center">NavigableSet<e></e></td>
<td style="text-align:center">N</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">HashMap<k, v=""></k,></td>
<td style="text-align:center">AbstractMap<k, v=""></k,></td>
<td style="text-align:center">Map<k, v=""></k,></td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">LinkedHashMap<k, v=""></k,></td>
<td style="text-align:center">HashMap<k, v=""></k,></td>
<td style="text-align:center">Map<k, v=""></k,></td>
<td style="text-align:center">N</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">Hashtable<k, v=""></k,></td>
<td style="text-align:center">Dictionary<k, v=""></k,></td>
<td style="text-align:center">Map<k, v=""></k,></td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
<td style="text-align:center">N</td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">TreeMap<k, v=""></k,></td>
<td style="text-align:center">AbstractMap<k, v=""></k,></td>
<td style="text-align:center">NavigableMap<k, v=""></k,></td>
<td style="text-align:center">N</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">Y</td>
<td style="text-align:center">N</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;无论是什么编程语言，容器都是非常重要的概念，在 Java 的实际开发中更是无处不在，各种 List、Set、Map。很多时候就是随着编程的惯性用了 ArrayList 或者 HashMap，但是并没对其特性和适用场景作更多的思考。开发者对 Java 容器的讨论比较多，我自己从源码的角度做个粗浅的整理。&lt;/p&gt;
    
    </summary>
    
      <category term="Coding" scheme="https://isudox.com/categories/Coding/"/>
    
    
      <category term="Java" scheme="https://isudox.com/tags/Java/"/>
    
  </entry>
  
</feed>
